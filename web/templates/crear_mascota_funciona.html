<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crear Mascota</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .header-bar { position: relative; display: block; margin-bottom: 6px; }
        .header-bar h1 { text-align: center; margin: 8px 0 4px 0; line-height: 1.2; }
        .btn-volver {
            position: absolute; right: 0; top: 50%; transform: translateY(-50%);
            background-color: #555; color: white; padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer;
        }
        .btn-volver:hover { background-color: #333; }

        .flash-container { max-width: 900px; margin: 0 auto 8px auto; }
        .flash { padding: 8px 12px; border-radius: 6px; margin: 6px auto; font-weight: 600; max-width: 900px; }
        .flash.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .flash.error   { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

        .row-compact { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
        .row-compact input, .row-compact select, .row-compact textarea { flex: 1 1 200px; min-width: 170px; padding: 8px; }
        textarea { min-height: 80px; }

        .row-identificacion { align-items: stretch; }
        .row-identificacion > * { display:flex; }
        .row-identificacion .campo-nombre { flex: 1 1 180px; min-width: 150px; }
        .row-identificacion .campo-nombre input { flex: 1 1 auto; }
        .row-identificacion .campo-zona { flex: 2 1 320px; min-width: 220px; }
        .row-identificacion .campo-zona input { flex:1 1 auto; width:100%; }
        .row-identificacion .campo-fecha-registro {
            flex: 0 0 130px; max-width: 130px;
            align-items: center; gap: 4px;
        }
        .row-identificacion .campo-fecha-registro .input-fecha-registro {
            flex: 1 1 auto;
            min-width: 94px;
            text-align: center;
            font-size: 0.95rem;
            padding: 8px;
        }
        .row-identificacion .campo-fecha-registro .btn-date {
            min-width: 32px;
            padding: 8px;
            background:#eee;
            border:1px solid #ccc;
            border-radius:6px;
            cursor:pointer;
        }
        .row-identificacion .campo-fecha-registro .btn-date:hover { background:#ddd; }
        #fecha_registro_picker {
            position: absolute; width:0; height:0; opacity:0; border:0; padding:0; pointer-events:none;
        }

        .foto-uploader { border:1px solid #ccc; border-radius:10px; padding:10px; margin-top:10px; background:#f9f9f9; }
        .foto-uploader h3 { margin: 4px 0 8px 0; font-size:1.05rem; }
        .inline-group { display:flex; align-items:center; gap:6px; flex-wrap:nowrap; }
        .inline-group select { flex: 0 0 220px; }
        .inline-group input[type="file"] { flex: 1 1 auto; min-width: 220px; }
        .add-foto-row { margin-top: 6px; }
        .btn-add-foto { background:#4CAF50; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
        .btn-add-foto:hover { background:#45a049; }
        .foto-lista { margin-top:8px; padding-left:0; }
        .foto-item { list-style:none; background:#eef; margin-bottom:6px; padding:6px 10px; border-radius:6px; }

        #btn-crear { margin-top: 10px; }
        body, input, select, button, textarea { line-height: 1.25; }
    </style>
</head>
<body data-tipo_registro="{{ (request.args.get('tipo_registro') or 'desaparecida')|lower }}">
<div class="container">
    <header class="header-bar">
        <h1>
            Crear nueva mascota
            {{ 'encontrada' if (request.args.get('tipo_registro') or '')|lower == 'encontrada' else 'desaparecida' }}
        </h1>
        <a class="btn-volver" href="{{ url_for('main.index') }}">‚¨Ö Volver al inicio</a>
    </header>

    <div class="flash-container">
        {% with msgs = get_flashed_messages(with_categories=True) %}
            {% if msgs %}
                {% for cat, msg in msgs %}
                    <div class="flash {{ cat }}">{{ msg }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <main>
        <form id="form-crear" action="{{ url_for('main.crear_mascota', tipo_registro=request.args.get('tipo_registro')) }}" method="POST" enctype="multipart/form-data">
            <!-- Fila 1: email y tel√©fono -->
            <div class="row-compact">
                {% if (request.args.get('tipo_registro') or '')|lower == 'encontrada' %}
                    <input type="email" name="propietario_email" placeholder="Email persona que lo encontr√≥">
                    <input type="tel"   name="propietario_telefono" placeholder="Tel√©fono persona que lo encontr√≥">
                {% else %}
                    <input type="email" name="propietario_email" placeholder="Email propietario" required>
                    <input type="tel"   name="propietario_telefono" placeholder="Tel√©fono propietario" required>
                {% endif %}
            </div>

            <!-- Fila 2: nombre + zona + fecha-registro compacta -->
            <div class="row-compact row-identificacion">
                <div class="campo-nombre">
                    {% if (request.args.get('tipo_registro') or '')|lower == 'encontrada' %}
                        <input type="text" id="nombre" name="nombre_ui" value="encontrada"
                               placeholder="Nombre mascota" maxlength="20" disabled>
                        <input type="hidden" name="nombre" value="encontrada">
                    {% else %}
                        <input type="text" id="nombre" name="nombre" placeholder="Nombre mascota"
                               maxlength="20" required>
                    {% endif %}
                </div>

                <div class="campo-zona">
                    {% if (request.args.get('tipo_registro') or '')|lower == 'encontrada' %}
                        <input type="text" name="zona" placeholder="Zona encontrada mascota" required>
                    {% else %}
                        <input type="text" name="zona" placeholder="Zona desaparici√≥n de mascota" required>
                    {% endif %}
                </div>

                <div class="campo-fecha-registro">
                    <input type="text" id="fecha_registro" name="fecha_registro"
                           class="input-fecha-registro"
                           placeholder="dd/mm/aaaa"
                           maxlength="10"
                           pattern="\d{2}/\d{2}/\d{4}"
                           inputmode="numeric"
                           autocomplete="off"
                           required>
                    <button type="button" class="btn-date" id="btn_fecha_registro_picker" title="Seleccionar con calendario">
                        <span aria-hidden="true">üìÖ</span>
                    </button>
                    <input type="date" id="fecha_registro_picker" aria-hidden="true" tabindex="-1">
                </div>
            </div>

            <div class="row-compact">
                <input type="text" id="especie" name="especie" placeholder="Especie" required>
                <input type="text" id="raza"    name="raza"    placeholder="Raza">
                <input type="number" id="edad"  name="edad"    placeholder="Edad" min="0">
            </div>

            <div class="row-compact">
                <input type="text" name="color" placeholder="Color (obligatorio)" required>
                <select name="sexo" required>
                    <option value="" disabled selected>Sexo</option>
                    <option value="macho">macho</option>
                    <option value="hembra">hembra</option>
                    <option value="no_sabe">no sabe</option>
                </select>
                <input type="text" name="chip" placeholder="Chip (opcional)">
            </div>

            <div class="row-compact">
                <input type="number" name="peso" placeholder="Peso (kg)" step="0.1" min="0">
                <select name="tamano" required>
                    <option value="" disabled selected>Tama√±o (obligatorio)</option>
                    <option value="peque√±o">peque√±o</option>
                    <option value="mediano">mediano</option>
                    <option value="grande">grande</option>
                </select>
            </div>

            <div class="row-compact">
                <textarea name="descripcion" placeholder="Descripci√≥n (opcional)"></textarea>
            </div>

            <div class="foto-uploader">
                <h3>Subir fotograf√≠as (opcional)</h3>
                <div class="inline-group">
                    <select id="tipo_foto_visible">
                        <option value="" disabled selected>Seleccionar tipo de foto</option>
                        <option value="cara">Cara</option>
                        <option value="frontal">Frontal</option>
                        <option value="lateral_izquierdo">Lateral Izquierdo</option>
                        <option value="lateral_derecho">Lateral Derecho</option>
                        <option value="trasero">Trasero</option>
                    </select>
                    <input type="file" id="archivo_foto_visible" accept="image/*">
                </div>

                <div class="add-foto-row">
                    <button type="button" class="btn-add-foto" onclick="agregarFoto()">+ A√±adir foto</button>
                </div>

                <ul class="foto-lista" id="lista_fotos">
                    <li class="foto-item" id="sin_fotos"><i>No se han a√±adido fotos todav√≠a.</i></li>
                </ul>
            </div>

            <button id="btn-crear" type="submit">
                {{ 'Crear mascota encontrada' if (request.args.get('tipo_registro') or '')|lower == 'encontrada' else 'Crear mascota' }}
            </button>
        </form>
    </main>
</div>

<script>
    const fotosBuffer = [];

    // Fecha: input de texto + picker oculto
    const fechaInputRegistro  = document.getElementById("fecha_registro");
    const fechaPickerRegistro = document.getElementById("fecha_registro_picker");
    const btnfechaPickerRegistro = document.getElementById("btn_fecha_registro_picker");

    function displayToIso(display) {
        const match = display.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (!match) return "";
        const [, d, m, y] = match;
        return `${y}-${m}-${d}`;
    }
    function isoToDisplay(iso) {
        const [y, m, d] = iso.split("-");
        if (!y || !m || !d) return "";
        return `${d.padStart(2,"0")}/${m.padStart(2,"0")}/${y}`;
    }
    function abrirCalendario() {
        if (!fechaPickerRegistro) return;
        const iso = displayToIso(fechaInputRegistro.value.trim());
        fechaPickerRegistro.value = iso || "";
        if (fechaPickerRegistro.showPicker) fechaPickerRegistro.showPicker();
        else fechaPickerRegistro.focus();
    }
    if (btnfechaPickerRegistro) {
        btnfechaPickerRegistro.addEventListener("click", (e) => {
            e.preventDefault();
            abrirCalendario();
        });
    }
    if (fechaInputRegistro) {
        fechaInputRegistro.addEventListener("focus", () => fechaInputRegistro.select());
        fechaInputRegistro.addEventListener("keydown", (ev) => {
            if (ev.key === "ArrowDown") { ev.preventDefault(); abrirCalendario(); }
        });
        fechaInputRegistro.addEventListener("blur", () => {
            const val = fechaInputRegistro.value.trim();
            if (!val) return;
            const digits = val.replace(/\D/g, "");
            if (digits.length === 8) {
                const d = digits.slice(0,2), m = digits.slice(2,4), y = digits.slice(4);
                fechaInputRegistro.value = `${d}/${m}/${y}`;
            }
        });
    }
    if (fechaPickerRegistro) {
        fechaPickerRegistro.addEventListener("change", () => {
            if (!fechaPickerRegistro.value) return;
            const display = isoToDisplay(fechaPickerRegistro.value);
            if (display) {
                fechaInputRegistro.value = display;
                fechaInputRegistro.dispatchEvent(new Event("input"));
                fechaInputRegistro.focus();
            }
        });
    }

    // Fotos
    function agregarFoto() {
        const tipo_fotoSel = document.getElementById("tipo_foto_visible");
        const tipo_foto = tipo_fotoSel.value;
        const fileInput = document.getElementById("archivo_foto_visible");
        const file = fileInput.files[0];
        if (!tipo_foto) { alert("Selecciona un tipo de foto."); return; }
        if (!file) { alert("Selecciona un archivo de imagen."); return; }
        fotosBuffer.push({ tipo_foto, file });

        const lista = document.getElementById("lista_fotos");
        const sinFotos = document.getElementById("sin_fotos");
        if (sinFotos) sinFotos.remove();

        const item = document.createElement("li");
        item.className = "foto-item";
        item.textContent = `${tipo_foto} ‚Äî ${file.name}`;
        lista.appendChild(item);

        tipo_fotoSel.selectedIndex = 0;
        fileInput.value = "";
    }

    // Enviar
    document.getElementById("form-crear").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.currentTarget;
        const btn = document.getElementById("btn-crear");
        const originalText = btn.textContent;

        if (fechaInputRegistro) {
            const val = fechaInputRegistro.value.trim();
            const regex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!regex.test(val)) {
                fechaInputRegistro.setCustomValidity("Introduce la fecha en formato dd/mm/aaaa.");
                fechaInputRegistro.reportValidity();
                return;
            } else {
                fechaInputRegistro.setCustomValidity("");
            }
        }

        btn.disabled = true;
        btn.textContent = "Guardando...";

        const fd = new FormData(form);
        for (const { tipo_foto, file } of fotosBuffer) {
            fd.append("tipo_foto", tipo_foto);
            fd.append("fotos", file, file.name);
        }

        try {
            const resp = await fetch(form.action, { method: "POST", body: fd, redirect: "follow" });
            if (resp.redirected) { window.location.href = resp.url; return; }

            const ct = resp.headers.get("content-type") || "";
            const text = await resp.text();

            if (resp.ok && ct.includes("text/html")) {
                document.open(); document.write(text); document.close();
            } else if (!resp.ok) {
                console.error("Error HTTP:", resp.status, text);
                alert("No se pudo guardar la mascota. C√≥digo: " + resp.status);
            } else {
                window.location.href = "{{ url_for('main.index') }}";
            }
        } catch (err) {
            console.error(err);
            alert("No se pudo enviar el formulario. Revisa la consola.");
        } finally {
            if (!document.hidden) {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    });

    // Verificaci√≥n de duplicados
    const camposVerificar = ["nombre", "especie", "raza"];
    const nombreInput = document.getElementById("nombre");
    if (nombreInput) {
        camposVerificar.forEach(id => {
            const campo = document.getElementById(id);
            if (campo) campo.addEventListener("input", verificarDuplicado);
        });
    } else {
        ["especie","raza"].forEach(id => {
            const campo = document.getElementById(id);
            if (campo) campo.addEventListener("input", verificarDuplicado);
        });
    }

    async function verificarDuplicado() {
        const especie = (document.getElementById("especie").value || "").trim();
        const raza    = (document.getElementById("raza").value || "").trim();
        const nombre  = document.getElementById("nombre") ? (document.getElementById("nombre").value || "").trim() : "encontrada";

        const fd = new FormData();
        fd.append("nombre", nombre);
        fd.append("especie", especie);
        fd.append("raza", raza);

        const alertaId = "alerta-duplicado";
        let alerta = document.getElementById(alertaId);
        if (!alerta) {
            alerta = document.createElement('div');
            alerta.id = alertaId;
            alerta.style.color = "#c0392b";
            alerta.style.fontWeight = "bold";
            alerta.style.textAlign = "center";
            document.querySelector(".container").insertBefore(alerta, document.querySelector("main"));
        }

        if (!especie || !raza) {
            alerta.textContent = "";
            habilitarFormulario(true);
            return;
        }

        try {
            const url = "{{ url_for('main.verificar_mascota', tipo_registro=request.args.get('tipo_registro')) }}";
            const response = await fetch(url, { method: "POST", body: fd });
            const data = await response.json();
            if (data.existe) {
                alerta.textContent = "‚ö†Ô∏è Ya existe una mascota con el mismo nombre/especie/raza para este tipo_registro.";
                habilitarFormulario(false);
            } else {
                alerta.textContent = "";
                habilitarFormulario(true);
            }
        } catch (e) {
            console.error("Verificaci√≥n duplicados fall√≥:", e);
            habilitarFormulario(true);
        }
    }

    function habilitarFormulario(habilitar) {
        const inputs = document.querySelectorAll("#form-crear input, #form-crear select, #form-crear button, #form-crear textarea");
        inputs.forEach(el => {
            const id = el.getAttribute('id') || '';
            if (!["nombre", "especie", "raza"].includes(id)) el.disabled = !habilitar;
        });
    }
</script>
</body>
</html>