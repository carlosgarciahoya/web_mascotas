<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    {% set modo_actual = modo or 'buscar' %}
    <title>
        {% if modo_actual == 'identificar_raza' %}
            Seleccionar mascota desaparecida para identificar razas
        {% elif modo_actual in ['comparar_desaparecidas', 'comparar'] %}
            Seleccionar mascota desaparecida para comparar fotos
        {% elif modo_actual == 'modificar' %}
            Modificar o Eliminar Mascotas
        {% else %}
            Buscar Mascotas
        {% endif %}
    </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="container">
    <header class="header-bar">
        <h1>
            {% if modo_actual == 'identificar_raza' %}
                Seleccionar mascota desaparecida para identificar razas
            {% elif modo_actual in ['comparar_desaparecidas', 'comparar'] %}
                Seleccionar mascota desaparecida para comparar fotos
            {% elif modo_actual == 'modificar' %}
                Modificar o Eliminar Mascotas
            {% else %}
                Buscar Mascotas
            {% endif %}
        </h1>
        <a class="btn-volver" href="{{ url_for('main.index') }}">⬅ Volver al inicio</a>
    </header>

    {% set es_comparar = (modo_actual in ['comparar_desaparecidas', 'comparar']) %}
    {% set es_identificar = (modo_actual == 'identificar_raza') %}
    {% set requiere_desaparecida = es_comparar or es_identificar %}
    {% set es_modificar = (modo_actual in ['modificar', 'comparar_desaparecidas', 'comparar', 'identificar_raza']) %}

    <!-- Mensajes flash -->
    {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
            <div class="flash-container" style="max-width:960px;margin:12px auto;">
                {% for cat, msg in msgs %}
                    <div class="flash {{ cat }}">{{ msg }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% set tipo_pref = (request.form.get('tipo_registro') or (request.args.get('tipo_registro') or 'todas')).lower() %}
    {% if requiere_desaparecida %}
        {% set tipo_pref = 'desaparecida' %}
    {% endif %}
    <form method="POST" style="text-align:center;">
        {% if es_identificar %}
            <input type="hidden" name="modo" value="identificar_raza">
        {% endif %}

        <!-- Primera línea de filtros -->
        <div class="form-row">
            <select name="tipo_registro" required {% if requiere_desaparecida %}disabled{% endif %}>
                <option value="" disabled {% if tipo_pref not in ['desaparecida','encontrada','todas'] %}selected{% endif %}>Tipo de registro</option>
                <option value="desaparecida" {% if tipo_pref == 'desaparecida' %}selected{% endif %}>desaparecida</option>
                <option value="encontrada" {% if tipo_pref == 'encontrada' %}selected{% endif %}>encontrada</option>
                <option value="todas" {% if tipo_pref == 'todas' %}selected{% endif %}>todas</option>
            </select>
            {% if requiere_desaparecida %}
                <input type="hidden" name="tipo_registro" value="desaparecida">
            {% endif %}

            <input type="text" name="nombre" placeholder="Nombre mascota" value="{{ request.form.get('nombre','') }}">
            <input type="text" name="especie" placeholder="Especie" value="{{ request.form.get('especie','') }}">
            <input type="text" name="raza" placeholder="Raza" value="{{ request.form.get('raza','') }}">
            <input type="text" name="color" placeholder="Color" value="{{ request.form.get('color','') }}">

            <select name="tamano">
                <option value="" {% if not request.form.get('tamano') %}selected{% endif %}>Tamaño</option>
                <option value="pequeño" {% if request.form.get('tamano')=='pequeño' %}selected{% endif %}>pequeño</option>
                <option value="mediano" {% if request.form.get('tamano')=='mediano' %}selected{% endif %}>mediano</option>
                <option value="grande" {% if request.form.get('tamano')=='grande' %}selected{% endif %}>grande</option>
            </select>

            <input type="number" name="peso" placeholder="Peso (kg)" step="0.1" min="0" value="{{ request.form.get('peso','') }}">
           
        </div>

        <!-- Segunda línea de filtros -->
        <div class="form-row">

            <select name="sexo">
                <option value="" {% if not request.form.get('sexo') %}selected{% endif %}>Sexo</option>
                <option value="macho" {% if request.form.get('sexo')=='macho' %}selected{% endif %}>macho</option>
                <option value="hembra" {% if request.form.get('sexo')=='hembra' %}selected{% endif %}>hembra</option>
                <option value="no_sabe" {% if request.form.get('sexo')=='no_sabe' %}selected{% endif %}>no sabe</option>
            </select>

            <input type="number" name="edad" placeholder="Edad" min="0" value="{{ request.form.get('edad','') }}">
            <input type="text"
                   name="codigo_postal"
                   placeholder="C. Postal"
                   maxlength="5"
                   pattern="\d{5}"
                   inputmode="numeric"
                   value="{{ request.form.get('codigo_postal','') }}">

            <input type="text" name="zona" placeholder="Localidad" value="{{ request.form.get('zona','') }}">

            <input type="text"
                   name="descripcion"
                   placeholder="Descripción"
                   value="{{ request.form.get('descripcion','') }}"
                   style="flex: 2 1 280px; min-width: 240px;">

            <input type="text" name="chip" placeholder="Chip" value="{{ request.form.get('chip','') }}">
        </div>

        <!-- Tercera línea de filtros -->
        <div class="form-row">
            <input type="email" name="propietario_email" placeholder="Email Propietario" maxlength="40" value="{{ request.form.get('propietario_email','') }}">
            <input type="text" name="propietario_telefono" placeholder="Teléfono" value="{{ request.form.get('propietario_telefono','') }}">

            <input type="text"
                   name="fecha_registro"
                   placeholder="Fecha desparecida/encontrada"
                   value="{{ '' if requiere_desaparecida else request.form.get('fecha_registro','') }}"
                   style="flex: 2 1 280px; min-width: 240px;"
                   {% if requiere_desaparecida %}disabled{% endif %}>
            {% if requiere_desaparecida %}
                <input type="hidden" name="fecha_registro" value="">
            {% endif %}

            <input type="text"
                   name="fecha_aparecida"
                   placeholder="Fecha si ha aparecido"
                   value="{{ '' if requiere_desaparecida else request.form.get('fecha_aparecida','') }}"
                   {% if requiere_desaparecida %}disabled{% endif %}>
            {% if requiere_desaparecida %}
                <input type="hidden" name="fecha_aparecida" value="">
            {% endif %}

            <select name="estado_aparecida" {% if requiere_desaparecida %}disabled{% endif %}>
                <option value="" {% if requiere_desaparecida or not request.form.get('estado_aparecida') %}selected{% endif %}>Estado aparecida</option>
                <option value="viva" {% if not requiere_desaparecida and request.form.get('estado_aparecida')=='viva' %}selected{% endif %}>viva</option>
                <option value="muerta" {% if not requiere_desaparecida and request.form.get('estado_aparecida')=='muerta' %}selected{% endif %}>muerta</option>
            </select>
            {% if requiere_desaparecida %}
                <input type="hidden" name="estado_aparecida" value="">
            {% endif %}

            <button type="submit" class="btn-buscar">{{ 'BUSCAR' if es_modificar else 'VALIDAR' }}</button>
        </div>
    </form>

    {% if not busqueda_realizada %}
        <div class="hint">
            {% if es_identificar %}
                Selecciona los filtros necesarios y pulsa “BUSCAR” para localizar la mascota desaparecida cuyas fotos usarás para identificar la raza.
            {% elif es_modificar %}
                Selecciona los filtros necesarios y pulsa “BUSCAR” para localizar la mascota que quieras modificar o eliminar.
            {% else %}
                Selecciona el tipo (desaparecida, encontrada o todas), añade los filtros que quieras y pulsa “VALIDAR”.
            {% endif %}
        </div>
    {% else %}
        {% if mensaje %}
            <div class="mensaje">{{ mensaje }}</div>
        {% elif mascotas_con_fotos %}
            <div style="margin-top:20px;">
                {% for mascota, fotos in mascotas_con_fotos %}
                <div class="mascota-card">
                    <div class="mascota-info mascota-info-grid">
                        <div class="info-col col-identidad">
                            <span><b>Tipo registro:</b> {{ mascota.tipo_registro }}</span>
                            <span><b>Nombre mascota:</b> {{ mascota.nombre }}</span>
                            <span><b>Especie:</b> {{ mascota.especie }}</span>
                            <span><b>Raza:</b> {{ mascota.raza }}</span>
                            <span><b>Código postal:</b> {{ mascota.codigo_postal or '—' }}</span>
                            <span><b>Localidad:</b> {{ mascota.zona or '—' }}</span>
                            <span><b>Color:</b> {{ mascota.color }}</span>
                            <span><b>Tamaño:</b> {{ mascota.tamano or '—' }}</span>
                        </div>

                        <div class="info-col col-detalles">
                            <span><b>Descripción:</b> {{ mascota.descripcion or '—' }}</span>
                            <span><b>Sexo:</b> {{ mascota.sexo }}</span>
                            <span><b>Chip:</b> {{ mascota.chip or '—' }}</span>
                            <span><b>Peso (kg):</b> {{ (mascota.peso|string ~ ' kg') if mascota.peso is not none else '—' }}</span>
                            <span><b>Edad:</b> {{ mascota.edad if mascota.edad is not none else '—' }}</span>
                        </div>

                        <div class="info-col col-contacto">
                            <span><b>Email propietario:</b> {{ mascota.propietario_email or '—' }}</span>
                            <span><b>Teléfono:</b> {{ mascota.propietario_telefono or '—' }}</span>
                            <span><b>Fecha registrada:</b> {{ mascota.fecha_registro.strftime('%d/%m/%Y') if mascota.fecha_registro else '—' }}</span>
                            <span><b>Fecha aparecida:</b> {{ mascota.fecha_aparecida.strftime('%d/%m/%Y') if mascota.fecha_aparecida else '—' }}</span>
                            <span><b>Estado aparecida:</b> {{ mascota.estado_aparecida or '—' }}</span>
                        </div>
                    </div>

                    {% if fotos %}
                        <div class="foto-info">
                            <b>Fotos registradas:</b>
                            <div class="foto-thumbs">
                                {% for foto in fotos %}
                                    <div class="thumb">
                                        <img class="js-lb" src="/{{ foto.ruta }}" alt="{{ foto.tipo_foto }}" data-cap="{{ mascota.nombre }} — {{ foto.tipo_foto }}">
                                        <div class="cap">{{ foto.tipo_foto }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="foto-info"><i>Sin fotos registradas.</i></div>
                    {% endif %}

                    {% if modo_actual == 'modificar' %}
                        <div class="card-actions">
                            <form method="GET" action="{{ url_for('main.crear_mascota', mascota_id=mascota.id) }}">
                                <button type="submit" class="btn-accion btn-accion-primario">Modificar</button>
                            </form>
                            <form method="POST"
                                  action="{{ url_for('main.eliminar_mascota', mascota_id=mascota.id) }}"
                                  onsubmit="return confirm('¿Seguro que deseas eliminar este registro?');">
                                <button type="submit" class="btn-accion btn-accion-peligro">Eliminar</button>
                            </form>
                        </div>
                    {% elif es_comparar %}
                        <div class="card-actions">
                            {% if fotos %}
                                <form method="GET" action="{{ url_for('main.comparar_mascotas_candidatas', desaparecida_id=mascota.id) }}">
                                    <button type="submit" class="btn-accion btn-accion-primario btn-comparar">
                                        Comparar fotos
                                    </button>
                                </form>
                            {% else %}
                                <button type="button"
                                        class="btn-accion btn-accion-primario btn-comparar-sin-fotos"
                                        onclick="alert('Para comparar fotos, solo se pueden seleccionar registros con fotos.');">
                                    Comparar fotos
                                </button>
                            {% endif %}
                        </div>
                    {% elif es_identificar %}
                        <div class="card-actions">
                            {% if fotos %}
                                <button type="button"
                                        class="btn-accion btn-accion-primario btn-identificar"
                                        data-mascota-id="{{ mascota.id }}">
                                    Identificar razas
                                </button>
                            {% else %}
                                <button type="button"
                                        class="btn-accion btn-accion-primario btn-comparar-sin-fotos"
                                        onclick="alert('Para identificar razas debes seleccionar registros que tengan fotos.');">
                                    Identificar razas
                                </button>
                            {% endif %}
                        </div>
                        <div class="identificar-resultado" id="identificar-resultado-{{ mascota.id }}"></div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="mensaje">No se encontraron mascotas.</div>
        {% endif %}
    {% endif %}
</div>

<!-- Lightbox overlay -->
<div id="lightbox" class="lb-overlay" aria-hidden="true">
    <div class="lb-inner">
        <img id="lb-img" class="lb-img" src="" alt="">
        <div id="lb-cap" class="lb-caption"></div>
        <button type="button" id="lb-close" class="lb-close" aria-label="Cerrar">×</button>
    </div>
</div>

<script>
    (function () {
        const overlay = document.getElementById('lightbox');
        const img = document.getElementById('lb-img');
        const cap = document.getElementById('lb-cap');
        const btnClose = document.getElementById('lb-close');

        function openLB(src, caption, alt) {
            img.src = src;
            img.alt = alt || '';
            cap.textContent = caption || '';
            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closeLB() {
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
            img.src = '';
            img.alt = '';
            cap.textContent = '';
            document.body.style.overflow = '';
        }

        document.addEventListener('click', function(e) {
            const t = e.target;

            // Lightbox
            if (t && t.classList.contains('js-lb')) {
                const src = t.getAttribute('src');
                const caption = t.getAttribute('data-cap') || t.getAttribute('alt') || '';
                openLB(src, caption, t.getAttribute('alt'));
                return;
            }

            // Identificar raza
            if (t && t.classList.contains('btn-identificar')) {
                e.preventDefault();

                const mascotaId = t.getAttribute('data-mascota-id');
                if (!mascotaId) return;

                const card = t.closest('.mascota-card');
                const salida = card ? card.querySelector(`#identificar-resultado-${mascotaId}`) : null;
                const textoOriginal = t.textContent;

                const extraerTexto = (valor) => {
                    if (valor === undefined || valor === null) return '';
                    if (typeof valor === 'string') return valor;
                    if (typeof valor === 'number' || typeof valor === 'boolean') return String(valor);
                    if (Array.isArray(valor)) {
                        return valor
                            .map(v => extraerTexto(v))
                            .filter(Boolean)
                            .join('\n\n');
                    }
                    if (typeof valor === 'object') {
                        const clavesPreferidas = ['resultado', 'mensaje', 'texto', 'descripcion', 'detalle', 'detalle_error', 'raza', 'raw'];
                        for (const clave of clavesPreferidas) {
                            if (clave in valor) {
                                const posibleTexto = extraerTexto(valor[clave]);
                                if (posibleTexto) return posibleTexto;
                            }
                        }
                    }
                    return '';
                };

                const mostrarMensaje = (mensaje, esError = false) => {
                    if (!salida) return;
                    salida.innerHTML = '';

                    let texto = extraerTexto(mensaje)
                        .replace(/\n\s*\n+/g, '\n')
                        .trim();

                    if (!texto) {
                        texto = esError ? 'No se pudo identificar la raza.' : 'No se obtuvo información.';
                    }

                    const pre = document.createElement('pre');
                    pre.textContent = texto;
                    pre.className = esError ? 'identificar-error' : 'identificar-exito';

                    pre.style.whiteSpace = 'pre-wrap';
                    pre.style.wordBreak = 'break-word';
                    pre.style.maxWidth = '100%';
                    pre.style.fontSize = '0.95rem';
                    pre.style.lineHeight = '1.3';
                    pre.style.padding = '10px 14px';
                    pre.style.borderRadius = '6px';

                    if (esError) {
                        pre.style.backgroundColor = '#a52323';
                        pre.style.color = '#fff';
                    } else {
                        pre.style.backgroundColor = '#2d8f3a';
                        pre.style.color = '#fff';
                    }

                    salida.appendChild(pre);
                };

                t.disabled = true;
                t.textContent = 'Identificando…';

                if (salida) {
                    if (!document.getElementById('identificar-pendiente-style')) {
                        const style = document.createElement('style');
                        style.id = 'identificar-pendiente-style';
                        style.textContent = `
                            @keyframes identificarParpadeoTemp {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.35; }
                            }
                            .identificar-pendiente-temp {
                                color: #8b0000;
                                font-weight: 600;
                                font-size: 1.05rem;
                                animation: identificarParpadeoTemp 1s ease-in-out infinite;
                                margin-top: 6px;
                            }
                        `;
                        document.head.appendChild(style);
                    }

                    salida.innerHTML = '<div class="identificar-pendiente-temp">Procesando fotos para identificar la raza… Puede tardar hasta 2 minutos.</div>';
                }

                fetch(`/mascotas/${mascotaId}/identificar_raza`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    },
                })
                .then(resp => resp.json().catch(() => ({})))
                .then(data => {
                    if (data && data.ok) {
                        const principal = extraerTexto(data);
                        mostrarMensaje(principal || 'No se recibió texto de resultado.');
                    } else {
                        const msg = data ? extraerTexto(data) : '';
                        mostrarMensaje(msg || 'No se pudo identificar la raza.', true);
                    }
                })
                .catch(err => {
                    mostrarMensaje(`Error de red: ${err}`, true);
                })
                .finally(() => {
                    t.disabled = false;
                    t.textContent = textoOriginal;
                });
            }
        });

        btnClose.addEventListener('click', closeLB);
        overlay.addEventListener('click', function(e) { if (e.target === overlay) closeLB(); });
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeLB(); });
    })();
</script>
</body>
</html>