<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Seleccionar candidata encontrada</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="container">
    <header class="header-bar">
        <h1>Selecciona una mascota encontrada para comparar</h1>
        <nav class="header-actions">
            <a class="btn-volver" href="{{ url_for('main.index') }}">⬅ Volver al inicio</a>
        </nav>
    </header>

    <!-- Mensajes flash -->
    {% with msgs = get_flashed_messages(with_categories=True) %}
        {% if msgs %}
            <div class="flash-container" style="max-width:960px;margin:12px auto;">
                {% for cat, msg in msgs %}
                    <div class="flash {{ cat }}">{{ msg }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <section class="resumen-desaparecida">
        <h2>Mascota desaparecida seleccionada</h2>
        <div class="mascota-card">
            <div class="mascota-info mascota-info-grid">
                <div class="info-col col-identidad">
                    <span><b>Nombre:</b> {{ mascota_desaparecida.nombre }}</span>
                    <span><b>Especie:</b> {{ mascota_desaparecida.especie }}</span>
                    <span><b>Raza:</b> {{ mascota_desaparecida.raza or "—" }}</span>
                    <span><b>Zona:</b> {{ mascota_desaparecida.zona or "—" }}</span>
                    <span><b>Color:</b> {{ mascota_desaparecida.color or "—" }}</span>
                    <span><b>Tamaño:</b> {{ mascota_desaparecida.tamano or "—" }}</span>
                </div>
                <div class="info-col col-detalles">
                    <span><b>Descripción:</b> {{ mascota_desaparecida.descripcion or "—" }}</span>
                    <span><b>Sexo:</b> {{ mascota_desaparecida.sexo or "—" }}</span>
                    <span><b>Chip:</b> {{ mascota_desaparecida.chip or "—" }}</span>
                    <span><b>Peso (kg):</b> {{ (mascota_desaparecida.peso|string ~ " kg") if mascota_desaparecida.peso is not none else "—" }}</span>
                    <span><b>Edad:</b> {{ mascota_desaparecida.edad if mascota_desaparecida.edad is not none else "—" }}</span>
                </div>
                <div class="info-col col-contacto">
                    <span><b>Email contacto:</b> {{ mascota_desaparecida.propietario_email or "—" }}</span>
                    <span><b>Teléfono:</b> {{ mascota_desaparecida.propietario_telefono or "—" }}</span>
                    <span><b>Fecha registro:</b> {{ mascota_desaparecida.fecha_registro.strftime("%d/%m/%Y") if mascota_desaparecida.fecha_registro else "—" }}</span>
                </div>
            </div>

            {% if mascota_desaparecida.fotos %}
                <div class="foto-info">
                    <b>Fotos registradas:</b>
                    <div class="foto-thumbs">
                        {% for foto in mascota_desaparecida.fotos %}
                            {% set ruta_rel = foto.ruta if foto.ruta.startswith('static/') else 'static/' ~ foto.ruta %}
                            <div class="thumb">
                                <img class="js-lb"
                                     src="{{ url_for('static', filename=ruta_rel.split('static/', 1)[1]) }}"
                                     alt="{{ foto.tipo_foto }}"
                                     data-cap="{{ mascota_desaparecida.nombre }} — {{ foto.tipo_foto }}">
                                <div class="cap">{{ foto.tipo_foto }}</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="foto-info"><i>Sin fotos registradas.</i></div>
            {% endif %}
        </div>
    </section>

    <section class="candidatas">
        <h2>Mascotas encontradas candidatas</h2>

        {% if candidatas %}
            <p class="hint">
                Selecciona la mascota encontrada que quieras enfrentar a la desaparecida. Si una candidata no tiene
                fotos, no aparecerá.
            </p>

            <div class="resultados">
                {% for candidata, fotos in candidatas_con_fotos %}
                    <div class="mascota-card">
                        <div class="mascota-info mascota-info-grid">
                            <div class="info-col col-identidad">
                                <span><b>ID:</b> {{ candidata.id }}</span>
                                <span><b>Nombre:</b> {{ candidata.nombre }}</span>
                                <span><b>Especie:</b> {{ candidata.especie }}</span>
                                <span><b>Raza:</b> {{ candidata.raza or "—" }}</span>
                                <span><b>Zona:</b> {{ candidata.zona or "—" }}</span>
                                <span><b>Color:</b> {{ candidata.color or "—" }}</span>
                            </div>
                            <div class="info-col col-detalles">
                                <span><b>Descripción:</b> {{ candidata.descripcion or "—" }}</span>
                                <span><b>Sexo:</b> {{ candidata.sexo or "—" }}</span>
                                <span><b>Chip:</b> {{ candidata.chip or "—" }}</span>
                                <span><b>Peso (kg):</b> {{ (candidata.peso|string ~ " kg") if candidata.peso is not none else "—" }}</span>
                                <span><b>Edad:</b> {{ candidata.edad if candidata.edad is not none else "—" }}</span>
                            </div>
                            <div class="info-col col-contacto">
                                <span><b>Email contacto:</b> {{ candidata.propietario_email or "—" }}</span>
                                <span><b>Teléfono:</b> {{ candidata.propietario_telefono or "—" }}</span>
                                <span><b>Fecha registro:</b> {{ candidata.fecha_registro.strftime("%d/%m/%Y") if candidata.fecha_registro else "—" }}</span>
                            </div>
                        </div>

                        {% if fotos %}
                            <div class="foto-info">
                                <b>Fotos registradas:</b>
                                <div class="foto-thumbs">
                                    {% for foto in fotos %}
                                        {% set ruta_rel = foto.ruta if foto.ruta.startswith('static/') else 'static/' ~ foto.ruta %}
                                        <div class="thumb">
                                            <img class="js-lb"
                                                 src="{{ url_for('static', filename=ruta_rel.split('static/', 1)[1]) }}"
                                                 alt="{{ foto.tipo_foto }}"
                                                 data-cap="{{ candidata.nombre }} — {{ foto.tipo_foto }}">
                                            <div class="cap">{{ foto.tipo_foto }}</div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <div class="foto-info"><i>Sin fotos registradas.</i></div>
                        {% endif %}

                        <div class="card-actions">
                            <form method="GET" action="{{ url_for('main.comparar_mascotas_detalle', desaparecida_id=mascota_desaparecida.id, encontrada_id=candidata.id) }}">
                                <button type="submit" class="btn-accion btn-accion-primario">
                                    Comparar con esta mascota
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="mensaje">
                No se encontraron mascotas encontradas que cumplan los requisitos
                (fecha de registro posterior y con fotos cargadas).
            </div>
        {% endif %}
    </section>
</div>

<!-- Lightbox overlay -->
<div id="lightbox" class="lb-overlay" aria-hidden="true">
    <div class="lb-inner">
        <img id="lb-img" class="lb-img" src="" alt="">
        <div id="lb-cap" class="lb-caption"></div>
        <button type="button" id="lb-close" class="lb-close" aria-label="Cerrar">×</button>
    </div>
</div>

<script>
    (function () {
        const overlay = document.getElementById('lightbox');
        const img = document.getElementById('lb-img');
        const cap = document.getElementById('lb-cap');
        const btnClose = document.getElementById('lb-close');

        function openLB(src, caption, alt) {
            img.src = src;
            img.alt = alt || '';
            cap.textContent = caption || '';
            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closeLB() {
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
            img.src = '';
            img.alt = '';
            cap.textContent = '';
            document.body.style.overflow = '';
        }

        document.addEventListener('click', function(e) {
            const t = e.target;
            if (t && t.classList.contains('js-lb')) {
                const src = t.getAttribute('src');
                const caption = t.getAttribute('data-cap') || t.getAttribute('alt') || '';
                openLB(src, caption, t.getAttribute('alt'));
            }
        });

        btnClose.addEventListener('click', closeLB);
        overlay.addEventListener('click', function(e) { if (e.target === overlay) closeLB(); });
        document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeLB(); });
    })();
</script>
</body>
</html>