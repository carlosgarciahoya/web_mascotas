<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Comparar fotos</title>
    {% if csrf_token is defined %}
        <meta name="csrf-token" content="{{ csrf_token() }}">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        :root {
            --espacio-peq: 6px;
            --espacio-med: 10px;
        }
        body {
            background: #eef1f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px 16px 32px;
        }
        .header-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .header-bar h1 {
            margin: 0;
            font-size: 1.6rem;
        }
        .acciones {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn-type-wrapper {
            position: relative;
            display: inline-flex;
            align-items: stretch;
        }
        .btn-type-wrapper button {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            background: #007bff;
            color: #fff;
            font-size: 0.92rem;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 220px;
        }
        .btn-type-wrapper button:hover {
            background: #0064d2;
        }
        .btn-type-wrapper select {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        #btnCompararTipo:disabled {
            background: #9ca9bc;
            cursor: not-allowed;
        }
        #btnCompararTodas {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            background: #5c636a;
            color: #fff;
            font-size: 0.92rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        #btnCompararTodas:hover {
            background: #4b5156;
        }
        .btn-volver {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            background: #f1f3f5;
            color: #212529;
            font-size: 0.92rem;
            text-decoration: none;
            transition: background 0.2s;
        }
        .btn-volver:hover {
            background: #e9ecef;
        }
        #mensajeComparacion {
            background: #fdecea;
            color: #b71c1c;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 9px 12px;
            margin-bottom: var(--espacio-med);
            display: none;
        }
        #mensajeComparacion.info {
            background: #e3f2fd;
            color: #0b5394;
            border-color: #9ec5fe;
        }
        #mensajeComparacion.success {
            background: #e8f5e9;
            color: #1b5e20;
            border-color: #a5d6a7;
        }
        .compare-layout {
            display: flex;
            gap: var(--espacio-med);
            height: calc(100vh - 150px);
            min-height: 480px;
        }
        .compare-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 5px 14px rgba(0,0,0,0.07);
            padding: 12px;
            overflow: hidden;
        }
        .compare-column.desaparecida {
            border-top: 5px solid #f16a6f;
        }
        .compare-column.encontrada {
            border-top: 5px solid #4caf50;
        }
        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: var(--espacio-peq);
        }
        .column-header h2 {
            margin: 0;
            font-size: 1.18rem;
            letter-spacing: .045em;
            text-transform: uppercase;
        }
        .double-column {
            flex: 1;
            display: flex;
            gap: var(--espacio-med);
            overflow: hidden;
        }
        .details-block,
        .photos-block {
            flex: 1;
            border-radius: 8px;
            background: #f8f9fa;
            padding: 8px;
            overflow-y: auto;
        }
        .details-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .info-item {
            margin: 0;
        }
        .info-item strong {
            display: block;
            font-weight: 700;
            font-size: 0.9rem;
            color: #343a40;
        }
        .info-item span {
            display: block;
            font-size: 0.9rem;
            color: #212529;
            line-height: 1.2;
        }
        .photos-block {
            display: flex;
            flex-direction: column;
            gap: var(--espacio-peq);
            padding-right: 4px;
        }
        .photo-group h3 {
            margin: 0 0 4px;
            font-size: 0.88rem;
            font-weight: 600;
            color: #495057;
            text-transform: capitalize;
        }
        .photo-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .photo-grid .photo-card {
            width: 96px;
            height: 96px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 9px rgba(0,0,0,0.1);
            background: #ffffff;
            cursor: zoom-in;
        }
        .photo-grid img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .diagnostico-wrapper {
            margin-top: 18px;
            display: grid;
            gap: 12px;
        }
        .diagnostico-card {
            background: #ffffff;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 12px 14px;
        }
        .diagnostico-card h3 {
            margin: 0 0 8px;
            font-size: 1.02rem;
            color: #2b3a4b;
        }
        .diagnostico-item {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .diagnostico-texto {
            flex: 1 1 220px;
            font-size: 0.92rem;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        .diagnostico-fotos {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .diagnostico-foto {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #d0d6de;
            background: #fff;
            cursor: zoom-in;
        }
        .diagnostico-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .lightbox-overlay.show {
            display: flex;
        }
        .lightbox-inner {
            position: relative;
        }
        .lightbox-inner img {
            max-width: 90vw;
            max-height: 90vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        }
        .lightbox-close {
            position: absolute;
            top: -14px;
            right: -14px;
            background: #ffffff;
            color: #222;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }
        @media (max-width: 992px) {
            .compare-layout {
                flex-direction: column;
                height: auto;
                min-height: unset;
            }
            .double-column {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container"
     data-url-comparar-tipo="{{ url_comparar_tipo | default('') }}"
     data-url-comparar-todas="{{ url_comparar_todas | default('') }}">
    {% set orden_preferido = [
        'cara', 'face', 'rostro', 'cabeza',
        'frontal', 'frente',
        'lateral', 'perfil',
        'lateral_izquierdo', 'lateral_izquierda', 'lateral_izdo',
        'lateral_derecho', 'lateral_derecha', 'lateral_dcha', 'lateral_dcho',
        'cuerpo', 'completa', 'entera',
        'trasero', 'posterior',
        'detalle', 'detalles',
        'otros', 'desconocido'
    ] %}

    {% macro formatear_tipo(tipo) -%}
        {% set map_alias = {
            'face': 'cara',
            'rostro': 'cara',
            'cabeza': 'cara',
            'frente': 'frontal',
            'posterior': 'trasero',
            'lateral_izquierdo': 'lateral izquierdo',
            'lateral_izquierda': 'lateral izquierdo',
            'lateral_izdo': 'lateral izquierdo',
            'lateral_derecho': 'lateral derecho',
            'lateral_derecha': 'lateral derecho',
            'lateral_dcha': 'lateral derecho',
            'lateral_dcho': 'lateral derecho'
        } %}
        {% set base = map_alias.get(tipo, tipo) %}
        {% set texto = base.replace('_', ' ') %}
        {{ texto|title }}
    {%- endmacro %}

    {% set tipos_desap_disp = tipos_compartidos.desaparecida if tipos_compartidos is defined and tipos_compartidos.desaparecida is not none else fotos_desap_por_tipo.keys()|list %}
    {% set tipos_encon_disp = tipos_compartidos.encontrada if tipos_compartidos is defined and tipos_compartidos.encontrada is not none else fotos_encon_por_tipo.keys()|list %}

    {% set inter = namespace(lista=[]) %}
    {% for tipo in orden_preferido %}
        {% if tipo in tipos_desap_disp and tipo in tipos_encon_disp %}
            {% set inter.lista = inter.lista + [tipo] %}
        {% endif %}
    {% endfor %}
    {% for tipo in tipos_desap_disp %}
        {% if tipo in tipos_encon_disp and tipo not in inter.lista %}
            {% set inter.lista = inter.lista + [tipo] %}
        {% endif %}
    {% endfor %}
    {% set tipos_interseccion = inter.lista %}

    <header class="header-bar">
        <h1>Comparar fotos</h1>
        <div class="acciones">
            <div class="btn-type-wrapper">
                <button type="button" id="btnCompararTipo" data-label="Comparar por tipo (más fiable)"
                        {% if tipos_interseccion|length == 0 %}disabled{% endif %}>
                    Comparar por tipo (más fiable)
                </button>
                
                <select id="tipoComparacion" {% if tipos_interseccion|length == 0 %}disabled{% endif %}>
                    <option value="" selected disabled>— Selecciona un tipo —</option>
                    {% for tipo in tipos_interseccion %}
                        <option value="{{ tipo }}">{{ formatear_tipo(tipo) }}</option>
                    {% endfor %}
                </select>
                              
            </div>
            <button type="button" id="btnCompararTodas">Comparar todas (menos fiable)</button>
            <a class="btn-volver" href="{{ url_for('main.index') }}">⬅ Volver al inicio</a>
        </div>
    </header>

    <div id="mensajeComparacion"></div>

    <div id="resultadoComparacion" class="diagnostico-card" style="display:none; margin-bottom: var(--espacio-med);">
        <h3 id="resultadoComparacionTitulo">Resultado comparación</h3>
        <div class="diagnostico-item">
            <div class="diagnostico-texto" id="resultadoComparacionTexto"></div>
        </div>
        <div class="diagnostico-item" id="resultadoComparacionScoreWrapper" style="display:none;">
            <div class="diagnostico-texto">
                <strong>Coincidencia estimada:</strong>
                <span id="resultadoComparacionScore"></span>
            </div>
        </div>
    </div>

    <div class="compare-layout">
        {% set mostrados_desap = namespace(tipos=[]) %}
        {% set mostrados_encon = namespace(tipos=[]) %}

        <section class="compare-column desaparecida">
            <div class="column-header">
                <h2>Desaparecida</h2>
                <span>ID: {{ mascota_desaparecida.id }}</span>
            </div>

            <div class="double-column">
                <div class="details-block">
                    <p class="info-item"><strong>Nombre</strong><span>{{ mascota_desaparecida.nombre or "—" }}</span></p>
                    <p class="info-item"><strong>Especie</strong><span>{{ mascota_desaparecida.especie or "—" }}</span></p>
                    <p class="info-item"><strong>Raza</strong><span>{{ mascota_desaparecida.raza or "—" }}</span></p>
                    <p class="info-item"><strong>Color</strong><span>{{ mascota_desaparecida.color or "—" }}</span></p>
                    <p class="info-item"><strong>Tamaño</strong><span>{{ mascota_desaparecida.tamano or "—" }}</span></p>
                    <p class="info-item"><strong>Descripción</strong><span>{{ mascota_desaparecida.descripcion or "—" }}</span></p>
                    <p class="info-item"><strong>Sexo</strong><span>{{ mascota_desaparecida.sexo or "—" }}</span></p>
                    <p class="info-item"><strong>Chip</strong><span>{{ mascota_desaparecida.chip or "—" }}</span></p>
                    <p class="info-item"><strong>Peso (kg)</strong><span>{{ (mascota_desaparecida.peso|string ~ " kg") if mascota_desaparecida.peso is not none else "—" }}</span></p>
                    <p class="info-item"><strong>Edad</strong><span>{{ mascota_desaparecida.edad if mascota_desaparecida.edad is not none else "—" }}</span></p>
                    <p class="info-item"><strong>Zona</strong><span>{{ mascota_desaparecida.zona or "—" }}</span></p>
                    <p class="info-item"><strong>Contacto</strong>
                        <span>
                            {{ mascota_desaparecida.propietario_email or "—" }}<br>
                            {{ mascota_desaparecida.propietario_telefono or "—" }}
                        </span>
                    </p>
                    <p class="info-item"><strong>Fecha de registro</strong>
                        <span>{{ mascota_desaparecida.fecha_registro.strftime("%d/%m/%Y") if mascota_desaparecida.fecha_registro else "—" }}</span>
                    </p>
                </div>

                <div class="photos-block">
                    {% for tipo in orden_preferido %}
                        {% if fotos_desap_por_tipo.get(tipo) %}
                            {% set fotos = fotos_desap_por_tipo.get(tipo) %}
                            <div class="photo-group">
                                <h3>{{ formatear_tipo(tipo) }}</h3>
                                <div class="photo-grid">
                                    {% for foto in fotos %}
                                        <div class="photo-card">
                                            <img class="zoomable"
                                                 src="{{ foto.url }}"
                                                 alt="{{ formatear_tipo(tipo) }} de {{ mascota_desaparecida.nombre or ('ID ' ~ mascota_desaparecida.id) }}"
                                                 loading="lazy"
                                                 data-tipo="{{ tipo }}"
                                                 data-foto-id="{{ foto.id }}"
                                                 data-mascota="desaparecida">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% set mostrados_desap.tipos = mostrados_desap.tipos + [tipo] %}
                        {% endif %}
                    {% endfor %}
                    {% for tipo, fotos in fotos_desap_por_tipo.items() %}
                        {% if tipo not in mostrados_desap.tipos %}
                            <div class="photo-group">
                                <h3>{{ formatear_tipo(tipo) }}</h3>
                                <div class="photo-grid">
                                    {% for foto in fotos %}
                                        <div class="photo-card">
                                            <img class="zoomable"
                                                 src="{{ foto.url }}"
                                                 alt="{{ formatear_tipo(tipo) }} de {{ mascota_desaparecida.nombre or ('ID ' ~ mascota_desaparecida.id) }}"
                                                 loading="lazy"
                                                 data-tipo="{{ tipo }}"
                                                 data-foto-id="{{ foto.id }}"
                                                 data-mascota="desaparecida">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </section>

        <section class="compare-column encontrada">
            <div class="column-header">
                <h2>Encontrada</h2>
                <span>ID: {{ mascota_encontrada.id }}</span>
            </div>

            <div la class="double-column">
                <div class="photos-block">
                    {% for tipo in orden_preferido %}
                        {% if fotos_encon_por_tipo.get(tipo) %}
                            {% set fotos = fotos_encon_por_tipo.get(tipo) %}
                            <div class="photo-group">
                                <h3>{{ formatear_tipo(tipo) }}</h3>
                                <div class="photo-grid">
                                    {% for foto in fotos %}
                                        <div class="photo-card">
                                            <img class="zoomable"
                                                 src="{{ foto.url }}"
                                                 alt="{{ formatear_tipo(tipo) }} de {{ mascota_encontrada.nombre or ('ID ' ~ mascota_encontrada.id) }}"
                                                 loading="lazy"
                                                 data-tipo="{{ tipo }}"
                                                 data-foto-id="{{ foto.id }}"
                                                 data-mascota="encontrada">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% set mostrados_encon.tipos = mostrados_encon.tipos + [tipo] %}
                        {% endif %}
                    {% endfor %}
                    {% for tipo, fotos in fotos_encon_por_tipo.items() %}
                        {% if tipo not in mostrados_encon.tipos %}
                            <div class="photo-group">
                                <h3>{{ formatear_tipo(tipo) }}</h3>
                                <div class="photo-grid">
                                    {% for foto in fotos %}
                                        <div class="photo-card">
                                            <img class="zoomable"
                                                 src="{{ foto.url }}"
                                                 alt="{{ formatear_tipo(tipo) }} de {{ mascota_encontrada.nombre or ('ID ' ~ mascota_encontrada.id) }}"
                                                 loading="lazy"
                                                 data-tipo="{{ tipo }}"
                                                 data-foto-id="{{ foto.id }}"
                                                 data-mascota="encontrada">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="details-block">
                    <p class="info-item"><strong>Nombre</strong><span>{{ mascota_encontrada.nombre or "—" }}</span></p>
                    <p class="info-item"><strong>Especie</strong><span>{{ mascota_encontrada.especie or "—" }}</span></p>
                    <p class="info-item"><strong>Raza</strong><span>{{ mascota_encontrada.raza or "—" }}</span></p>
                    <p class="info-item"><strong>Color</strong><span>{{ mascota_encontrada.color or "—" }}</span></p>
                    <p class="info-item"><strong>Tamaño</strong><span>{{ mascota_encontrada.tamano or "—" }}</span></p>
                    <p class="info-item"><strong>Descripción</strong><span>{{ mascota_encontrada.descripcion or "—" }}</span></p>
                    <p class="info-item"><strong>Sexo</strong><span>{{ mascota_encontrada.sexo or "—" }}</span></p>
                    <p class="info-item"><strong>Chip</strong><span>{{ mascota_encontrada.chip or "—" }}</span></p>
                    <p class="info-item"><strong>Peso (kg)</strong><span>{{ (mascota_encontrada.peso|string ~ " kg") if mascota_encontrada.peso is not none else "—" }}</span></p>
                    <p class="info-item"><strong>Edad</strong><span>{{ mascota_encontrada.edad if mascota_encontrada.edad is not none else "—" }}</span></p>
                    <p class="info-item"><strong>Zona</strong><span>{{ mascota_encontrada.zona or "—" }}</span></p>
                    <p class="info-item"><strong>Contacto</strong>
                        <span>
                            {{ mascota_encontrada.propietario_email or "—" }}<br>
                            {{ mascota_encontrada.propietario_telefono or "—" }}
                        </span>
                    </p>
                    <p class="info-item"><strong>Fecha de registro</strong>
                        <span>{{ mascota_encontrada.fecha_registro.strftime("%d/%m/%Y") if mascota_encontrada.fecha_registro else "—" }}</span>
                    </p>
                </div>
            </div>
        </section>
    </div>

    {% if diagnostico_individual or diagnosticos_globales %}
        <div class="diagnostico-wrapper">
            {% if diagnostico_individual %}
                <div class="diagnostico-card">
                    <h3>Resultado comparación por tipo ({{ formatear_tipo(diagnostico_individual.tipo) }})</h3>
                    <div class="diagnostico-item">
                        <div class="diagnostico-texto">{{ diagnostico_individual.resultado }}</div>
                        <div class="diagnostico-fotos">
                            <div class="diagnostico-foto">
                                <img class="zoomable" src="{{ diagnostico_individual.foto_desap.url }}" alt="Desaparecida comparación - {{ formatear_tipo(diagnostico_individual.tipo) }}">
                            </div>
                            <div class="diagnostico-foto">
                                <img class="zoomable" src="{{ diagnostico_individual.foto_encon.url }}" alt="Encontrada comparación - {{ formatear_tipo(diagnostico_individual.tipo) }}">
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if diagnosticos_globales %}
                <div class="diagnostico-card">
                    <h3>Resultados comparación todas las fotos</h3>
                    {% for diag in diagnosticos_globales %}
                        <div class="diagnostico-item" style="margin-bottom:10px;">
                            <div class="diagnostico-texto">{{ diag.resultado }}</div>
                            <div class="diagnostico-fotos">
                                {% if diag.foto_desap %}
                                    <div class="diagnostico-foto">
                                        <img class="zoomable" src="{{ diag.foto_desap.url }}" alt="Desaparecida comparada">
                                    </div>
                                {% endif %}
                                {% if diag.foto_encon %}
                                    <div class="diagnostico-foto">
                                        <img class="zoomable" src="{{ diag.foto_encon.url }}" alt="Encontrada comparada">
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>

<div id="lightbox" class="lightbox-overlay" aria-hidden="true">
    <div class="lightbox-inner">
        <img id="lightbox-img" src="" alt="">
        <button id="lightbox-close" class="lightbox-close" type="button" aria-label="Cerrar">×</button>
    </div>
</div>

<script>
    (function () {
        const overlay = document.getElementById('lightbox');
        const img = document.getElementById('lightbox-img');
        const btnClose = document.getElementById('lightbox-close');

        const container = document.querySelector('.container');
        const compareUrl = container?.dataset.urlCompararTipo || '';
        const compareAllUrl = container?.dataset.urlCompararTodas || '';

        const selectTipo = document.getElementById('tipoComparacion');
        const btnTipo = document.getElementById('btnCompararTipo');
        const btnTodas = document.getElementById('btnCompararTodas');
        const mensaje = document.getElementById('mensajeComparacion');

        const resultadoCard = document.getElementById('resultadoComparacion');
        const resultadoTitulo = document.getElementById('resultadoComparacionTitulo');
        const resultadoTexto = document.getElementById('resultadoComparacionTexto');
        const resultadoScoreWrapper = document.getElementById('resultadoComparacionScoreWrapper');
        const resultadoScore = document.getElementById('resultadoComparacionScore');

        const fotosDesapPorTipo = {{ fotos_desap_por_tipo | tojson }};
        const fotosEnconPorTipo = {{ fotos_encon_por_tipo | tojson }};

        const baseLabelTipo = btnTipo?.dataset.label || 'Comparar por tipo (más fiable)';
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

        function mostrarMensaje(texto, tipo = 'error') {
            if (!mensaje) return;
            mensaje.textContent = texto || '';
            mensaje.style.display = texto ? 'block' : 'none';
            mensaje.classList.remove('info', 'success');
            if (texto) {
                if (tipo === 'info') mensaje.classList.add('info');
                else if (tipo === 'success') mensaje.classList.add('success');
            }
        }

        function setTextoBotonBase() {
            if (!btnTipo) return;
            btnTipo.textContent = baseLabelTipo;
        }

        function handleSinTiposDisponibles() {
            if (!btnTipo) return;
            btnTipo.disabled = true;
            setTextoBotonBase();
            mostrarMensaje('No hay tipos de foto en común entre ambas mascotas.');
        }

        function limpiarResultado() {
            if (!resultadoCard) return;
            resultadoCard.style.display = 'none';
            if (resultadoTexto) resultadoTexto.textContent = '';
            if (resultadoScoreWrapper) resultadoScoreWrapper.style.display = 'none';
            if (resultadoScore) resultadoScore.textContent = '';
        }

        function mostrarResultado(label, data, modo = 'tipo') {
            if (!resultadoCard || !resultadoTitulo || !resultadoTexto) return;
            const mensajeResultado = data.mensaje || data.resultado || data.texto || 'Sin respuesta disponible.';
            resultadoTitulo.textContent = modo === 'todas'
                ? 'Resultado comparación todas las fotos'
                : `Resultado comparación por tipo (${label})`;
            resultadoTexto.textContent = mensajeResultado;

            let score = data.score ?? data.porcentaje ?? null;
            if (typeof score === 'string') {
                const parsed = parseFloat(score.replace(',', '.'));
                if (!Number.isNaN(parsed)) score = parsed;
            }
            if (typeof score === 'number' && Number.isFinite(score)) {
                let valor = score;
                if (valor <= 1 && valor > 0) valor = valor * 100;
                valor = Math.max(0, Math.min(100, Math.round(valor)));
                if (resultadoScore && resultadoScoreWrapper) {
                    resultadoScore.textContent = `${valor}%`;
                    resultadoScoreWrapper.style.display = 'flex';
                }
            } else if (resultadoScoreWrapper) {
                resultadoScoreWrapper.style.display = 'none';
            }

            resultadoCard.style.display = 'block';
        }

        function bloquearControles() {
            if (btnTipo) {
                btnTipo.dataset.wasDisabled = btnTipo.disabled ? '1' : '0';
                btnTipo.disabled = true;
            }
            if (selectTipo) {
                selectTipo.dataset.wasDisabled = selectTipo.disabled ? '1' : '0';
                selectTipo.disabled = true;
            }
            if (btnTodas) {
                btnTodas.dataset.wasDisabled = btnTodas.disabled ? '1' : '0';
                btnTodas.disabled = true;
            }
        }

        function restaurarControles() {
            if (btnTipo) {
                if (btnTipo.dataset.wasDisabled === '0') {
                    btnTipo.disabled = false;
                }
                delete btnTipo.dataset.wasDisabled;
            }
            if (selectTipo) {
                if (selectTipo.dataset.wasDisabled === '0') {
                    selectTipo.disabled = false;
                }
                delete selectTipo.dataset.wasDisabled;
            }
            if (btnTodas) {
                if (btnTodas.dataset.wasDisabled === '0') {
                    btnTodas.disabled = false;
                }
                delete btnTodas.dataset.wasDisabled;
            }
            setTextoBotonBase();
        }

        function obtenerRutaFoto(foto) {
            if (!foto || typeof foto !== 'object') return null;
            return (
                foto.ruta_abs ||
                foto.ruta_absoluta ||
                foto.ruta_relativa ||
                foto.ruta ||
                foto.path ||
                foto.filepath ||
                foto.file_path ||
                foto.url ||
                null
            );
        }

        function obtenerEtiqueta(tipo, label) {
            if (label && typeof label === 'string' && label.trim()) {
                return label.trim();
            }
            if (!tipo || typeof tipo !== 'string') {
                return 'tipo desconocido';
            }
            return tipo
                .split(/[_\s]+/)
                .filter(Boolean)
                .map((parte) => parte.charAt(0).toUpperCase() + parte.slice(1))
                .join(' ');
        }

        function compararPorTipo(tipo, labelTipo) {
            if (!tipo) return;

            const etiqueta = obtenerEtiqueta(tipo, labelTipo);
            if (!compareUrl) {
                mostrarMensaje('No se ha configurado la URL del endpoint para comparar por tipo.');
                return;
            }

            const fotosDesap = Array.isArray(fotosDesapPorTipo[tipo])
                ? fotosDesapPorTipo[tipo]
                : [];
            const fotosEncon = Array.isArray(fotosEnconPorTipo[tipo])
                ? fotosEnconPorTipo[tipo]
                : [];

            if (!fotosDesap.length || !fotosEncon.length) {
                mostrarMensaje('No hay fotos disponibles de ese tipo para ambas mascotas.');
                return;
            }

            const fotoDesap = fotosDesap[0];
            const fotoEncon = fotosEncon[0];

            const rutaDesap = obtenerRutaFoto(fotoDesap);
            const rutaEncon = obtenerRutaFoto(fotoEncon);

            if (!rutaDesap || !rutaEncon) {
                mostrarMensaje('No se pudo determinar la ruta de las imágenes seleccionadas.');
                return;
            }

            const payload = {
                tipo,
                foto_desap: {
                    id: fotoDesap.id ?? null,
                    ruta: rutaDesap,
                    url: fotoDesap.url ?? null,
                },
                foto_encon: {
                    id: fotoEncon.id ?? null,
                    ruta: rutaEncon,
                    url: fotoEncon.url ?? null,
                },
            };

            limpiarResultado();
            bloquearControles();
            mostrarMensaje(`Comparando imágenes de ${etiqueta}, por favor espera…`, 'info');

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }

            fetch(compareUrl, {
                method: 'POST',
                headers,
                body: JSON.stringify(payload),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: no se pudo completar la comparación.`);
                    }
                    return response.json();
                })
                .then((data) => {
                    if (!data) {
                        mostrarMensaje('El servidor no devolvió datos.', 'error');
                        return;
                    }
                    const ok = data.ok ?? data.success ?? true;
                    if (!ok) {
                        mostrarMensaje(data.mensaje || data.error || 'La comparación no se pudo completar.');
                        return;
                    }
                    mostrarMensaje('', 'info');
                    mostrarResultado(etiqueta, data);
                })
                .catch((error) => {
                    console.error('Comparación fallida:', error);
                    mostrarMensaje(error.message || 'Ocurrió un error al comparar las imágenes.');
                })
                .finally(() => {
                    restaurarControles();
                });
        }

        function compararTodas() {
            if (!compareAllUrl) {
                mostrarMensaje('No se ha configurado la URL del endpoint para comparar todas las fotos.');
                return;
            }

            limpiarResultado();
            bloquearControles();
            mostrarMensaje('Comparando todas las fotos, por favor espera…', 'info');

            const headers = {
                'Accept': 'application/json',
            };
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
                headers['Content-Type'] = 'application/json';
            }

            fetch(compareAllUrl, {
                method: 'POST',
                headers,
                body: csrfToken ? JSON.stringify({}) : undefined,
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: no se pudo completar la comparación.`);
                    }
                    return response.json();
                })
                .then((data) => {
                    if (!data) {
                        mostrarMensaje('El servidor no devolvió datos.', 'error');
                        return;
                    }
                    const ok = data.ok ?? data.success ?? true;
                    if (!ok) {
                        mostrarMensaje(data.mensaje || data.error || 'La comparación no se pudo completar.');
                        return;
                    }
                    mostrarMensaje('', 'info');
                    mostrarResultado('todas las fotos', data, 'todas');
                })
                .catch((error) => {
                    console.error('Comparación global fallida:', error);
                    mostrarMensaje(error.message || 'Ocurrió un error al comparar todas las fotos.');
                })
                .finally(() => {
                    restaurarControles();
                });
        }

        if (selectTipo && selectTipo.options.length > 0) {
            setTextoBotonBase();
            selectTipo.addEventListener('change', (event) => {
                const option = event.target.selectedOptions?.[0] ||
                    event.target.options[event.target.selectedIndex] ||
                    null;
                const valor = option ? option.value : event.target.value;
                if (!valor) {
                    limpiarResultado();
                    mostrarMensaje('Selecciona un tipo de foto para comparar.', 'info');
                    return;
                }
                compararPorTipo(valor, option ? option.text : valor);
            });
           
        } else {
            handleSinTiposDisponibles();
        }

        if (btnTipo && selectTipo) {
            btnTipo.addEventListener('click', () => {
                if (selectTipo.disabled || selectTipo.options.length === 0) {
                    handleSinTiposDisponibles();
                    return;
                }
                const option = selectTipo.selectedOptions?.[0] ||
                    selectTipo.options[selectTipo.selectedIndex] ||
                    null;
                const valor = option ? option.value : selectTipo.value;
                if (!valor) {
                    mostrarMensaje('Selecciona un tipo de foto antes de comparar.', 'info');
                    return;
                }
                compararPorTipo(valor, option ? option.text : valor);
            });
        }

        if (btnTodas) {
            btnTodas.addEventListener('click', () => {
                mostrarMensaje('');
                compararTodas();
            });
        }

        function openLightbox(src, alt) {
            if (!overlay || !img) return;
            img.src = src;
            img.alt = alt || '';
            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            if (!overlay || !img) return;
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
            img.src = '';
            img.alt = '';
            document.body.style.overflow = '';
        }

        document.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target.classList.contains('zoomable')) {
                openLightbox(target.src, target.alt);
            }
        });
        btnClose?.addEventListener('click', closeLightbox);
        overlay?.addEventListener('click', function (e) {
            if (e.target === overlay) closeLightbox();
        });
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeLightbox();
        });
    })();
</script>
</body>
</html>