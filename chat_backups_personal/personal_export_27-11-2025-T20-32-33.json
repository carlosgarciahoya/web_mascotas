{
  "history": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "antes de cambiar nada en migratiosn de doy el esquema actual y los programas actuales, dime si debo cambiar algo ? :\nV migrations\n> _pycache\nV versions\n\n> _pycache\n‚Çπ 7d82a6643747_initial_schema.py\n= alembic.ini\n\nenv.py\n\nel programa xxxxx_initial_schema.py contiene :\n\"\"\"initial schema\n\nRevision ID: 7d82a6643747\nRevises: \nCreate Date: 2025-11-16 10:09:15.411028\n\n\"\"\"\nfrom alembic import op\nimport sqlalchemy as sa\n\n\n# revision identifiers, used by Alembic.\nrevision = '7d82a6643747'\ndown_revision = None\nbranch_labels = None\ndepends_on = None\n\n\ndef upgrade():\n    # ### commands auto generated by Alembic - please adjust! ###\n    op.create_table('mascota',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.Column('nombre', sa.String(length=50), nullable=False),\n    sa.Column('especie', sa.String(length=50), nullable=False),\n    sa.Column('raza', sa.String(length=50), nullable=True),\n    sa.Column('edad', sa.Integer(), nullable=True),\n    sa.Column('propietario_email', sa.String(length=120), nullable=False),\n    sa.Column('propietario_telefono', sa.String(length=20), nullable=False),\n    sa.Column('zona', sa.String(length=50), nullable=False),\n    sa.Column('tipo_registro', sa.String(length=12), nullable=False),\n    sa.Column('color', sa.String(length=30), nullable=False),\n    sa.Column('descripcion', sa.Text(), nullable=True),\n    sa.Column('chip', sa.String(length=20), nullable=True),\n    sa.Column('sexo', sa.String(length=8), nullable=False),\n    sa.Column('fecha_aparecida', sa.Date(), nullable=True),\n    sa.Column('estado_aparecida', sa.String(length=6), nullable=True),\n    sa.Column('peso', sa.Float(), nullable=True),\n    sa.Column('tamano', sa.String(length=20), nullable=False),\n    sa.Column('fecha_registro', sa.Date(), nullable=False),\n    sa.CheckConstraint(\"sexo IN ('macho','hembra','no_sabe')\", name='chk_sexo_valido'),\n    sa.CheckConstraint(\"tamano IN ('peque√±o','mediano','grande')\", name='chk_tamano_valido'),\n    sa.CheckConstraint(\"tipo_registro IN ('desaparecida','encontrada')\", name='chk_tipo_registro_valido'),\n    sa.PrimaryKeyConstraint('id'),\n    sa.UniqueConstraint('propietario_email', 'tipo_registro', 'nombre', 'zona', 'especie', 'color', 'tamano', 'fecha_registro', name='uix_email_tipo_nombre_zona_especie_color_tamano_fecha')\n    )\n    op.create_table('fotos_mascotas_desaparecidas',\n    sa.Column('id', sa.Integer(), nullable=False),\n    sa.Column('mascota_id', sa.Integer(), nullable=False),\n    sa.Column('tipo_foto', sa.String(length=30), nullable=False),\n    sa.Column('ruta', sa.String(length=200), nullable=False),\n    sa.ForeignKeyConstraint(['mascota_id'], ['mascota.id'], ),\n    sa.PrimaryKeyConstraint('id'),\n    sa.UniqueConstraint('mascota_id', 'tipo_foto', name='uix_foto_mascota_tipo')\n    )\n    # ### end Alembic commands ###\n\n\ndef downgrade():\n    # ### commands auto generated by Alembic - please adjust! ###\n    op.drop_table('fotos_mascotas_desaparecidas')\n    op.drop_table('mascota')\n    # ### end Alembic commands ###\n\nalmbic.ini contiene :\n# A generic, single database configuration.\n\n[alembic]\n# template used to generate migration files\n# file_template = %%(rev)s_%%(slug)s\n\n# set to 'true' to run the environment during\n# the 'revision' command, regardless of autogenerate\n# revision_environment = false\n\n\n# Logging configuration\n[loggers]\nkeys = root,sqlalchemy,alembic,flask_migrate\n\n[handlers]\nkeys = console\n\n[formatters]\nkeys = generic\n\n[logger_root]\nlevel = WARN\nhandlers = console\nqualname =\n\n[logger_sqlalchemy]\nlevel = WARN\nhandlers =\nqualname = sqlalchemy.engine\n\n[logger_alembic]\nlevel = INFO\nhandlers =\nqualname = alembic\n\n[logger_flask_migrate]\nlevel = INFO\nhandlers =\nqualname = flask_migrate\n\n[handler_console]\nclass = StreamHandler\nargs = (sys.stderr,)\nlevel = NOTSET\nformatter = generic\n\n[formatter_generic]\nformat = %(levelname)-5.5s [%(name)s] %(message)s\ndatefmt = %H:%M:%S\n\nel env.py contiene :\nimport logging\nfrom logging.config import fileConfig\n\nfrom flask import current_app\n\nfrom alembic import context\n\n# this is the Alembic Config object, which provides\n# access to the values within the .ini file in use.\nconfig = context.config\n\n# Interpret the config file for Python logging.\n# This line sets up loggers basically.\nfileConfig(config.config_file_name)\nlogger = logging.getLogger('alembic.env')\n\n\ndef get_engine():\n    try:\n        # this works with Flask-SQLAlchemy<3 and Alchemical\n        return current_app.extensions['migrate'].db.get_engine()\n    except (TypeError, AttributeError):\n        # this works with Flask-SQLAlchemy>=3\n        return current_app.extensions['migrate'].db.engine\n\n\ndef get_engine_url():\n    try:\n        return get_engine().url.render_as_string(hide_password=False).replace(\n            '%', '%%')\n    except AttributeError:\n        return str(get_engine().url).replace('%', '%%')\n\n\n# add your model's MetaData object here\n# for 'autogenerate' support\n# from myapp import mymodel\n# target_metadata = mymodel.Base.metadata\nconfig.set_main_option('sqlalchemy.url', get_engine_url())\ntarget_db = current_app.extensions['migrate'].db\n\n# other values from the config, defined by the needs of env.py,\n# can be acquired:\n# my_important_option = config.get_main_option(\"my_important_option\")\n# ... etc.\n\n\ndef get_metadata():\n    if hasattr(target_db, 'metadatas'):\n        return target_db.metadatas[None]\n    return target_db.metadata\n\n\ndef run_migrations_offline():\n    \"\"\"Run migrations in 'offline' mode.\n\n    This configures the context with just a URL\n    and not an Engine, though an Engine is acceptable\n    here as well.  By skipping the Engine creation\n    we don't even need a DBAPI to be available.\n\n    Calls to context.execute() here emit the given string to the\n    script output.\n\n    \"\"\"\n    url = config.get_main_option(\"sqlalchemy.url\")\n    context.configure(\n        url=url, target_metadata=get_metadata(), literal_binds=True\n    )\n\n    with context.begin_transaction():\n        context.run_migrations()\n\n\ndef run_migrations_online():\n    \"\"\"Run migrations in 'online' mode.\n\n    In this scenario we need to create an Engine\n    and associate a connection with the context.\n\n    \"\"\"\n\n    # this callback is used to prevent an auto-migration from being generated\n    # when there are no changes to the schema\n    # reference: http://alembic.zzzcomputing.com/en/latest/cookbook.html\n    def process_revision_directives(context, revision, directives):\n        if getattr(config.cmd_opts, 'autogenerate', False):\n            script = directives[0]\n            if script.upgrade_ops.is_empty():\n                directives[:] = []\n                logger.info('No changes in schema detected.')\n\n    conf_args = current_app.extensions['migrate'].configure_args\n    if conf_args.get(\"process_revision_directives\") is None:\n        conf_args[\"process_revision_directives\"] = process_revision_directives\n\n    connectable = get_engine()\n\n    with connectable.connect() as connection:\n        context.configure(\n            connection=connection,\n            target_metadata=get_metadata(),\n            **conf_args\n        )\n\n        with context.begin_transaction():\n            context.run_migrations()\n\n\nif context.is_offline_mode():\n    run_migrations_offline()\nelse:\n    run_migrations_online()"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Gracias por compartir el estado actual de tu carpeta `migrations`. Todo est√° correcto:\n\n- `alembic.ini`, `env.py` y la migraci√≥n inicial `7d82a6643747_initial_schema.py` son los que genera Flask-Migrate por defecto.\n- No necesitas modificar ninguno de estos archivos para el cambio que haremos ahora (agregar columnas nuevas en `FotoMascotaDesaparecida`).\n- Simplemente asegur√©monos de tener actualizado `models.py`, y a partir de ah√≠ generamos la nueva migraci√≥n con:\n\n```bash\nflask db migrate -m \"Agregar campos binarios a fotos\"\nflask db upgrade\n```\n\nPuedes continuar con esos comandos cuando quieras. Si aparece alg√∫n error o necesitas revisar el archivo de migraci√≥n generado, me avisas y lo revisamos juntos."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "resultado \n(.venv) PS C:\\Users\\CGH\\Documents\\web_mascotas> flask db migrate -m \"Agregar campos binarios a fotos\n>> ^C\n(.venv) PS C:\\Users\\CGH\\Documents\\web_mascotas> flask db migrate -m \"Agregar campos binarios a fotos\"\nINFO  [alembic.runtime.migration] Context impl PostgresqlImpl.\nINFO  [alembic.runtime.migration] Will assume transactional DDL.\nINFO  [alembic.ddl.postgresql] Detected sequence named 'fotos_mascotas_desaparecidas_id_seq' as owned by integer column 'fotos_mascotas_desaparecidas(id)', assuming SERIAL and omitting\nINFO  [alembic.autogenerate.compare] Detected added column 'fotos_mascotas_desaparecidas.data'\nINFO  [alembic.autogenerate.compare] Detected added column 'fotos_mascotas_desaparecidas.mime_type'\nINFO  [alembic.autogenerate.compare] Detected added column 'fotos_mascotas_desaparecidas.nombre_archivo'\nINFO  [alembic.autogenerate.compare] Detected added column 'fotos_mascotas_desaparecidas.tamano_bytes'\nGenerating C:\\Users\\CGH\\Documents\\web_mascotas\\migrations\\versions\\305968ec3d79_agregar_campos_binarios_a_fotos.py ...  done\n(.venv) PS C:\\Users\\CGH\\Documents\\web_mascotas> flask db upgrade\nINFO  [alembic.runtime.migration] Context impl PostgresqlImpl.\nINFO  [alembic.runtime.migration] Will assume transactional DDL.\nINFO  [alembic.runtime.migration] Running upgrade 7d82a6643747 -> 305968ec3d79, Agregar campos binarios a fotos\n(.venv) PS C:\\Users\\CGH\\Documents\\web_mascotas>"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Perfecto, la migraci√≥n se gener√≥ y aplic√≥ correctamente. ‚úÖ Ya tienes las nuevas columnas (`data`, `mime_type`, `nombre_archivo`, `tamano_bytes`) en la tabla `fotos_mascotas_desaparecidas`.\n\n---\n\n### Pr√≥ximo paso sugerido\nAhora podemos encargarnos de que, cuando se guarde una foto:\n\n1. Se lea el archivo (como hasta ahora), pero adem√°s se guarde el binario en `data`.\n2. Se almacenen `mime_type`, `nombre_archivo` y `tamano_bytes`.\n3. M√°s adelante, podremos a√±adir la ruta `/foto/<id>` para servirla directamente desde la base y preparar la URL para Instagram.\n\nSi te parece bien, dime cu√°l es el archivo o funci√≥n donde actualmente procesas las fotos al crear una mascota, y te digo exactamente qu√© cambiar con comentarios, manteniendo tu l√≥gica actual."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "los dos programas que gestionan la entrada de registros son : ,\ncrear_masota.html \n<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <title>{% if modo == 'modificar' %}Editar Mascota{% else %}Crear Mascota{% endif %}</title>\n    <link rel=\"stylesheet\" href=\"{{ url_for('static', filename='css/style.css') }}\">\n    <style>\n        body.layout-crear {\n            font-size: 0.90rem;\n        }\n        body.layout-crear .container {\n            width: 98% !important;\n            max-width: 1150px;\n            margin: 0;\n        }\n        body.layout-crear input,\n        body.layout-crear select,\n        body.layout-crear textarea,\n        body.layout-crear button {\n            font-size: 0.90rem;\n        }\n\n        .header-bar {\n            position: relative;\n            display: block;\n            margin-bottom: 2px;\n            background-color: #4CAF50;\n            color: #fff;\n            padding: 2px 8px;\n        }\n        .header-bar h1 {\n            text-align: center;\n            margin: 2px 0 0 0;\n            line-height: 1.15;\n            color: #fff;\n        }\n\n        .btn-volver {\n            position: absolute; right: 0; top: 50%; transform: translateY(-50%);\n            background-color: #19024e; color: white; padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer;\n        }\n        .btn-volver:hover { background-color: #f23131; }\n\n        main { margin-top: 0; }\n\n        .flash-container { max-width: 1100px; margin: 0 auto 2px auto; }\n        .flash { padding: 6px 10px; border-radius: 3px; margin: 2px auto; font-weight: 600; max-width: 900px; }\n        .flash.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }\n        .flash.error   { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }\n\n        .row-compact { display:flex; flex-wrap:wrap; gap:5px; margin-top:0; }\n        .row-compact input,\n        .row-compact select,\n        .row-compact textarea { flex:1 1 160px; min-width:135px; padding:5px; }\n        textarea { min-height: 90px; }\n\n        .row-contacto input { flex: 1 1 240px; min-width: 200px; }\n        .row-contacto .campo-telefono { flex: 1 1 110px; min-width: 110px; display:flex; }\n        .row-contacto .campo-telefono input { flex:1 1 auto; }\n\n        .row-contacto .campo-nombre { flex: 1 1 210px; min-width: 190px; display:flex; }\n        .row-contacto .campo-nombre input { flex:1 1 auto; }\n\n        .row-identificacion {\n            align-items: stretch;\n            flex-wrap: nowrap;\n        }\n        .row-identificacion .campo-zona {\n            flex: 1.3 1 280px;\n            min-width: 205px;\n            display:flex;\n        }\n        .row-identificacion .campo-zona input { flex:1 1 auto; width:100%; }\n\n        .row-identificacion .campo-fecha-registro {\n            flex: 0 0 145px; max-width: 145px;\n            display:flex; align-items:center; gap:6px;\n        }\n        .row-identificacion .campo-fecha-registro .input-fecha-registro {\n            flex: 1 1 auto;\n            min-width: 100px;\n            text-align: center;\n            font-size: 0.90rem;\n            padding: 6px;\n        }\n        .row-identificacion .campo-fecha-registro .btn-date {\n            min-width: 30px;\n            padding: 5px;\n            background:#eee;\n            border:1px solid #ccc;\n            border-radius:6px;\n            cursor:pointer;\n        }\n        .row-identificacion .campo-fecha-registro .btn-date:hover { background:#ddd; }\n        #fecha_registro_picker {\n            position:absolute; width:0; height:0; opacity:0; border:0; padding:0; pointer-events:none;\n        }\n\n        .row-identificacion .campo-especie,\n        .row-identificacion .campo-raza,\n        .row-identificacion .campo-sexo {\n            flex: 0 1 145px;\n            min-width: 130px;\n            display:flex;\n        }\n        .row-identificacion .campo-sexo { flex: 0 1 120px; min-width: 115px; }\n        .row-identificacion .campo-especie input,\n        .row-identificacion .campo-raza input,\n        .row-identificacion .campo-sexo select { flex:1 1 auto; }\n\n        .row-caracteristicas {\n            flex-wrap: nowrap;\n        }\n        .row-caracteristicas input,\n        .row-caracteristicas select {\n            flex:1 1 130px;\n            min-width:115px;\n        }\n\n        textarea[name=\"descripcion\"] {\n            height: 36px;\n            min-height: 36px;\n            max-height: 36px;\n            resize: vertical;\n            overflow-y: auto;\n        }\n\n        .foto-uploader { border:1px solid #ccc; border-radius:10px; padding:8px; margin-top:6px; background:#f9f9f9; }\n        .foto-uploader-line {\n            display:flex;\n            align-items:center; gap:6px; flex-wrap: nowrap;\n        }\n        .label-foto {\n            font-size: 0.95rem;\n            font-weight: 600;\n            white-space: nowrap;\n        }\n        .inline-group {\n            display:flex; align-items:center; gap:6px; flex-wrap:nowrap; width:100%;\n        }\n        .inline-group select { flex: 0 0 190px; height: 25px; padding: 2px 8px; font-size: 0.88rem; line-height: 1.10; }\n        .inline-group input[type=\"file\"] {\n            flex: 1 1 260px; min-width: 220px; max-width: 340px;\n            height: 25px; font-size: 0.88rem; line-height: 1.10; padding: 2px 6px;\n        }\n\n        .btn-add-foto {\n            background:#4CAF50;\n            color:#fff;\n            border:none;\n            padding:2px 6px;\n            border-radius:5px;\n            cursor:pointer;\n            flex:0 0 auto;\n            font-size: 0.72rem;\n            line-height: 1.05;\n            min-width: 0;\n            white-space: nowrap;\n            display: inline-flex;\n            align-items: center;\n            justify-content: center;\n            width: auto !important;\n            flex-shrink: 0;\n        }\n        .btn-add-foto:hover { background:#45a049; }\n\n        .foto-lista { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; padding:0; }\n        .foto-item {\n            list-style:none;\n            background:#eef;\n            border-radius:10px;\n            min-width:110px;\n            max-width:140px;\n            flex:0 0 120px;\n            text-align:center;\n            box-shadow:0 2px 4px rgba(0,0,0,0.1);\n            position: relative;\n            overflow: visible;\n        }\n        .foto-item figure { margin:0; display:flex; flex-direction:column; height:100%; }\n        .foto-item img { width:100%; height:100px; object-fit:cover; display:block; }\n        .foto-item figcaption { padding:4px 6px; font-size:0.82rem; font-weight:600; background:#dbe2ff; color:#2c3e50; text-transform:capitalize; }\n        .foto-item:hover { box-shadow:0 3px 8px rgba(0,0,0,0.18); }\n        .foto-item-vacio { background:none; box-shadow:none; cursor:default; min-width:220px; }\n\n        #btn-crear { margin-top: 6px; }\n        body, input, select, button, textarea { line-height: 1.20; }\n\n        input[placeholder*=\"(obligatorio)\"]::placeholder,\n        textarea[placeholder*=\"(obligatorio)\"]::placeholder,\n        input[required]::placeholder,\n        textarea[required]::placeholder {\n            font-weight: 700;\n            color: #333;\n            opacity: 1;\n        }\n\n        select:required:invalid {\n            font-weight: 700;\n            color: #333;\n        }\n        select:required:not(:invalid) {\n            font-weight: 400;\n        }\n        select option[value=\"\"] {\n            font-weight: 700;\n        }\n\n        @media (max-width: 980px) {\n            .row-identificacion,\n            .row-caracteristicas,\n            .foto-uploader-line,\n            .inline-group {\n                flex-wrap: wrap;\n            }\n            .label-foto {\n                margin-bottom: 2px;\n            }\n        }\n\n        body.layout-crear .header-bar h1 { font-weight: 600; }\n        body.layout-crear input[placeholder*=\"(obligatorio)\"]::placeholder,\n        body.layout-crear textarea[placeholder*=\"(obligatorio)\"]::placeholder,\n        body.layout-crear input[required]::placeholder,\n        body.layout-crear textarea[required]::placeholder {\n          font-weight: 500;\n        }\n        body.layout-crear select:required:invalid { font-weight: 500; }\n        body.layout-crear select option[value=\"\"] { font-weight: 500; }\n        body.layout-crear .flash { font-weight: 500; }\n        body.layout-crear .label-foto { font-weight: 500; }\n        body.layout-crear .foto-item figcaption { font-weight: 500; }\n        body.layout-crear strong,\n        body.layout-crear b { font-weight: 600; }\n    </style>\n</head>\n{% set modo = modo or 'crear' %}\n{% set tipo_registro = (tipo_registro or 'desaparecida')|lower %}\n<body class=\"layout-crear\" data-tipo_registro=\"{{ tipo_registro }}\" data-modo=\"{{ modo }}\">\n<div class=\"container\">\n    <header class=\"header-bar\">\n        <h1>\n            {% if modo == 'modificar' %}\n                Editar mascota {{ 'encontrada' if tipo_registro == 'encontrada' else 'desaparecida' }}\n            {% else %}\n                Crear nueva mascota {{ 'encontrada' if tipo_registro == 'encontrada' else 'desaparecida' }}\n            {% endif %}\n        </h1>\n        <a class=\"btn-volver\" href=\"{{ url_for('main.index') }}\">‚¨Ö Volver al inicio</a>\n    </header>\n\n    <div class=\"flash-container\">\n        {% with msgs = get_flashed_messages(with_categories=True) %}\n            {% if msgs %}\n                {% for cat, msg in msgs %}\n                    <div class=\"flash {{ cat }}\">{{ msg }}</div>\n                {% endfor %}\n            {% endif %}\n        {% endwith %}\n    </div>\n\n    <main>\n        <form id=\"form-crear\"\n              action=\"{{ form_action }}\"\n              method=\"POST\"\n              enctype=\"multipart/form-data\">\n            <input type=\"hidden\" name=\"tipo_registro\" value=\"{{ tipo_registro }}\">\n            <div id=\"fotos_eliminar_container\"></div>\n\n            <!-- Fila 1 -->\n            <div class=\"row-compact row-contacto\">\n                {% if tipo_registro == 'encontrada' %}\n                    <input type=\"email\"\n                           name=\"propietario_email\"\n                           placeholder=\"Email persona que lo encontr√≥\"\n                           value=\"{{ mascota.propietario_email if mascota else '' }}\"\n                           required>\n                    <div class=\"campo-telefono\">\n                        <input type=\"text\"\n                               id=\"telefono\"\n                               name=\"propietario_telefono\"\n                               placeholder=\"Telefono (obligatorio)\"\n                               maxlength=\"20\"\n                               value=\"{{ mascota.propietario_telefono if mascota else '' }}\"\n                               required>\n                    </div>\n                    <div class=\"campo-nombre\">\n                        <input type=\"text\"\n                               id=\"nombre\"\n                               value=\"{{ mascota.nombre if mascota else 'encontrada' }}\"\n                               placeholder=\"Nombre mascota\"\n                               readonly>\n                    </div>\n                    <input type=\"hidden\" name=\"nombre\" value=\"{{ mascota.nombre if mascota else 'encontrada' }}\">\n                {% else %}\n                    <input type=\"email\"\n                           name=\"propietario_email\"\n                           placeholder=\"Email propietario (obligatorio)\"\n                           value=\"{{ mascota.propietario_email if mascota else '' }}\"\n                           required>\n                    <div class=\"campo-telefono\">\n                        <input type=\"text\"\n                               id=\"telefono\"\n                               name=\"propietario_telefono\"\n                               placeholder=\"Telefono (obligatorio)\"\n                               maxlength=\"20\"\n                               value=\"{{ mascota.propietario_telefono if mascota else '' }}\"\n                               required>\n                    </div>\n                    <div class=\"campo-nombre\">\n                        <input type=\"text\"\n                               id=\"nombre\"\n                               name=\"nombre\"\n                               placeholder=\"Nombre mascota (obligatorio)\"\n                               maxlength=\"30\"\n                               value=\"{{ mascota.nombre if mascota else '' }}\"\n                               required>\n                    </div>\n                {% endif %}\n            </div>\n\n            <!-- Fila 2 -->\n            <div class=\"row-compact row-identificacion\">\n                <div class=\"campo-zona\">\n                    {% if tipo_registro == 'encontrada' %}\n                        <input type=\"text\"\n                               name=\"zona\"\n                               placeholder=\"Zona encontrada mascota (obligatorio)\"\n                               value=\"{{ mascota.zona if mascota else '' }}\"\n                               required>\n                    {% else %}\n                        <input type=\"text\"\n                               name=\"zona\"\n                               placeholder=\"Zona desaparici√≥n mascota (obligatorio)\"\n                               value=\"{{ mascota.zona if mascota else '' }}\"\n                               required>\n                    {% endif %}\n                </div>\n\n                <div class=\"campo-fecha-registro\">\n                    <input type=\"text\"\n                           id=\"fecha_registro\"\n                           name=\"fecha_registro\"\n                           class=\"input-fecha-registro\"\n                           placeholder=\"Fecha (obl)\"\n                           maxlength=\"10\"\n                           pattern=\"\\d{2}/\\d{2}/\\d{4}\"\n                           title=\"Formato requerido: dd/mm/aaaa\"\n                           inputmode=\"numeric\"\n                           autocomplete=\"off\"\n                           value=\"{{ mascota.fecha_registro.strftime('%d/%m/%Y') if mascota and mascota.fecha_registro else '' }}\"\n                           required>\n                    <button type=\"button\"\n                            class=\"btn-date\"\n                            id=\"btn_fecha_registro_picker\"\n                            title=\"Seleccionar con calendario\">\n                        <span aria-hidden=\"true\">üìÖ</span>\n                    </button>\n                    <input type=\"date\" id=\"fecha_registro_picker\" aria-hidden=\"true\" tabindex=\"-1\">\n                </div>\n\n                <div class=\"campo-especie\">\n                    <input type=\"text\"\n                           id=\"especie\"\n                           name=\"especie\"\n                           placeholder=\"Especie (obligatorio)\"\n                           value=\"{{ mascota.especie if mascota else '' }}\"\n                           required>\n                </div>\n\n                <div class=\"campo-raza\">\n                    <input type=\"text\"\n                           id=\"raza\"\n                           name=\"raza\"\n                           placeholder=\"{{ 'Raza (obligatorio)' if tipo_registro == 'desaparecida' else 'Raza(opcional)' }}\"\n                           value=\"{{ mascota.raza if mascota else '' }}\"\n                           {% if tipo_registro == 'desaparecida' %}required{% endif %}>\n                </div>\n\n                <div class=\"campo-sexo\">\n                    <select name=\"sexo\"\n                            {% if tipo_registro == 'desaparecida' %}required{% endif %}>\n                        <option value=\"\" disabled\n                                {% if not mascota or not mascota.sexo %}selected{% endif %}\n                                {% if tipo_registro == 'desaparecida' %}data-obligatorio=\"1\"{% endif %}>\n                            {{ 'Sexo (obl)' if tipo_registro == 'desaparecida' else 'Sexo (opcional)' }}\n                        </option>\n                        <option value=\"macho\" {% if mascota and mascota.sexo == 'macho' %}selected{% endif %}>macho</option>\n                        <option value=\"hembra\" {% if mascota and mascota.sexo == 'hembra' %}selected{% endif %}>hembra</option>\n                        <option value=\"no_sabe\" {% if mascota and mascota.sexo == 'no_sabe' %}selected{% endif %}>no sabe</option>\n                    </select>\n                </div>\n            </div>\n\n            <!-- Fila 3 -->\n            <div class=\"row-compact row-caracteristicas\">\n                <input type=\"text\"\n                       name=\"color\"\n                       placeholder=\"Color (obligatorio)\"\n                       value=\"{{ mascota.color if mascota else '' }}\"\n                       required>\n                <select name=\"tamano\" required>\n                    <option value=\"\" disabled data-obligatorio=\"1\"\n                            {% if not mascota or not mascota.tamano %}selected{% endif %}>\n                        Tama√±o (obligatorio)\n                    </option>\n                    <option value=\"peque√±o\" {% if mascota and mascota.tamano == 'peque√±o' %}selected{% endif %}>peque√±o</option>\n                    <option value=\"mediano\" {% if mascota and mascota.tamano == 'mediano' %}selected{% endif %}>mediano</option>\n                    <option value=\"grande\" {% if mascota and mascota.tamano == 'grande' %}selected{% endif %}>grande</option>\n                </select>\n                <input type=\"number\"\n                       id=\"edad\"\n                       name=\"edad\"\n                       placeholder=\"Edad\"\n                       min=\"0\"\n                       value=\"{{ mascota.edad if mascota and mascota.edad is not none else '' }}\">\n                <input type=\"number\"\n                       name=\"peso\"\n                       placeholder=\"Peso (kg)\"\n                       step=\"0.1\"\n                       min=\"0\"\n                       value=\"{{ ('%.2f'|format(mascota.peso)).rstrip('0').rstrip('.') if mascota and mascota.peso is not none else '' }}\">\n                <input type=\"text\"\n                       name=\"chip\"\n                       placeholder=\"Chip (opcional)\"\n                       value=\"{{ mascota.chip if mascota else '' }}\">\n            </div>\n\n            <!-- Fila 4 -->\n            <div class=\"row-compact\">\n                <textarea name=\"descripcion\"\n                          rows=\"1\"\n                          placeholder=\"Descripci√≥n de mascota, car√°cter, particularidades\">{{ mascota.descripcion if mascota and mascota.descripcion else '' }}</textarea>\n            </div>\n\n            <div class=\"foto-uploader\">\n                <div class=\"foto-uploader-line\">\n                    <span class=\"label-foto\">Subir fotograf√≠as (opcional)</span>\n                    <div class=\"inline-group\">\n                        <select id=\"tipo_foto_visible\">\n                            <option value=\"\" disabled selected>Seleccionar tipo de foto</option>\n                            <option value=\"cara\">Cara</option>\n                            <option value=\"frontal\">Frontal</option>\n                            <option value=\"lateral_izquierdo\">Lateral Izquierdo</option>\n                            <option value=\"lateral_derecho\">Lateral Derecho</option>\n                            <option value=\"trasero\">Trasero</option>\n                        </select>\n                        <input type=\"file\" id=\"archivo_foto_visible\" accept=\"image/*\">\n                        <button type=\"button\" class=\"btn-add-foto\" onclick=\"agregarFoto()\">+ A√±adir foto</button>\n                    </div>\n                </div>\n\n                <ul class=\"foto-lista\" id=\"lista_fotos\">\n                    <li class=\"foto-item foto-item-vacio\" id=\"sin_fotos\"><i>No se han a√±adido fotos todav√≠a.</i></li>\n                </ul>\n            </div>\n\n            <button id=\"btn-crear\" type=\"submit\">\n                {% if modo == 'modificar' %}\n                    Guardar cambios\n                {% else %}\n                    {{ 'Crear mascota encontrada' if tipo_registro == 'encontrada' else 'Crear mascota' }}\n                {% endif %}\n            </button>\n        </form>\n    </main>\n</div>\n\n<script>\n    const modoFormulario = document.body.dataset.modo;\n    const tipoRegistro = document.body.dataset.tipo_registro;\n\n    const fotosPersistentesData = {{ (fotos_existentes or []) | tojson }};\n\n    const fotosPersistentes = Array.isArray(fotosPersistentesData)\n        ? fotosPersistentesData.map(f => ({\n            id: `exist-${f.id}`,\n            tipo_foto: f.tipo_foto,\n            preview: f.url,\n            esNueva: false,\n            foto_db_id: f.id,\n            eliminada: false\n        }))\n        : [];\n\n    const fotosBuffer = [];\n    const fotosEliminarIds = new Set();\n    let fotoSecuencia = 0;\n\n    const fechaInputRegistro  = document.getElementById(\"fecha_registro\");\n    const fechaPickerRegistro = document.getElementById(\"fecha_registro_picker\");\n    const btnfechaPickerRegistro = document.getElementById(\"btn_fecha_registro_picker\");\n    const contenedorEliminar = document.getElementById(\"fotos_eliminar_container\");\n\n    const hoy = new Date();\n    hoy.setHours(0, 0, 0, 0);\n    // Ajuste: obtener fecha local en formato YYYY-MM-DD para evitar desfase UTC\n    const isoHoy = new Date().toLocaleDateString('en-CA');\n    if (fechaPickerRegistro) {\n        fechaPickerRegistro.max = isoHoy;\n    }\n\n    function displayToIso(display) {\n        const match = display.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n        if (!match) return \"\";\n        const [, d, m, y] = match;\n        return `${y}-${m}-${d}`;\n    }\n    function isoToDisplay(iso) {\n        const [y, m, d] = iso.split(\"-\");\n        if (!y || !m || !d) return \"\";\n        return `${d.padStart(2,\"0\")}/${m.padStart(2,\"0\")}/${y}`;\n    }\n    function esFechaFutura(display) {\n        const match = display.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n        if (!match) return false;\n        const [, d, m, y] = match;\n        const fecha = new Date(`${y}-${m}-${d}T00:00:00`);\n        if (isNaN(fecha.getTime())) return false;\n        return fecha > hoy;\n    }\n    function abrirCalendario() {\n        if (!fechaPickerRegistro) return;\n        const iso = displayToIso(fechaInputRegistro.value.trim());\n        fechaPickerRegistro.value = iso || \"\";\n        if (fechaPickerRegistro.showPicker) fechaPickerRegistro.showPicker();\n        else fechaPickerRegistro.focus();\n    }\n    if (btnfechaPickerRegistro) {\n        btnfechaPickerRegistro.addEventListener(\"click\", (e) => {\n            e.preventDefault();\n            abrirCalendario();\n        });\n    }\n    if (fechaInputRegistro) {\n        fechaInputRegistro.addEventListener(\"focus\", () => fechaInputRegistro.select());\n        fechaInputRegistro.addEventListener(\"keydown\", (ev) => {\n            if (ev.key === \"ArrowDown\") { ev.preventDefault(); abrirCalendario(); }\n        });\n        fechaInputRegistro.addEventListener(\"blur\", () => {\n            const val = fechaInputRegistro.value.trim();\n            if (!val) { fechaInputRegistro.setCustomValidity(\"\"); return; }\n            const digits = val.replace(/\\D/g, \"\");\n            if (digits.length === 8) {\n                const d = digits.slice(0,2), m = digits.slice(2,4), y = digits.slice(4);\n                fechaInputRegistro.value = `${d}/${m}/${y}`;\n            }\n            const normalizado = fechaInputRegistro.value.trim();\n            if (!normalizado) { fechaInputRegistro.setCustomValidity(\"\"); return; }\n            if (esFechaFutura(normalizado)) {\n                fechaInputRegistro.value = \"\";\n                fechaInputRegistro.setCustomValidity(\"La fecha no puede ser futura.\");\n                fechaInputRegistro.reportValidity();\n                fechaInputRegistro.focus();\n            } else {\n                fechaInputRegistro.setCustomValidity(\"\");\n            }\n        });\n    }\n    if (fechaPickerRegistro) {\n        fechaPickerRegistro.addEventListener(\"change\", () => {\n            if (!fechaPickerRegistro.value) return;\n            const display = isoToDisplay(fechaPickerRegistro.value);\n            if (display) {\n                if (esFechaFutura(display)) {\n                    fechaPickerRegistro.value = \"\";\n                    fechaInputRegistro.value = \"\";\n                    fechaInputRegistro.setCustomValidity(\"La fecha no puede ser futura.\");\n                    fechaInputRegistro.reportValidity();\n                    fechaInputRegistro.focus();\n                    return;\n                }\n                fechaInputRegistro.value = display;\n                fechaInputRegistro.setCustomValidity(\"\");\n                fechaInputRegistro.dispatchEvent(new Event(\"input\"));\n                fechaInputRegistro.focus();\n            }\n        });\n    }\n\n    function formatearTipoFoto(texto) {\n        return texto.replace(/_/g, \" \").replace(/\\b\\w/g, c => c.toUpperCase());\n    }\n\n    function registrarFotoEliminada(id) {\n        if (fotosEliminarIds.has(id)) return;\n        fotosEliminarIds.add(id);\n        const input = document.createElement(\"input\");\n        input.type = \"hidden\";\n        input.name = \"fotos_eliminar_id\";\n        input.value = id;\n        contenedorEliminar.appendChild(input);\n    }\n\n    function sincronizarOpcionesTipoFoto() {\n        const select = document.getElementById(\"tipo_foto_visible\");\n        if (!select) return;\n        const tiposUsados = new Set();\n        fotosPersistentes.forEach(f => {\n            if (!f.eliminada) tiposUsados.add(f.tipo_foto);\n        });\n        fotosBuffer.forEach(f => tiposUsados.add(f.tipo_foto));\n\n        Array.from(select.options).forEach(option => {\n            if (!option.value) return;\n            option.disabled = tiposUsados.has(option.value);\n        });\n        if (select.value && select.options[select.selectedIndex]?.disabled) {\n            select.selectedIndex = 0;\n        }\n    }\n\n    function renderListaFotos() {\n        const lista = document.getElementById(\"lista_fotos\");\n        lista.innerHTML = \"\";\n        const fotosActivas = [];\n\n        fotosPersistentes.forEach(f => {\n            if (!f.eliminada) fotosActivas.push(f);\n        });\n        fotosBuffer.forEach(f => fotosActivas.push(f));\n\n        if (!fotosActivas.length) {\n            const vacio = document.createElement(\"li\");\n            vacio.className = \"foto-item foto-item-vacio\";\n            vacio.innerHTML = \"<i>No se han a√±adido fotos todav√≠a.</i>\";\n            lista.appendChild(vacio);\n            sincronizarOpcionesTipoFoto();\n            return;\n        }\n\n        fotosActivas.forEach(foto => {\n            const li = document.createElement(\"li\");\n            li.className = \"foto-item\";\n            li.dataset.id = foto.id;\n            li.dataset.tipoFoto = foto.tipo_foto;\n            li.dataset.esNueva = foto.esNueva ? \"1\" : \"0\";\n            if (!foto.esNueva) {\n                li.dataset.fotoDbId = foto.foto_db_id;\n            }\n\n            const figure = document.createElement(\"figure\");\n\n            const img = document.createElement(\"img\");\n            img.src = foto.preview;\n            img.alt = foto.tipo_foto;\n\n            const cap = document.createElement(\"figcaption\");\n            cap.textContent = formatearTipoFoto(foto.tipo_foto);\n\n            const btnRemove = document.createElement(\"button\");\n            btnRemove.type = \"button\";\n            btnRemove.className = \"btn-remove-foto\";\n            btnRemove.setAttribute(\"aria-label\", \"Eliminar esta foto\");\n            btnRemove.textContent = \"üóëÔ∏è\";\n            btnRemove.addEventListener(\"click\", (ev) => {\n                ev.preventDefault();\n                ev.stopPropagation();\n                eliminarFoto(foto);\n            });\n\n            figure.appendChild(img);\n            figure.appendChild(cap);\n            li.appendChild(figure);\n            li.appendChild(btnRemove);\n\n            lista.appendChild(li);\n        });\n        sincronizarOpcionesTipoFoto();\n    }\n\n    function agregarFoto() {\n        const tipo_fotoSel = document.getElementById(\"tipo_foto_visible\");\n        const tipo_foto = tipo_fotoSel.value;\n        const fileInput = document.getElementById(\"archivo_foto_visible\");\n        const file = fileInput.files[0];\n\n        if (!tipo_foto) { alert(\"Selecciona un tipo de foto.\"); return; }\n        if (!file) { alert(\"Selecciona un archivo de imagen.\"); return; }\n        if (!file.type.startsWith(\"image/\")) { alert(\"Solo se permiten archivos de imagen.\"); return; }\n\n        const tipoOcupado = fotosPersistentes.some(f => !f.eliminada && f.tipo_foto === tipo_foto)\n                         || fotosBuffer.some(f => f.tipo_foto === tipo_foto);\n        if (tipoOcupado) {\n            alert(\"Ya hay una foto con ese tipo. Elimina la existente si quieres reemplazarla.\");\n            tipo_fotoSel.focus();\n            return;\n        }\n\n        const lector = new FileReader();\n        lector.onload = (ev) => {\n            fotosBuffer.push({\n                id: ++fotoSecuencia,\n                tipo_foto,\n                file,\n                preview: ev.target.result,\n                esNueva: true\n            });\n            renderListaFotos();\n        };\n        lector.readAsDataURL(file);\n\n        tipo_fotoSel.selectedIndex = 0;\n        fileInput.value = \"\";\n    }\n\n    function eliminarFoto(foto) {\n        if (foto.esNueva) {\n            const indice = fotosBuffer.findIndex(f => f.id === foto.id);\n            if (indice >= 0) {\n                fotosBuffer.splice(indice, 1);\n            }\n        } else {\n            if (!foto.eliminada) {\n                foto.eliminada = true;\n                registrarFotoEliminada(foto.foto_db_id);\n            }\n        }\n        renderListaFotos();\n    }\n\n    renderListaFotos();\n\n    document.getElementById(\"form-crear\").addEventListener(\"submit\", async (e) => {\n        e.preventDefault();\n        const form = e.currentTarget;\n        const btn = document.getElementById(\"btn-crear\");\n        const originalText = btn.textContent;\n\n        if (fechaInputRegistro) {\n            const val = fechaInputRegistro.value.trim();\n            const regex = /^\\d{2}\\/\\d{2}\\/\\d{4}$/;\n            if (!regex.test(val)) {\n                fechaInputRegistro.setCustomValidity(\"Introduce la fecha en formato dd/mm/aaaa.\");\n                fechaInputRegistro.reportValidity();\n                return;\n            }\n            if (esFechaFutura(val)) {\n                fechaInputRegistro.setCustomValidity(\"La fecha no puede ser futura.\");\n                fechaInputRegistro.reportValidity();\n                fechaInputRegistro.focus();\n                return;\n            }\n            fechaInputRegistro.setCustomValidity(\"\");\n        }\n\n        btn.disabled = true;\n        btn.textContent = \"Guardando...\";\n\n        const fd = new FormData(form);\n        fotosBuffer.forEach(({ tipo_foto, file }) => {\n            fd.append(\"tipo_foto\", tipo_foto);\n            fd.append(\"fotos\", file, file.name);\n        });\n\n        try {\n            const resp = await fetch(form.action, { method: \"POST\", body: fd, redirect: \"follow\" });\n            if (resp.redirected) { window.location.href = resp.url; return; }\n\n            const ct = resp.headers.get(\"content-type\") || \"\";\n            const text = await resp.text();\n\n            if (resp.ok && ct.includes(\"text/html\")) {\n                document.open(); document.write(text); document.close();\n            } else if (!resp.ok) {\n                console.error(\"Error HTTP:\", resp.status, text);\n                alert(\"No se pudo guardar la mascota. C√≥digo: \" + resp.status);\n            } else {\n                window.location.href = \"{{ url_for('main.index') }}\";\n            }\n        } catch (err) {\n            console.error(err);\n            alert(\"No se pudo enviar el formulario. Revisa la consola.\");\n        } finally {\n            if (!document.hidden) {\n                btn.disabled = false;\n                btn.textContent = originalText;\n            }\n        }\n    });\n\n    if (modoFormulario === \"crear\" && tipoRegistro !== \"encontrada\") {\n        const camposVerificar = [\"nombre\", \"especie\", \"raza\"];\n        const nombreInput = document.getElementById(\"nombre\");\n        if (nombreInput && !nombreInput.disabled) {\n            camposVerificar.forEach(id => {\n                const campo = document.getElementById(id);\n                if (campo) campo.addEventListener(\"input\", verificarDuplicado);\n            });\n        } else {\n            [\"especie\",\"raza\"].forEach(id => {\n                const campo = document.getElementById(id);\n                if (campo) campo.addEventListener(\"input\", verificarDuplicado);\n            });\n        }\n    }\n\n    async function verificarDuplicado() {\n        if (modoFormulario !== \"crear\" || tipoRegistro === \"encontrada\") return;\n        const especie = (document.getElementById(\"especie\")?.value || \"\").trim();\n        const raza    = (document.getElementById(\"raza\")?.value || \"\").trim();\n        const nombreInput = document.getElementById(\"nombre\");\n        const nombre  = nombreInput && !nombreInput.disabled\n                        ? (nombreInput.value || \"\").trim()\n                        : \"encontrada\";\n\n        const fd = new FormData();\n        fd.append(\"nombre\", nombre);\n        fd.append(\"especie\", especie);\n        fd.append(\"raza\", raza);\n\n        const alertaId = \"alerta-duplicado\";\n        let alerta = document.getElementById(alertaId);\n        if (!alerta) {\n            alerta = document.createElement('div');\n            alerta.id = alertaId;\n            alerta.style.color = \"#c0392b\";\n            alerta.style.fontWeight = \"bold\";\n            alerta.style.textAlign = \"center\";\n            document.querySelector(\".container\").insertBefore(alerta, document.querySelector(\"main\"));\n        }\n\n        if (!especie || !raza) {\n            alerta.textContent = \"\";\n            habilitarFormulario(true);\n            return;\n        }\n\n        try {\n            const url = \"{{ url_for('main.verificar_mascota', tipo_registro=tipo_registro) }}\";\n            const response = await fetch(url, { method: \"POST\", body: fd });\n            const data = await response.json();\n            if (data.existe) {\n                alerta.textContent = \"‚ö†Ô∏è Ya existe una mascota con el mismo nombre/especie/raza para este tipo_registro.\";\n                habilitarFormulario(false);\n            } else {\n                alerta.textContent = \"\";\n                habilitarFormulario(true);\n            }\n        } catch (e) {\n            console.error(\"Verificaci√≥n duplicados fall√≥:\", e);\n            habilitarFormulario(true);\n        }\n    }\n\n    function habilitarFormulario(habilitar) {\n        const inputs = document.querySelectorAll(\"#form-crear input, #form-crear select, #form-crear button, #form-crear textarea\");\n        inputs.forEach(el => {\n            const id = el.getAttribute('id') || '';\n            if (![\"nombre\", \"especie\", \"raza\"].includes(id)) el.disabled = !habilitar;\n        });\n    }\n</script>\n</body>\n</html>\n\nroutes.py :\nimport os\nimport re\nimport uuid\nimport base64\nfrom collections import defaultdict\nfrom datetime import datetime, date\nfrom threading import Thread\nfrom typing import List, Dict\n\nfrom flask import (\n    Blueprint, render_template, request, redirect,\n    url_for, flash, jsonify, current_app\n)\nfrom sqlalchemy import or_, func\nfrom sqlalchemy.exc import IntegrityError\nfrom werkzeug.utils import secure_filename\n\nfrom .models import db, Mascota, FotoMascotaDesaparecida as Foto\nfrom .utils.envia_mail import send_pet_email\n\nfrom .utils.prueba_envio_facebook import send_pet_fb_message  # <-- nuevo import\nfrom .utils.publicar_fb import publish_pet_fb_post  # <-- nuevo import\n\nfrom .utils.comparar_fotos_todas import comparar_fotos_todas\nfrom .utils.identificar_raza import identificar_raza\nfrom openai import OpenAI\n\nmain = Blueprint('main', __name__)\n\n# Directorios seg√∫n tu estructura: web/templates y web/static\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\nSTATIC_DIR = os.path.join(BASE_DIR, 'static')\nUPLOAD_FOLDER = os.path.join(STATIC_DIR, 'fotos')\nos.makedirs(UPLOAD_FOLDER, exist_ok=True)\n\nALLOWED_EXTENSIONS = {\"jpg\", \"jpeg\", \"png\", \"webp\", \"gif\"}\nTIPOS_REGISTRO = {\"desaparecida\", \"encontrada\"}\nTAMANOS = {\"peque√±o\", \"mediano\", \"grande\"}\nSEXOS = {\"macho\", \"hembra\", \"no_sabe\"}\nESTADOS_APARECIDA = {\"viva\", \"muerta\"}\n\nPROMPT_IDENTIFICAR_RAZA = \"Identifica la raza del perro en esta imagen:\"\nPROMPT_COMPARAR_DOS = (\n    \"¬øSon el mismo perro o distintos? Da un porcentaje aproximado de match (0-100%) \"\n    \"y explica brevemente por qu√©.\"\n)\n\nACTIVAR_MESSENGER = os.getenv(\"ACTIVAR_MESSENGER\", \"false\").lower() == \"true\"\n\nclient = OpenAI(api_key=os.environ.get(\"OPENAI_API_KEY\"))\n\n\ndef _get_static_root() -> str:\n    try:\n        static_root = current_app.static_folder\n    except RuntimeError:\n        static_root = None\n    elegido = static_root or STATIC_DIR\n    \n    return elegido\n\n\ndef _resolver_ruta_absoluta(ruta_rel: str) -> str:\n    ruta_abs = os.path.join(_get_static_root(), ruta_rel.replace(\"/\", os.sep))\n    \n    return ruta_abs\n\n\ndef _extraer_ruta_absoluta_payload(info: dict | None) -> str | None:\n    \"\"\"\n    Dado el diccionario de una foto enviado desde el frontend, intenta obtener\n    la ruta absoluta en disco. Soporta distintos nombres de campo y rutas\n    relativas (ej. 'static/fotos/...', '/static/...', 'fotos/...').\n    \"\"\"\n    if not info or not isinstance(info, dict):\n        return None\n\n    posibles_claves = [\n        \"ruta_abs\",\n        \"ruta_absoluta\",\n        \"ruta\",\n        \"ruta_rel\",\n        \"ruta_relativa\",\n        \"path\",\n        \"filepath\",\n        \"file_path\",\n        \"url\",\n    ]\n\n    for clave in posibles_claves:\n        valor = info.get(clave)\n        if not valor or not isinstance(valor, str):\n            continue\n        ruta = valor.strip()\n        if not ruta:\n            continue\n\n        # Si ya viene en absoluto y existe, usarla directamente.\n        if os.path.isabs(ruta) and os.path.isfile(ruta):\n            return ruta\n\n        ruta_norm = normalizar_ruta_foto(ruta)\n        if ruta_norm:\n            ruta_abs = _resolver_ruta_absoluta(ruta_norm)\n            if os.path.isfile(ruta_abs):\n                return ruta_abs\n\n    return None\n\n\ndef allowed_file(filename: str) -> bool:\n    return \".\" in filename and filename.rsplit(\".\", 1)[1].lower() in ALLOWED_EXTENSIONS\n\n\ndef image_to_data_url(path):\n    name = os.path.basename(path).lower()\n    if name.endswith(\".png\"):\n        mime = \"image/png\"\n    elif name.endswith((\".jpg\", \".jpeg\")):\n        mime = \"image/jpeg\"\n    elif name.endswith(\".gif\"):\n        mime = \"image/gif\"\n    elif name.endswith(\".webp\"):\n        mime = \"image/webp\"\n    else:\n        mime = \"image/jpeg\"\n    with open(path, \"rb\") as f:\n        b64 = base64.b64encode(f.read()).decode(\"utf-8\")\n    return f\"data:{mime};base64,{b64}\"\n\n\ndef parse_fecha(fecha_str: str | None) -> date | None:\n    if not fecha_str:\n        return None\n    fecha_str = fecha_str.strip()\n    for fmt in (\"%d/%m/%Y\", \"%Y-%m-%d\"):\n        try:\n            return datetime.strptime(fecha_str, fmt).date()\n        except ValueError:\n            continue\n    return None\n\n\ndef normalizar_ruta_foto(ruta: str | None) -> str | None:\n    if not ruta:\n        return None\n    ruta = ruta.strip().replace(\"\\\\\", \"/\")\n    partes = [p for p in ruta.split(\"/\") if p]\n    if not partes:\n        return None\n    partes_lower = [p.lower() for p in partes]\n    if \"static\" in partes_lower:\n        idx = partes_lower.index(\"static\")\n        partes = partes[idx + 1:]\n        partes_lower = partes_lower[idx + 1:]\n    if \"fotos\" in partes_lower:\n        idx = partes_lower.index(\"fotos\")\n        partes = partes[idx:]\n    ruta_normalizada = \"/\".join(partes)\n    return ruta_normalizada or None\n\n\ndef eliminar_archivo_relativo(ruta_rel: str | None) -> None:\n    if not ruta_rel:\n        return\n    ruta_norm = normalizar_ruta_foto(ruta_rel)\n    if not ruta_norm:\n        return\n    ruta_abs = _resolver_ruta_absoluta(ruta_norm)\n   \n    try:\n        if os.path.isfile(ruta_abs):\n            os.remove(ruta_abs)\n    except OSError:\n        current_app.logger.warning(\"No se pudo eliminar el archivo de foto %s\", ruta_abs)\n\n\ndef eliminar_foto_obj(foto: Foto | None) -> None:\n    if not foto:\n        return\n    eliminar_archivo_relativo(foto.ruta)\n    db.session.delete(foto)\n\n\ndef obtener_fotos_existentes(mascota: Mascota) -> List[Dict[str, str]]:\n    fotos_serializadas: List[Dict[str, str]] = []\n    for foto in getattr(mascota, \"fotos\", []):\n        ruta_rel = normalizar_ruta_foto(foto.ruta)\n        if not ruta_rel:\n            continue\n        fotos_serializadas.append({\n            \"id\": foto.id,\n            \"tipo_foto\": foto.tipo_foto,\n            \"ruta\": f\"static/{ruta_rel}\",\n            \"url\": url_for(\"static\", filename=ruta_rel)\n        })\n    return fotos_serializadas\n\n\ndef _construir_mascotas_con_fotos(mascotas):\n    resultado = []\n    for mascota in mascotas:\n        fotos = Foto.query.filter_by(mascota_id=mascota.id).all()\n        fotos_info = []\n        for foto in fotos:\n            ruta_relativa = normalizar_ruta_foto(foto.ruta)\n            if ruta_relativa:\n                fotos_info.append({\n                    \"id\": foto.id,\n                    \"tipo_foto\": foto.tipo_foto,\n                    \"ruta\": f\"static/{ruta_relativa}\",\n                    \"url\": url_for(\"static\", filename=ruta_relativa)\n                })\n        resultado.append((mascota, fotos_info))\n    return resultado\n\n\ndef _es_mascota_desaparecida_valida(mascota: Mascota | None) -> bool:\n    if not mascota or (mascota.tipo_registro or \"\").lower() != \"desaparecida\":\n        return False\n    if not (mascota.propietario_email and mascota.propietario_email.strip()):\n        return False\n    if mascota.fecha_aparecida is not None:\n        return False\n    estado = (mascota.estado_aparecida or \"\").strip()\n    if estado:\n        return False\n    return True\n\n\ndef _serializar_foto(foto: Foto) -> Dict[str, str] | None:\n    ruta_rel = normalizar_ruta_foto(foto.ruta)\n    \n    if not ruta_rel:\n        print(f\"[DEBUG] _serializar_foto: foto_id={foto.id}, descartada (sin ruta normalizada)\")\n        return None\n    ruta_abs = _resolver_ruta_absoluta(ruta_rel)\n    existe = os.path.isfile(ruta_abs)\n    \n    if not existe:\n        return None\n    tipo = (foto.tipo_foto or \"desconocido\").strip().lower() or \"desconocido\"\n    return {\n        \"id\": foto.id,\n        \"tipo_foto\": tipo,\n        \"ruta_rel\": ruta_rel,\n        \"ruta_abs\": ruta_abs,\n        \"url\": url_for(\"static\", filename=ruta_rel),\n    }\n\n\ndef _obtener_fotos_validas(mascota: Mascota | None) -> List[Dict[str, str]]:\n    if not mascota:\n        return []\n    fotos_validas: List[Dict[str, str]] = []\n    for foto in getattr(mascota, \"fotos\", []):\n        datos = _serializar_foto(foto)\n        if datos:\n            fotos_validas.append(datos)\n    return fotos_validas\n\n\ndef _agrupar_fotos_por_tipo(fotos: List[Dict[str, str]]) -> Dict[str, List[Dict[str, str]]]:\n    agrupado: dict[str, list[dict[str, str]]] = defaultdict(list)\n    for foto in fotos:\n        agrupado[foto[\"tipo_foto\"]].append(foto)\n    return dict(agrupado)\n\n\ndef _comparar_imagenes_openai(prompt: str, data_urls: List[str]) -> str:\n    mensajes = [{\"type\": \"text\", \"text\": prompt}]\n    for data_url in data_urls:\n        mensajes.append({\"type\": \"image_url\", \"image_url\": {\"url\": data_url}})\n    respuesta = client.chat.completions.create(\n        model=\"gpt-5\",\n        messages=[{\"role\": \"user\", \"content\": mensajes}]\n    )\n    return respuesta.choices[0].message.content\n\n\ndef _cargar_smtp_env(app) -> None:\n    app.config[\"SMTP_SERVER\"] = os.getenv(\"SMTP_SERVER\", \"\")\n    app.config[\"SMTP_PORT\"] = int(os.getenv(\"SMTP_PORT\", \"587\"))\n    app.config[\"SMTP_USERNAME\"] = os.getenv(\"SMTP_USERNAME\", \"\")\n    app.config[\"SMTP_PASSWORD\"] = os.getenv(\"SMTP_PASSWORD\", \"\")\n    app.config[\"SMTP_TO_EMAIL\"] = os.getenv(\"SMTP_TO_EMAIL\", \"\")\n\n\ndef _programar_envio_correo(mascota_id: int) -> None:\n    try:\n        app = current_app._get_current_object()\n        _cargar_smtp_env(app)\n        Thread(\n            target=_worker_enviar_correo,\n            args=(app, mascota_id),\n            daemon=True\n        ).start()\n    except Exception:\n        current_app.logger.exception(\n            \"No se pudo programar el env√≠o de correo para la mascota %s\", mascota_id\n        )\n\ndef _worker_enviar_correo(app, mascota_id: int) -> None:\n    with app.app_context():\n        mascota = Mascota.query.get(mascota_id)\n        if not mascota:\n            current_app.logger.error(\n                \"No se encontr√≥ la mascota %s para enviar correo.\", mascota_id\n            )\n            return\n\n        subject = (\n            f\"üê∂üê± mascota {(mascota.tipo_registro or '').strip()}\".strip() or \"Mascota\"\n        )\n        datos_email = _construir_datos_email(mascota)\n        fotos_email = _obtener_rutas_fotos(mascota)\n        destinatarios_extra = _calcular_destinatarios_extra(mascota)\n\n        ok_email = send_pet_email(\n            subject,\n            datos_email,\n            fotos_email,\n            destinatarios_extra=destinatarios_extra,\n        )\n        if not ok_email:\n            current_app.logger.error(\n                \"Fallo al enviar correo autom√°tico de mascota %s\", mascota_id\n            )\n\n        if ACTIVAR_MESSENGER:\n            ok_fb = send_pet_fb_message(\n                subject,\n                datos_email,\n                fotos_email,\n                destinatarios_extra=destinatarios_extra,\n            )\n            if not ok_fb:\n                current_app.logger.error(\n                    \"Fallo al enviar mensaje de Facebook de mascota %s\", mascota_id\n                )\n        else:\n            current_app.logger.info(\n                \"Messenger desactivado; no se env√≠a mensaje para la mascota %s\",\n                mascota_id,\n            )\n\n        ok_fb_post = publish_pet_fb_post(subject, datos_email, fotos_email)\n        if not ok_fb_post:\n            current_app.logger.error(\n                \"Fallo al publicar en el feed de Facebook de la mascota %s\", mascota_id\n            )\n\n\ndef _construir_datos_email(mascota: Mascota) -> Dict[str, object]:\n    return {\n        \"ID\": mascota.id,\n        \"Tipo de registro\": mascota.tipo_registro,\n        \"Nombre\": mascota.nombre,\n        \"Especie\": mascota.especie,\n        \"Raza\": mascota.raza,\n        \"Edad\": mascota.edad,\n        \"Zona\": mascota.zona,\n        \"Email contacto\": mascota.propietario_email,\n        \"Tel√©fono contacto\": mascota.propietario_telefono,\n        \"Color\": mascota.color,\n        \"Sexo\": mascota.sexo,\n        \"Chip\": mascota.chip,\n        \"Peso\": mascota.peso,\n        \"Tama√±o\": mascota.tamano,\n        \"Descripci√≥n\": mascota.descripcion,\n        \"Fecha registro\": mascota.fecha_registro,\n        \"Fecha aparecida\": mascota.fecha_aparecida,\n        \"Estado aparecida\": mascota.estado_aparecida,\n    }\n\n\ndef _obtener_rutas_fotos(mascota: Mascota) -> List[str]:\n    rutas: List[str] = []\n    for foto in getattr(mascota, \"fotos\", []):\n        ruta_rel = normalizar_ruta_foto(foto.ruta)\n        if not ruta_rel:\n            continue\n        ruta_abs = _resolver_ruta_absoluta(ruta_rel)\n        if os.path.isfile(ruta_abs):\n            rutas.append(ruta_abs)\n        else:\n            current_app.logger.warning(\n                \"Foto no encontrada en disco: %s (mascota %s)\", ruta_abs, mascota.id\n            )\n    return rutas\n\n\ndef _calcular_destinatarios_extra(mascota: Mascota) -> List[str]:\n    destinatarios: List[str] = []\n    correo_propietario = (mascota.propietario_email or \"\").strip()\n    if correo_propietario:\n        destinatarios.append(correo_propietario)\n\n    if (mascota.tipo_registro or \"\").lower() == \"encontrada\":\n        registros_previos = (\n            Mascota.query.with_entities(Mascota.propietario_email)\n            .filter(\n                Mascota.tipo_registro == \"desaparecida\",\n                Mascota.fecha_registro <= mascota.fecha_registro,\n                Mascota.fecha_aparecida.is_(None),\n                Mascota.propietario_email.isnot(None),\n                Mascota.propietario_email != \"\",\n            )\n            .distinct()\n            .all()\n        )\n\n        for (correo,) in registros_previos:\n            correo_norm = (correo or \"\").strip()\n            if correo_norm and correo_norm not in destinatarios:\n                destinatarios.append(correo_norm)\n\n    return destinatarios\n\n\ndef construir_filtros_generales(form) -> Dict[str, str]:\n    return {\n        \"tipo_registro\": (form.get(\"tipo_registro\") or \"\").lower(),\n        \"nombre\": (form.get(\"nombre\") or \"\").strip(),\n        \"especie\": (form.get(\"especie\") or \"\").strip(),\n        \"raza\": (form.get(\"raza\") or \"\").strip(),\n        \"zona\": (form.get(\"zona\") or \"\").strip(),\n        \"color\": (form.get(\"color\") or \"\").strip(),\n        \"tamano\": (form.get(\"tamano\") or \"\").strip().lower(),\n        \"descripcion\": (form.get(\"descripcion\") or \"\").strip(),\n        \"sexo\": (form.get(\"sexo\") or \"\").strip().lower(),\n        \"chip\": (form.get(\"chip\") or \"\").strip(),\n        \"peso\": (form.get(\"peso\") or \"\").strip(),\n        \"edad\": (form.get(\"edad\") or \"\").strip(),\n        \"propietario_email\": (form.get(\"propietario_email\") or \"\").strip(),\n        \"propietario_telefono\": (form.get(\"propietario_telefono\") or \"\").strip(),\n        \"fecha_registro\": (form.get(\"fecha_registro\") or \"\").strip(),\n        \"fecha_aparecida\": (form.get(\"fecha_aparecida\") or \"\").strip(),\n        \"estado_aparecida\": (form.get(\"estado_aparecida\") or \"\").strip().lower(),\n    }\n\n\ndef aplicar_filtros_generales(query, filtros: Dict[str, str]):\n    if filtros[\"tipo_registro\"] in TIPOS_REGISTRO:\n        query = query.filter(Mascota.tipo_registro == filtros[\"tipo_registro\"])\n\n    if filtros[\"nombre\"]:\n        query = query.filter(Mascota.nombre.ilike(f\"%{filtros['nombre']}%\"))\n\n    if filtros[\"especie\"]:\n        query = query.filter(Mascota.especie.ilike(f\"%{filtros['especie']}%\"))\n\n    if filtros[\"raza\"]:\n        query = query.filter(Mascota.raza.ilike(f\"%{filtros['raza']}%\"))\n\n    if filtros[\"zona\"]:\n        query = query.filter(Mascota.zona.ilike(f\"%{filtros['zona']}%\"))\n\n    if filtros[\"color\"]:\n        query = query.filter(Mascota.color.ilike(f\"%{filtros['color']}%\"))\n\n    if filtros[\"tamano\"] in TAMANOS:\n        query = query.filter(Mascota.tamano == filtros[\"tamano\"])\n\n    if filtros[\"descripcion\"]:\n        query = query.filter(Mascota.descripcion.ilike(f\"%{filtros['descripcion']}%\"))\n\n    if filtros[\"sexo\"] in SEXOS:\n        query = query.filter(Mascota.sexo == filtros[\"sexo\"])\n\n    if filtros[\"chip\"]:\n        query = query.filter(Mascota.chip.ilike(f\"%{filtros['chip']}%\"))\n\n    if filtros[\"peso\"]:\n        try:\n            peso_val = float(filtros[\"peso\"].replace(\",\", \".\"))\n            query = query.filter(Mascota.peso == peso_val)\n        except ValueError:\n            flash(\"Peso inv√°lido. Usa n√∫meros (puedes emplear coma o punto).\", \"error\")\n\n    if filtros[\"edad\"].isdigit():\n        query = query.filter(Mascota.edad == int(filtros[\"edad\"]))\n\n    if filtros[\"propietario_email\"]:\n        query = query.filter(Mascota.propietario_email.ilike(f\"%{filtros['propietario_email']}%\"))\n\n    if filtros[\"propietario_telefono\"]:\n        query = query.filter(Mascota.propietario_telefono.ilike(f\"%{filtros['propietario_telefono']}%\"))\n\n    if filtros[\"fecha_registro\"]:\n        fecha_filtrada = parse_fecha(filtros[\"fecha_registro\"])\n        if fecha_filtrada:\n            query = query.filter(Mascota.fecha_registro == fecha_filtrada)\n        else:\n            flash(\"Formato de fecha de registro inv√°lido. Usa dd/mm/aaaa.\", \"error\")\n\n    if filtros[\"fecha_aparecida\"]:\n        fecha_ap = parse_fecha(filtros[\"fecha_aparecida\"])\n        if fecha_ap:\n            query = query.filter(Mascota.fecha_aparecida == fecha_ap)\n        else:\n            flash(\"Formato de fecha de aparici√≥n inv√°lido.\", \"error\")\n\n    if filtros[\"estado_aparecida\"] in ESTADOS_APARECIDA:\n        query = query.filter(Mascota.estado_aparecida == filtros[\"estado_aparecida\"])\n\n    return query\n\n\n@main.route(\"/\")\ndef index():\n    return render_template(\"index.html\")\n\n@main.route(\"/crear_mascota\", methods=[\"GET\", \"POST\"])\n@main.route(\"/mascotas/<int:mascota_id>/editar\", methods=[\"GET\", \"POST\"])\ndef crear_mascota(mascota_id=None):\n    edit_mode = mascota_id is not None\n    mascota = None\n\n    if edit_mode:\n        mascota = Mascota.query.get_or_404(mascota_id)\n        tipo_registro = (mascota.tipo_registro or \"desaparecida\").lower()\n    else:\n        tipo_registro = (request.args.get(\"tipo_registro\") or \"desaparecida\").lower()\n        if tipo_registro not in TIPOS_REGISTRO:\n            flash(\"Tipo de registro inv√°lido.\", \"error\")\n            return redirect(url_for(\"main.index\"))\n\n    if request.method == \"POST\":\n        print(\"[DBG CREAR] POST recibido:\",\n              \"args.tipo_registro=\", request.args.get(\"tipo_registro\"),\n              \"form.tipo_registro=\", request.form.get(\"tipo_registro\"))\n\n        tipo_registro_form = (request.form.get(\"tipo_registro\") or '').strip().lower()\n        if edit_mode and tipo_registro_form in TIPOS_REGISTRO:\n            tipo_registro = tipo_registro_form\n        elif not edit_mode and tipo_registro_form:\n            tipo_registro = tipo_registro_form\n\n        if not edit_mode and tipo_registro not in TIPOS_REGISTRO:\n            flash(\"Tipo de registro inv√°lido.\", \"error\")\n            return redirect(url_for(\"main.index\"))\n\n        nombre = (request.form.get(\"nombre\") or \"\").strip()\n        especie = (request.form.get(\"especie\") or \"\").strip()\n        raza = (request.form.get(\"raza\") or \"\").strip()\n        edad = (request.form.get(\"edad\") or \"\").strip()\n        propietario_email = (request.form.get(\"propietario_email\") or \"\").strip()\n        propietario_telefono = (request.form.get(\"propietario_telefono\") or \"\").strip()\n        zona = (request.form.get(\"zona\") or \"\").strip()\n        color = (request.form.get(\"color\") or \"\").strip()\n        sexo = (request.form.get(\"sexo\") or \"\").strip().lower()\n        chip = (request.form.get(\"chip\") or \"\").strip()\n        peso = (request.form.get(\"peso\") or \"\").strip()\n        tamano = (request.form.get(\"tamano\") or \"\").strip().lower()\n        descripcion = (request.form.get(\"descripcion\") or \"\").strip()\n        fecha_registro_str = (request.form.get(\"fecha_registro\") or \"\").strip()\n\n        if tipo_registro == \"encontrada\" and sexo not in SEXOS:\n            sexo = \"no_sabe\"\n            print(\"[DBG CREAR] sexo vac√≠o en encontrada -> forzado a 'no_sabe'\")\n\n        print(\"[DBG CREAR] Campos crudos:\",\n              \"nombre=\", repr(nombre),\n              \"especie=\", repr(especie),\n              \"raza=\", repr(raza),\n              \"zona=\", repr(zona),\n              \"color=\", repr(color),\n              \"sexo=\", repr(sexo),\n              \"tamano=\", repr(tamano),\n              \"email=\", repr(propietario_email),\n              \"tel=\", repr(propietario_telefono),\n              \"fecha_registro=\", repr(fecha_registro_str))\n\n        if tipo_registro == \"encontrada\":\n            nombre = \"encontrada\"\n\n        print(\"[DBG CREAR] Tipo y nombre efectivos:\",\n              \"tipo_registro=\", tipo_registro,\n              \"nombre=\", nombre)\n\n        if not nombre:\n            flash(\"El nombre de la mascota es obligatorio.\", \"error\")\n            return redirect(request.url)\n\n        if not especie or not color or sexo not in SEXOS or tamano not in TAMANOS:\n            flash(\"Faltan datos obligatorios (especie, color, sexo, tama√±o).\", \"error\")\n            return redirect(request.url)\n\n        edad_val = int(edad) if edad.isdigit() else None\n\n        peso_val = None\n        if peso:\n            try:\n                peso_val = float(peso.replace(\",\", \".\"))\n            except ValueError:\n                flash(\"Peso inv√°lido. Usa n√∫meros (puedes emplear coma o punto).\", \"error\")\n                return redirect(request.url)\n\n        fecha_registro = parse_fecha(fecha_registro_str)\n        if not fecha_registro:\n            fecha_registro = mascota.fecha_registro if edit_mode and mascota.fecha_registro else datetime.utcnow().date()\n\n        print(\"[DBG CREAR] Normalizados:\",\n              \"especie=\", repr(especie),\n              \"raza=\", repr(raza),\n              \"zona=\", repr(zona),\n              \"color=\", repr(color),\n              \"sexo=\", repr(sexo),\n              \"tamano=\", repr(tamano),\n              \"fecha_registro=\", fecha_registro)\n        print(\"[DBG CREAR] Obligatorios presentes?\",\n              \"zona=\", bool(zona),\n              \"email=\", bool(propietario_email),\n              \"tel=\", bool(propietario_telefono))\n\n        email_norm = (propietario_email or \"\").strip().lower()\n        dup_q = Mascota.query.filter_by(\n            propietario_email=email_norm,\n            tipo_registro=tipo_registro,\n            nombre=(nombre or \"\").strip().lower(),\n            zona=(zona or \"\").strip().lower(),\n            especie=(especie or \"\").strip().lower(),\n            color=(color or \"\").strip().lower(),\n            tamano=(tamano or \"\").strip().lower(),\n            fecha_registro=fecha_registro\n        )\n        if edit_mode:\n            dup_q = dup_q.filter(Mascota.id != mascota.id)\n\n        try:\n            dup_count = dup_q.count()\n        except Exception as e:\n            dup_count = f\"error count: {e}\"\n        print(\"[DBG CREAR] Duplicados (clave UNIQUE) encontrados:\", dup_count)\n\n        if dup_q.first():\n            print(\"[DBG CREAR] BLOQUEADO por duplicado seg√∫n clave UNIQUE\")\n            flash(\"Ya existe un registro igual (email, tipo, nombre, zona, especie, color, tama√±o y fecha).\", \"error\")\n            return redirect(request.url)\n\n        if edit_mode:\n            mascota.tipo_registro = tipo_registro\n            mascota.nombre = nombre\n            mascota.especie = especie\n            mascota.raza = raza or None\n            mascota.edad = edad_val\n            mascota.propietario_email = propietario_email or None\n            mascota.propietario_telefono = propietario_telefono or None\n            mascota.zona = zona or None\n            mascota.color = color\n            mascota.descripcion = descripcion or None\n            mascota.chip = chip or None\n            mascota.sexo = sexo\n            mascota.peso = peso_val\n            mascota.tamano = tamano\n            mascota.fecha_registro = fecha_registro\n        else:\n            mascota = Mascota(\n                tipo_registro=tipo_registro,\n                nombre=nombre,\n                especie=especie,\n                raza=raza or None,\n                edad=edad_val,\n                propietario_email=propietario_email or None,\n                propietario_telefono=propietario_telefono or None,\n                zona=zona or None,\n                color=color,\n                descripcion=descripcion or None,\n                chip=chip or None,\n                sexo=sexo,\n                peso=peso_val,\n                tamano=tamano,\n                fecha_registro=fecha_registro\n            )\n            db.session.add(mascota)\n\n        print(\"[DBG CREAR] Antes de flush: mascota.id=\", getattr(mascota, \"id\", None))\n        try:\n            db.session.flush()\n        except IntegrityError as exc:\n            print(\"[DBG CREAR] IntegrityError en flush:\", repr(exc))\n            try:\n                print(\"[DBG CREAR] IntegrityError.orig:\", getattr(exc, \"orig\", None))\n                if getattr(exc, \"orig\", None) is not None and hasattr(exc.orig, \"args\"):\n                    print(\"[DBG CREAR] IntegrityError.orig.args:\", exc.orig.args)\n            except Exception:\n                pass\n            db.session.rollback()\n            flash(\"Error de integridad al guardar la mascota (posible duplicado).\", \"error\")\n            return redirect(request.url)\n\n        fotos_eliminar_ids = request.form.getlist(\"fotos_eliminar_id\")\n        if edit_mode and fotos_eliminar_ids:\n            for foto_id in fotos_eliminar_ids:\n                if not foto_id.isdigit():\n                    continue\n                foto_obj = Foto.query.filter_by(id=int(foto_id), mascota_id=mascota.id).first()\n                if foto_obj:\n                    eliminar_foto_obj(foto_obj)\n\n        existing_photos_by_type = {}\n        if edit_mode:\n            for foto in list(mascota.fotos):\n                if foto in db.session.deleted:\n                    continue\n                existing_photos_by_type[foto.tipo_foto] = foto\n\n        fotos = request.files.getlist(\"fotos\")\n        tipos_foto = request.form.getlist(\"tipo_foto\")\n        print(\"[DBG CREAR] files.fotos len=\", len(fotos),\n              \"tipos_foto len=\", len(tipos_foto))\n        print(\"[DBG CREAR] tipos_foto=\", tipos_foto)\n\n        nuevas_rutas_guardadas: List[str] = []\n\n        for idx, archivo in enumerate(fotos):\n            if not archivo or not archivo.filename:\n                continue\n            if not allowed_file(archivo.filename):\n                flash(f\"Archivo '{archivo.filename}' ignorado: formato no permitido.\", \"warning\")\n                continue\n\n            tipo_actual = tipos_foto[idx] if idx < len(tipos_foto) else \"\"\n            tipo_actual = (tipo_actual or \"desconocido\").strip().lower()\n\n            if edit_mode and tipo_actual in existing_photos_by_type:\n                eliminar_foto_obj(existing_photos_by_type[tipo_actual])\n                existing_photos_by_type.pop(tipo_actual, None)\n\n            nombre_seguro = secure_filename(\n                f\"{mascota.id}_{tipo_actual}_{uuid.uuid4().hex}_{archivo.filename}\"\n            )\n            ruta_fs = os.path.join(UPLOAD_FOLDER, nombre_seguro)\n            archivo.save(ruta_fs)\n            nuevas_rutas_guardadas.append(ruta_fs)\n\n            ruta_relativa = normalizar_ruta_foto(f\"fotos/{nombre_seguro}\")\n\n            db.session.add(\n                Foto(\n                    mascota_id=mascota.id,\n                    tipo_foto=tipo_actual,\n                    ruta=ruta_relativa\n                )\n            )\n\n        print(\"[DBG CREAR] Antes de commit: mascota.id=\", getattr(mascota, \"id\", None))\n        try:\n            db.session.commit()\n        except IntegrityError as exc:\n            print(\"[DBG CREAR] IntegrityError en commit:\", repr(exc))\n            try:\n                print(\"[DBG CREAR] IntegrityError.orig:\", getattr(exc, \"orig\", None))\n                if getattr(exc, \"orig\", None) is not None and hasattr(exc.orig, \"args\"):\n                    print(\"[DBG CREAR] IntegrityError.orig.args:\", exc.orig.args)\n            except Exception:\n                pass\n            db.session.rollback()\n            for ruta_guardada in nuevas_rutas_guardadas:\n                try:\n                    if os.path.isfile(ruta_guardada):\n                        os.remove(ruta_guardada)\n                except OSError:\n                    current_app.logger.warning(\"No se pudo eliminar archivo %s tras fallo de commit.\", ruta_guardada)\n            flash(\"No se pudo guardar los datos de la mascota por un conflicto de integridad.\", \"error\")\n            return redirect(request.url)\n        except Exception as exc:\n            db.session.rollback()\n            for ruta_guardada in nuevas_rutas_guardadas:\n                try:\n                    if os.path.isfile(ruta_guardada):\n                        os.remove(ruta_guardada)\n                except OSError:\n                    current_app.logger.warning(\"No se pudo eliminar archivo %s tras fallo de commit.\", ruta_guardada)\n            current_app.logger.exception(\"Error al guardar la mascota: %s\", exc)\n            flash(\"Ocurri√≥ un error al guardar la mascota.\", \"error\")\n            return redirect(request.url)\n\n        print(\"[DBG CREAR] Mascota creada/actualizada OK. id=\", mascota.id, \"tipo=\", mascota.tipo_registro)\n\n        if edit_mode:\n            flash(\"Mascota actualizada correctamente.\", \"success\")\n            _programar_envio_correo(mascota.id)\n            return redirect(url_for(\"main.modificar_mascotas\"))\n        else:\n            flash(f\"Mascota {tipo_registro} registrada correctamente.\", \"success\")\n            _programar_envio_correo(mascota.id)\n            return redirect(url_for(\"main.index\"))\n\n    fotos_existentes = obtener_fotos_existentes(mascota) if edit_mode else []\n    form_action = (\n        url_for(\"main.crear_mascota\", mascota_id=mascota.id)\n        if edit_mode else\n        url_for(\"main.crear_mascota\", tipo_registro=tipo_registro)\n    )\n\n    return render_template(\n        \"crear_mascota.html\",\n        tipo_registro=tipo_registro,\n        modo=\"modificar\" if edit_mode else \"crear\",\n        mascota=mascota,\n        fotos_existentes=fotos_existentes,\n        form_action=form_action\n    )\n\n\n@main.route(\"/mascotas/<int:mascota_id>/eliminar\", methods=[\"POST\"])\ndef eliminar_mascota(mascota_id):\n    mascota = Mascota.query.get_or_404(mascota_id)\n\n    for foto in list(mascota.fotos):\n        eliminar_foto_obj(foto)\n\n    try:\n        db.session.delete(mascota)\n        db.session.commit()\n    except Exception as exc:\n        db.session.rollback()\n        current_app.logger.exception(\"Error al eliminar mascota %s: %s\", mascota_id, exc)\n        flash(\"No se pudo eliminar la mascota.\", \"error\")\n        return redirect(url_for(\"main.modificar_mascotas\"))\n\n    flash(\"Mascota eliminada correctamente.\", \"success\")\n    return redirect(url_for(\"main.modificar_mascotas\"))\n\n\n@main.route(\"/buscar_mascotas\", methods=[\"GET\", \"POST\"])\ndef buscar_mascotas():\n    busqueda_realizada = request.method == \"POST\"\n    mensaje = None\n    mascotas_con_fotos = []\n    filtros = {}\n\n    query = Mascota.query\n\n    if request.method == \"POST\":\n        filtros = {\n            \"tipo_registro\": (request.form.get(\"tipo_registro\") or \"\").lower(),\n            \"nombre\": (request.form.get(\"nombre\") or \"\").strip(),\n            \"especie\": (request.form.get(\"especie\") or \"\").strip(),\n            \"raza\": (request.form.get(\"raza\") or \"\").strip(),\n            \"edad\": (request.form.get(\"edad\") or \"\").strip(),\n            \"propietario_email\": (request.form.get(\"propietario_email\") or \"\").strip(),\n            \"propietario_telefono\": (request.form.get(\"propietario_telefono\") or \"\").strip(),\n            \"zona\": (request.form.get(\"zona\") or \"\").strip(),\n            \"color\": (request.form.get(\"color\") or \"\").strip(),\n            \"sexo\": (request.form.get(\"sexo\") or \"\").lower().strip(),\n            \"chip\": (request.form.get(\"chip\") or \"\").strip(),\n            \"tamano\": (request.form.get(\"tamano\") or \"\").lower().strip(),\n            \"peso\": (request.form.get(\"peso\") or \"\").strip(),\n            \"fecha_registro\": (request.form.get(\"fecha_registro\") or \"\").strip(),\n            \"fecha_aparecida\": (request.form.get(\"fecha_aparecida\") or \"\").strip(),\n            \"estado_aparecida\": (request.form.get(\"estado_aparecida\") or \"\").lower().strip(),\n            \"descripcion\": (request.form.get(\"descripcion\") or \"\").strip(),\n        }\n\n        if filtros[\"tipo_registro\"] in TIPOS_REGISTRO:\n            query = query.filter(Mascota.tipo_registro == filtros[\"tipo_registro\"])\n\n        if filtros[\"nombre\"]:\n            query = query.filter(Mascota.nombre.ilike(f\"%{filtros['nombre']}%\"))\n\n        if filtros[\"especie\"]:\n            query = query.filter(Mascota.especie.ilike(f\"%{filtros['especie']}%\"))\n\n        if filtros[\"raza\"]:\n            query = query.filter(Mascota.raza.ilike(f\"%{filtros['raza']}%\"))\n\n        if filtros[\"edad\"].isdigit():\n            query = query.filter(Mascota.edad == int(filtros[\"edad\"]))\n\n        if filtros[\"propietario_email\"]:\n            query = query.filter(Mascota.propietario_email.ilike(f\"%{filtros['propietario_email']}%\"))\n\n        if filtros[\"propietario_telefono\"]:\n            query = query.filter(Mascota.propietario_telefono.ilike(f\"%{filtros['propietario_telefono']}%\"))\n\n        if filtros[\"zona\"]:\n            query = query.filter(Mascota.zona.ilike(f\"%{filtros['zona']}%\"))\n\n        if filtros[\"color\"]:\n            query = query.filter(Mascota.color.ilike(f\"%{filtros['color']}%\"))\n\n        if filtros[\"sexo\"] in SEXOS:\n            query = query.filter(Mascota.sexo == filtros[\"sexo\"])\n\n        if filtros[\"chip\"]:\n            query = query.filter(Mascota.chip.ilike(f\"%{filtros['chip']}%\"))\n\n        if filtros[\"tamano\"] in TAMANOS:\n            query = query.filter(Mascota.tamano == filtros[\"tamano\"])\n\n        if filtros[\"peso\"]:\n            try:\n                peso_val = float(filtros[\"peso\"].replace(\",\", \".\"))\n                query = query.filter(Mascota.peso == peso_val)\n            except ValueError:\n                flash(\"Peso inv√°lido. Usa n√∫meros (puedes emplear coma o punto).\", \"error\")\n\n        if filtros[\"fecha_registro\"]:\n            fecha_filtrada = parse_fecha(filtros[\"fecha_registro\"])\n            if fecha_filtrada:\n                query = query.filter(Mascota.fecha_registro == fecha_filtrada)\n            else:\n                flash(\"Formato de fecha de registro inv√°lido. Usa dd/mm/aaaa.\", \"error\")\n\n        if filtros[\"fecha_aparecida\"]:\n            fecha_ap = parse_fecha(filtros[\"fecha_aparecida\"])\n            if fecha_ap:\n                query = query.filter(Mascota.fecha_aparecida == fecha_ap)\n            else:\n                flash(\"Formato de fecha de aparici√≥n inv√°lido.\", \"error\")\n\n        if filtros[\"estado_aparecida\"] in ESTADOS_APARECIDA:\n            query = query.filter(Mascota.estado_aparecida == filtros[\"estado_aparecida\"])\n\n        if filtros[\"descripcion\"]:\n            query = query.filter(Mascota.descripcion.ilike(f\"%{filtros['descripcion']}%\"))\n\n    mascotas = query.order_by(Mascota.fecha_registro.desc()).all()\n\n    if busqueda_realizada:\n        if not mascotas:\n            mensaje = \"No se encontraron mascotas.\"\n        else:\n            mascotas_con_fotos = _construir_mascotas_con_fotos(mascotas)\n\n    return render_template(\n        \"buscar.html\",\n        modo=\"buscar\",\n        mascotas=mascotas,\n        filtros=filtros,\n        busqueda_realizada=busqueda_realizada,\n        mensaje=mensaje,\n        mascotas_con_fotos=mascotas_con_fotos,\n    )\n\n\n@main.route(\"/modificar_mascotas\", methods=[\"GET\", \"POST\"])\ndef modificar_mascotas():\n    busqueda_realizada = request.method == \"POST\"\n    mensaje = None\n    mascotas_con_fotos = []\n\n    query = Mascota.query\n    filtros = construir_filtros_generales(request.form)\n\n    if request.method == \"POST\":\n        query = aplicar_filtros_generales(query, filtros)\n\n    mascotas = query.order_by(Mascota.fecha_registro.desc()).all()\n\n    if busqueda_realizada:\n        if not mascotas:\n            mensaje = \"No se encontraron mascotas.\"\n        else:\n            mascotas_con_fotos = _construir_mascotas_con_fotos(mascotas)\n\n    return render_template(\n        \"buscar.html\",\n        modo=\"modificar\",\n        mascotas=mascotas,\n        filtros=filtros,\n        busqueda_realizada=busqueda_realizada,\n        mensaje=mensaje,\n        mascotas_con_fotos=mascotas_con_fotos,\n    )\n\n\n@main.route(\"/comparar_mascotas/desaparecidas\", methods=[\"GET\", \"POST\"])\ndef comparar_mascotas_desaparecidas():\n    busqueda_realizada = request.method == \"POST\"\n    mensaje = None\n\n   # --- NUEVO: detectar si se pidi√≥ el modo ‚Äúidentificar raza‚Äù ---\n    modo_param = (\n        request.args.get(\"modo\")\n        or request.form.get(\"modo\")\n        or \"\"\n    ).strip().lower()\n    modo_vista = \"identificar_raza\" if modo_param == \"identificar_raza\" else \"comparar_desaparecidas\"\n    # ----------------------------------------------------------------\n\n    query = Mascota.query.filter(\n        Mascota.tipo_registro == \"desaparecida\",\n        Mascota.propietario_email.isnot(None),\n        Mascota.propietario_email != \"\",\n        Mascota.fecha_aparecida.is_(None),\n        or_(Mascota.estado_aparecida.is_(None), Mascota.estado_aparecida == \"\"),\n    )\n\n    filtros = construir_filtros_generales(request.form)\n    filtros[\"tipo_registro\"] = \"desaparecida\"\n\n    if request.method == \"POST\":\n        query = aplicar_filtros_generales(query, filtros)\n\n    mascotas = query.order_by(Mascota.fecha_registro.desc()).all()\n    if busqueda_realizada and not mascotas:\n        mensaje = \"No se localizaron mascotas desaparecidas que cumplan los criterios.\"\n\n    mascotas_con_fotos = _construir_mascotas_con_fotos(mascotas) if mascotas else []\n\n    return render_template(\n        \"buscar.html\",\n        modo=modo_vista,                     # <- usamos el modo detectado\n        mascotas=mascotas,\n        filtros=filtros,\n        busqueda_realizada=busqueda_realizada,\n        mensaje=mensaje,\n        mascotas_con_fotos=mascotas_con_fotos,\n    )\n\n@main.route(\"/mascotas/<int:mascota_id>/identificar_raza\", methods=[\"POST\"])\ndef identificar_raza_api(mascota_id: int):\n    \"\"\"\n    Endpoint que toma las fotos de la mascota desaparecida indicada,\n    llama a la utilidad identificar_raza(...) y devuelve el resultado en JSON.\n    \"\"\"\n    mascota = Mascota.query.get_or_404(mascota_id)\n\n    if (mascota.tipo_registro or \"\").lower() != \"desaparecida\":\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"Solo se pueden identificar razas de mascotas registradas como desaparecidas.\"\n        }), 400\n\n    fotos_validas = _obtener_fotos_validas(mascota)\n    rutas_abs = [foto[\"ruta_abs\"] for foto in fotos_validas if foto.get(\"ruta_abs\")]\n\n    if not rutas_abs:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"Esta mascota no tiene fotos disponibles para identificar la raza.\"\n        }), 400\n\n    # Opcional: limitar a las primeras 5 im√°genes\n    rutas_abs = rutas_abs[:5]\n\n    try:\n        resultado = identificar_raza(rutas_abs)\n    except ValueError as exc:\n        return jsonify({\"ok\": False, \"mensaje\": str(exc)}), 400\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al identificar raza para la mascota %s\", mascota_id\n        )\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": f\"Ocurri√≥ un error al identificar la raza: {exc}\"\n        }), 500\n\n    return jsonify({\"ok\": True, \"resultado\": resultado})\n\n@main.route(\"/comparar_mascotas/<int:desaparecida_id>/candidatas\", methods=[\"GET\"])\ndef comparar_mascotas_candidatas(desaparecida_id: int):\n    desaparecida = Mascota.query.get_or_404(desaparecida_id)\n\n    if not _es_mascota_desaparecida_valida(desaparecida):\n        flash(\"La mascota seleccionada no cumple los requisitos para comparar.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_desaparecidas\"))\n\n    if not _obtener_fotos_validas(desaparecida):\n        flash(\"Para comparar fotos, solo se pueden seleccionar registros con fotos.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_desaparecidas\"))\n\n    candidatas_query = Mascota.query.filter(\n        Mascota.tipo_registro == \"encontrada\",\n        Mascota.id != desaparecida.id,\n        Mascota.fotos.any(),\n    )\n\n     # Restringir a la misma especie\n    especie_ref = (desaparecida.especie or \"\").strip()\n    if especie_ref:\n        candidatas_query = candidatas_query.filter(\n            func.lower(Mascota.especie) == especie_ref.lower()\n        )\n\n    if desaparecida.fecha_registro:\n        candidatas_query = candidatas_query.filter(\n            Mascota.fecha_registro >= desaparecida.fecha_registro\n        )\n\n    candidatas = candidatas_query.order_by(Mascota.fecha_registro.asc()).all()\n    candidatas_con_fotos = _construir_mascotas_con_fotos(candidatas)\n\n    if not candidatas:\n        flash(\n            \"No se encontraron mascotas encontradas con fotos posteriores a la fecha de desaparici√≥n.\",\n            \"warning\"\n        )\n\n    return render_template(\n        \"comparar_candidatas.html\",\n        mascota_desaparecida=desaparecida,\n        candidatas=candidatas,\n        candidatas_con_fotos=candidatas_con_fotos,\n    )\n\n\n@main.route(\n    \"/comparar_mascotas/<int:desaparecida_id>/con/<int:encontrada_id>\",\n    methods=[\"GET\", \"POST\"]\n)\ndef comparar_mascotas_detalle(desaparecida_id: int, encontrada_id: int):\n    mascota_desaparecida = Mascota.query.get_or_404(desaparecida_id)\n    mascota_encontrada = Mascota.query.get_or_404(encontrada_id)\n\n    if not _es_mascota_desaparecida_valida(mascota_desaparecida):\n        flash(\"La mascota desaparecida seleccionada ya no es v√°lida para comparar.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_desaparecidas\"))\n\n    if (mascota_encontrada.tipo_registro or \"\").lower() != \"encontrada\":\n        flash(\"La mascota encontrada seleccionada no es v√°lida.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_candidatas\", desaparecida_id=desaparecida_id))\n\n    fotos_desap = _obtener_fotos_validas(mascota_desaparecida)\n    fotos_encon = _obtener_fotos_validas(mascota_encontrada)\n\n    if not fotos_desap or not fotos_encon:\n        flash(\"No hay fotos suficientes para realizar la comparaci√≥n.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_candidatas\", desaparecida_id=desaparecida_id))\n\n    fotos_desap_por_tipo = _agrupar_fotos_por_tipo(fotos_desap)\n    fotos_encon_por_tipo = _agrupar_fotos_por_tipo(fotos_encon)\n    tipos_comunes = sorted(set(fotos_desap_por_tipo.keys()) & set(fotos_encon_por_tipo.keys()))\n\n    tipos_compartidos = {\n        \"desaparecida\": sorted([tipo for tipo, fotos in fotos_desap_por_tipo.items() if fotos]),\n        \"encontrada\": sorted([tipo for tipo, fotos in fotos_encon_por_tipo.items() if fotos]),\n    }\n\n    diagnostico_individual = None\n    diagnosticos_globales: List[Dict[str, object]] = []\n    error = None\n\n    fotos_desap_dict = {str(foto[\"id\"]): foto for foto in fotos_desap}\n    fotos_encon_dict = {str(foto[\"id\"]): foto for foto in fotos_encon}\n    data_url_cache: Dict[int, str] = {}\n\n    if request.method == \"POST\":\n        accion = (request.form.get(\"accion\") or \"\").strip()\n\n        if accion == \"comparar_tipo\":\n            tipo = (request.form.get(\"tipo_foto\") or \"\").strip().lower()\n            foto_desap_id = request.form.get(\"foto_desaparecida\") or \"\"\n            foto_encon_id = request.form.get(\"foto_encontrada\") or \"\"\n\n            if tipo not in tipos_comunes:\n                error = \"El tipo de foto seleccionado no es v√°lido.\"\n            else:\n                foto_desap = fotos_desap_dict.get(foto_desap_id)\n                foto_encon = fotos_encon_dict.get(foto_encon_id)\n\n                if not foto_desap or not foto_encon:\n                    error = \"Debes seleccionar una foto de cada mascota.\"\n                elif foto_desap[\"tipo_foto\"] != tipo or foto_encon[\"tipo_foto\"] != tipo:\n                    error = \"Las fotos seleccionadas no coinciden con el tipo elegido.\"\n                else:\n                    try:\n                        data_desap = data_url_cache.setdefault(\n                            foto_desap[\"id\"],\n                            image_to_data_url(foto_desap[\"ruta_abs\"])\n                        )\n                        data_encon = data_url_cache.setdefault(\n                            foto_encon[\"id\"],\n                            image_to_data_url(foto_encon[\"ruta_abs\"])\n                        )\n                        prompt = (\n                            f\"Compara estas dos fotos de perros (tipo de foto: {tipo}). \"\n                            \"¬øCorresponden al mismo perro? Da un porcentaje aproximado de match \"\n                            \"(0-100%) y explica brevemente tu conclusi√≥n.\"\n                        )\n                        resultado = _comparar_imagenes_openai(prompt, [data_desap, data_encon])\n                        diagnostico_individual = {\n                            \"tipo\": tipo,\n                            \"foto_desap\": foto_desap,\n                            \"foto_encon\": foto_encon,\n                            \"resultado\": resultado,\n                        }\n                    except Exception as exc:\n                        current_app.logger.exception(\n                            \"Error al comparar fotos (tipo igual) desaparecida %s vs encontrada %s\",\n                            desaparecida_id,\n                            encontrada_id\n                        )\n                        error = f\"Error al comparar las fotos: {exc}\"\n\n        elif accion == \"comparar_todas\":\n            for foto_desap in fotos_desap:\n                try:\n                    data_desap = data_url_cache.setdefault(\n                        foto_desap[\"id\"],\n                        image_to_data_url(foto_desap[\"ruta_abs\"])\n                    )\n                except Exception as exc:\n                    current_app.logger.exception(\n                        \"Error al convertir la foto %s de la desaparecida %s\",\n                        foto_desap[\"id\"],\n                        desaparecida_id\n                    )\n                    diagnosticos_globales.append({\n                        \"foto_desap\": foto_desap,\n                        \"foto_encon\": None,\n                        \"resultado\": f\"No se pudo procesar la foto de la desaparecida: {exc}\",\n                    })\n                    continue\n\n                for foto_encon in fotos_encon:\n                    try:\n                        data_encon = data_url_cache.setdefault(\n                            foto_encon[\"id\"],\n                            image_to_data_url(foto_encon[\"ruta_abs\"])\n                        )\n                        resultado = _comparar_imagenes_openai(\n                            PROMPT_COMPARAR_DOS,\n                            [data_desap, data_encon]\n                        )\n                        diagnosticos_globales.append({\n                            \"foto_desap\": foto_desap,\n                            \"foto_encon\": foto_encon,\n                            \"resultado\": resultado,\n                        })\n                    except Exception as exc:\n                        current_app.logger.exception(\n                            \"Error al comparar fotos (todas) desaparecida %s vs encontrada %s\",\n                            desaparecida_id,\n                            encontrada_id\n                        )\n                        diagnosticos_globales.append({\n                            \"foto_desap\": foto_desap,\n                            \"foto_encon\": foto_encon,\n                            \"resultado\": f\"No se pudo comparar este par de fotos: {exc}\",\n                        })\n\n        else:\n            error = \"Acci√≥n no reconocida para la comparaci√≥n.\"\n\n    return render_template(\n        \"comparar_parejas.html\",\n        mascota_desaparecida=mascota_desaparecida,\n        mascota_encontrada=mascota_encontrada,\n        fotos_desap_por_tipo=fotos_desap_por_tipo,\n        fotos_encon_por_tipo=fotos_encon_por_tipo,\n        tipos_comunes=tipos_comunes,\n        tipos_compartidos=tipos_compartidos,\n        diagnostico_individual=diagnostico_individual,\n        diagnosticos_globales=diagnosticos_globales,\n        error=error,\n        url_comparar_tipo=url_for(\n                \"main.comparar_pareja_tipo_api\",\n                desaparecida_id=desaparecida_id,\n                encontrada_id=encontrada_id,\n            ),\n            url_comparar_todas=url_for(\n                \"main.comparar_pareja_todas_api\",\n                desaparecida_id=desaparecida_id,\n                encontrada_id=encontrada_id,\n            ),\n        )\n\n@main.route(\n    \"/comparaciones/desaparecida/<int:desaparecida_id>/encontrada/<int:encontrada_id>/comparar_tipo\",\n    methods=[\"POST\"],\n)\ndef comparar_pareja_tipo_api(desaparecida_id: int, encontrada_id: int):\n    \"\"\"\n    Endpoint JSON utilizado por la plantilla comparar_parejas.html.\n    Recibe el tipo de foto y las referencias de cada imagen, ejecuta la comparaci√≥n\n    y devuelve el texto (y porcentaje estimado si se puede extraer).\n    \"\"\"\n    mascota_desaparecida = Mascota.query.get_or_404(desaparecida_id)\n    mascota_encontrada = Mascota.query.get_or_404(encontrada_id)\n\n    if not _es_mascota_desaparecida_valida(mascota_desaparecida):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota desaparecida ya no es v√°lida para comparar.\"\n        }), 400\n\n    if (mascota_encontrada.tipo_registro or \"\").lower() != \"encontrada\":\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota encontrada indicada no es v√°lida.\"\n        }), 400\n\n    payload = request.get_json(silent=True) or {}\n    tipo = (payload.get(\"tipo\") or \"\").strip().lower()\n    if not tipo:\n        return jsonify({\"ok\": False, \"mensaje\": \"Debes indicar el tipo de foto a comparar.\"}), 400\n\n    foto_desap_payload = payload.get(\"foto_desap\") or {}\n    foto_encon_payload = payload.get(\"foto_encon\") or {}\n\n    fotos_desap_validas = _obtener_fotos_validas(mascota_desaparecida)\n    fotos_encon_validas = _obtener_fotos_validas(mascota_encontrada)\n    fotos_desap_por_tipo = _agrupar_fotos_por_tipo(fotos_desap_validas)\n    fotos_encon_por_tipo = _agrupar_fotos_por_tipo(fotos_encon_validas)\n\n    if tipo not in fotos_desap_por_tipo or tipo not in fotos_encon_por_tipo:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"Ninguna de las mascotas tiene fotos de ese tipo.\"\n        }), 400\n\n    foto_desap_id = str(foto_desap_payload.get(\"id\") or \"\")\n    foto_encon_id = str(foto_encon_payload.get(\"id\") or \"\")\n\n    foto_desap_datos = None\n    if foto_desap_id:\n        foto_desap_datos = next((f for f in fotos_desap_por_tipo[tipo] if str(f[\"id\"]) == foto_desap_id), None)\n    if not foto_desap_datos:\n        ruta_abs = _extraer_ruta_absoluta_payload(foto_desap_payload)\n        if not ruta_abs:\n            return jsonify({\n                \"ok\": False,\n                \"mensaje\": \"No se pudo localizar la ruta de la foto desaparecida.\"\n            }), 400\n        foto_desap_datos = {\"ruta_abs\": ruta_abs, \"id\": foto_desap_id or None, \"tipo_foto\": tipo}\n\n    foto_encon_datos = None\n    if foto_encon_id:\n        foto_encon_datos = next((f for f in fotos_encon_por_tipo[tipo] if str(f[\"id\"]) == foto_encon_id), None)\n    if not foto_encon_datos:\n        ruta_abs = _extraer_ruta_absoluta_payload(foto_encon_payload)\n        if not ruta_abs:\n            return jsonify({\n                \"ok\": False,\n                \"mensaje\": \"No se pudo localizar la ruta de la foto encontrada.\"\n            }), 400\n        foto_encon_datos = {\"ruta_abs\": ruta_abs, \"id\": foto_encon_id or None, \"tipo_foto\": tipo}\n\n    ruta_desap_abs = foto_desap_datos.get(\"ruta_abs\")\n    ruta_encon_abs = foto_encon_datos.get(\"ruta_abs\")\n\n    if not ruta_desap_abs or not os.path.isfile(ruta_desap_abs):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La imagen de la mascota desaparecida no existe en disco.\"\n        }), 404\n\n    if not ruta_encon_abs or not os.path.isfile(ruta_encon_abs):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La imagen de la mascota encontrada no existe en disco.\"\n        }), 404\n\n    try:\n        data_desap = image_to_data_url(ruta_desap_abs)\n        data_encon = image_to_data_url(ruta_encon_abs)\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al convertir im√°genes a data URL para la pareja (%s, %s)\",\n            desaparecida_id, encontrada_id\n        )\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": f\"No se pudieron procesar las im√°genes: {exc}\"\n        }), 500\n\n    prompt = (\n        f\"Compara estas dos fotos (tipo: {tipo}). \"\n        \"¬øCorresponden al mismo perro? Da un porcentaje aproximado de match (0-100%) \"\n        \"y explica brevemente tu conclusi√≥n.\"\n    )\n\n    try:\n        resultado_texto = _comparar_imagenes_openai(prompt, [data_desap, data_encon])\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al invocar la comparaci√≥n OpenAI para la pareja (%s, %s)\",\n            desaparecida_id, encontrada_id\n        )\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": f\"Ocurri√≥ un error al comparar las im√°genes: {exc}\"\n        }), 500\n\n    score = None\n    match = re.search(r\"(\\d{1,3})\\s*%\", resultado_texto or \"\", re.UNICODE)\n    if match:\n        try:\n            score_val = int(match.group(1))\n            score = max(0, min(100, score_val))\n        except ValueError:\n            score = None\n\n    return jsonify({\n        \"ok\": True,\n        \"mensaje\": resultado_texto,\n        \"score\": score,\n        \"tipo\": tipo,\n        \"foto_desap_id\": foto_desap_datos.get(\"id\"),\n        \"foto_encon_id\": foto_encon_datos.get(\"id\"),\n    })\n\n@main.route(\n    \"/comparaciones/desaparecida/<int:desaparecida_id>/encontrada/<int:encontrada_id>/comparar_todas\",\n    methods=[\"POST\"],\n)\ndef comparar_pareja_todas_api(desaparecida_id: int, encontrada_id: int):\n    mascota_desaparecida = Mascota.query.get_or_404(desaparecida_id)\n    mascota_encontrada = Mascota.query.get_or_404(encontrada_id)\n\n    if not _es_mascota_desaparecida_valida(mascota_desaparecida):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota desaparecida ya no es v√°lida para comparar.\"\n        }), 400\n\n    if (mascota_encontrada.tipo_registro or \"\").lower() != \"encontrada\":\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota encontrada indicada no es v√°lida.\"\n        }), 400\n\n    fotos_desap = _obtener_fotos_validas(mascota_desaparecida)\n    fotos_encon = _obtener_fotos_validas(mascota_encontrada)\n\n    if not fotos_desap:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota desaparecida no tiene fotos disponibles.\"\n        }), 400\n\n    if not fotos_encon:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota encontrada no tiene fotos disponibles.\"\n        }), 400\n\n    rutas_desap = [foto[\"ruta_abs\"] for foto in fotos_desap if foto.get(\"ruta_abs\")]\n    rutas_encon = [foto[\"ruta_abs\"] for foto in fotos_encon if foto.get(\"ruta_abs\")]\n\n    try:\n        resultado = comparar_fotos_todas(rutas_desap, rutas_encon)\n    except ValueError as exc:\n        return jsonify({\"ok\": False, \"mensaje\": str(exc)}), 400\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al comparar todas las fotos (desaparecida %s vs encontrada %s)\",\n            desaparecida_id,\n            encontrada_id,\n        )\n        return jsonify({\"ok\": False, \"mensaje\": f\"Error al comparar las fotos: {exc}\"}), 500\n\n    return jsonify(resultado)\n\n@main.route(\"/verificar_mascota\", methods=[\"POST\"])\ndef verificar_mascota():\n    tipo_registro = (request.args.get(\"tipo_registro\") or \"desaparecida\").lower()\n    nombre = (request.form.get(\"nombre\") or \"\").strip()\n    especie = (request.form.get(\"especie\") or \"\").strip()\n    raza = (request.form.get(\"raza\") or \"\").strip()\n\n    existe = False\n    if tipo_registro == \"desaparecida\" and nombre and especie and raza:\n        existe = (\n            Mascota.query.filter_by(\n                tipo_registro=tipo_registro,\n                nombre=nombre,\n                especie=especie,\n                raza=raza\n            ).first()\n            is not None\n        )\n\n    return jsonify({\"existe\": existe})\n\n\n@main.route(\"/comparar_fotos\", methods=[\"GET\", \"POST\"])\ndef comparar_fotos():\n    resultado = None\n    error = None\n\n    if request.method == \"POST\":\n        imagenes = request.files.getlist(\"fotos\")\n        imagenes_validas = [img for img in imagenes if img and allowed_file(img.filename)]\n        if not imagenes_validas:\n            error = \"Debes subir al menos una imagen v√°lida (jpg, png, webp, gif).\"\n            return render_template(\"comparar.html\", resultado=resultado, error=error)\n\n        rutas = []\n        for img in imagenes_validas:\n            nombre = secure_filename(f\"{uuid.uuid4().hex}_{img.filename}\")\n            ruta_fs = os.path.join(UPLOAD_FOLDER, nombre)\n            \n            img.save(ruta_fs)\n            rutas.append(ruta_fs)\n\n        try:\n            if len(rutas) == 1:\n                data1 = image_to_data_url(rutas[0])\n                resultado = _comparar_imagenes_openai(PROMPT_IDENTIFICAR_RAZA, [data1])\n            elif len(rutas) >= 2:\n                data_urls = [image_to_data_url(p) for p in rutas[:2]]\n                resultado = _comparar_imagenes_openai(PROMPT_COMPARAR_DOS, data_urls)\n        except Exception as exc:\n            current_app.logger.exception(\"Error al procesar im√°genes en /comparar_fotos\")\n            error = f\"Error al procesar las im√°genes: {exc}\"\n        finally:\n            for ruta in rutas:\n                if os.path.isfile(ruta):\n                    try:\n                        os.remove(ruta)\n                        \n                    except OSError:\n                        current_app.logger.warning(\"No se pudo eliminar la imagen temporal %s\", ruta)\n\n    return render_template(\"comparar.html\", resultado=resultado, error=error)"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Genial, con la migraci√≥n ya aplicada, el siguiente paso es hacer que el backend guarde tambi√©n los datos binarios en las nuevas columnas. Por ahora no hace falta tocar la plantilla `crear_mascota.html`; todo se maneja en `routes.py`, dentro de la vista `crear_mascota`. Aqu√≠ tienes exactamente qu√© ajustar:\n\n---\n\n## 1. Preparativos en la cabecera de `routes.py`\nA√±ade estas importaciones al inicio (si todav√≠a no est√°n):\n\n```python\nimport io\nimport mimetypes\n```\n\n(Realmente solo necesitaremos `mimetypes`; `io` no es obligatorio si usas `archivo.stream.seek(0)`.)\n\n---\n\n## 2. Dentro de la vista `crear_mascota`\nEn el bucle donde procesas cada archivo (`for idx, archivo in enumerate(fotos):`), necesitas capturar el binario y la metainformaci√≥n antes de guardar a disco.\n\n### C√≥digo actual (resumen):\n```python\narchivo.save(ruta_fs)\ndb.session.add(\n    Foto(\n        mascota_id=mascota.id,\n        tipo_foto=tipo_actual,\n        ruta=ruta_relativa\n    )\n)\n```\n\n### C√≥digo nuevo (fragmento completo con cambios):\n```python\nfor idx, archivo in enumerate(fotos):\n    if not archivo or not archivo.filename:\n        continue\n    if not allowed_file(archivo.filename):\n        flash(f\"Archivo '{archivo.filename}' ignorado: formato no permitido.\", \"warning\")\n        continue\n\n    tipo_actual = tipos_foto[idx] if idx < len(tipos_foto) else \"\"\n    tipo_actual = (tipo_actual or \"desconocido\").strip().lower()\n\n    if edit_mode and tipo_actual in existing_photos_by_type:\n        eliminar_foto_obj(existing_photos_by_type[tipo_actual])\n        existing_photos_by_type.pop(tipo_actual, None)\n\n    # --- NUEVO: capturar contenido y metadatos ---\n    data_bytes = archivo.read()\n    tamano_bytes = len(data_bytes)\n    mime_type = archivo.mimetype or mimetypes.guess_type(archivo.filename)[0] or \"application/octet-stream\"\n    nombre_original = secure_filename(archivo.filename)  # guardamos el nombre original ‚Äúlimpio‚Äù\n    archivo.stream.seek(0)  # IMPORTANT√çSIMO para poder volver a guardar en disco\n    # ------------------------------------------------\n\n    nombre_seguro = secure_filename(\n        f\"{mascota.id}_{tipo_actual}_{uuid.uuid4().hex}_{archivo.filename}\"\n    )\n    ruta_fs = os.path.join(UPLOAD_FOLDER, nombre_seguro)\n    archivo.save(ruta_fs)\n    nuevas_rutas_guardadas.append(ruta_fs)\n\n    ruta_relativa = normalizar_ruta_foto(f\"fotos/{nombre_seguro}\")\n\n    db.session.add(\n        Foto(\n            mascota_id=mascota.id,\n            tipo_foto=tipo_actual,\n            ruta=ruta_relativa,\n            data=data_bytes,              # nuevo\n            mime_type=mime_type,          # nuevo\n            nombre_archivo=nombre_original,  # nuevo\n            tamano_bytes=tamano_bytes,    # nuevo\n        )\n    )\n```\n\n> Nota: `secure_filename(archivo.filename)` se usa solo para el campo `nombre_archivo` para evitar caracteres raros. Si prefieres conservar el nombre tal cual lo subi√≥ el usuario, usa directamente `archivo.filename`.\n\n---\n\n## 3. ¬øHace falta cambiar algo m√°s ahora?\n- **`crear_mascota.html`**: no, sigue como est√°.\n- **Plantillas, APIs, etc.**: de momento todo sigue leyendo desde `foto.ruta`, as√≠ que no hay m√°s cambios.\n- **Scripts auxiliares** (`init_db.py`, `inspect_db.py`): m√°s adelante los actualizaremos para leer/escribir el binario en lugar de depender del archivo en disco. Por ahora pueden quedarse como est√°n.\n\n---\n\nCon esto, cada foto nueva que guardes quedar√° con su copia binaria en la base de datos junto con el nombre/mime/tama√±o. Cuando lo tengas implementado y probado, av√≠same para continuar con el endpoint `/foto/<id>` que servir√° las im√°genes desde la BD y nos preparar√° para exponerlas p√∫blicamente (y usarlas en Instagram)."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "como lo pruebo? creo una mascota nueva?"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Exacto: la forma m√°s r√°pida de comprobar que los nuevos campos se est√°n poblando es crear (o editar) una mascota y subirle al menos una foto. Aqu√≠ tienes un plan paso a paso para asegurarte de que todo funciona:\n\n---\n\n## ‚úÖ 1. Ejecuta la aplicaci√≥n\nEn tu entorno virtual ya activado:\n\n```bash\nflask run\n```\n\nAseg√∫rate de que se levanta sin errores.\n\n---\n\n## üêæ 2. Crea una mascota de prueba\n- Entra a `http://127.0.0.1:5000/crear_mascota?tipo_registro=desaparecida` (o encontrada, como prefieras).\n- Rellena los campos obligatorios.\n- Sube una o varias fotos.\n- Env√≠a el formulario.\n\n> Si prefieres no llenar todo, puedes crear una mascota ‚Äúdummy‚Äù temporal y luego eliminarla.\n\n---\n\n## üîç 3. Verifica que las fotos se guardaron con binario\n\n### Opci√≥n A: Usar `flask shell`\n```bash\nflask shell\n```\n\nDentro del shell:\n\n```python\nfrom web.models import db, FotoMascotaDesaparecida as Foto\n\nfoto = Foto.query.order_by(Foto.id.desc()).first()\nfoto.id\nlen(foto.data)          # deber√≠a ser > 0\nfoto.mime_type          # por ejemplo: 'image/jpeg'\nfoto.nombre_archivo     # deber√≠a ser el nombre original del archivo\nfoto.tamano_bytes       # coincide con len(data)\n```\n\n### Opci√≥n B: Consultar la base con psql\nSi te sientes c√≥modo con SQL:\n\n```sql\nSELECT id, tipo_foto, mime_type, nombre_archivo, octet_length(data)\nFROM fotos_mascotas_desaparecidas\nORDER BY id DESC\nLIMIT 3;\n```\n\n---\n\n## üßπ 4. (Opcional) Limpieza\nSi era una mascota de prueba, puedes eliminarla desde ‚ÄúModificar Mascotas‚Äù o con un script para mantener la base limpia.\n\n---\n\n### ¬øQu√© observar?\n- Que la mascota se cree sin errores.\n- Que en la base, las columnas `data`, `mime_type`, `nombre_archivo`, `tamano_bytes` no est√©n vac√≠as para las fotos nuevas.\n- Que tu flujo de la app sigue funcionando igual (se muestran las fotos existentes porque de momento a√∫n se leen desde `ruta`).\n\nCuando confirmes que los campos se llenan bien, avanzamos con el siguiente paso: crear un endpoint que sirva las fotos directamente desde la base (`/foto/<id>`). Esta URL luego la usaremos para Instagram u otras integraciones.\n\n¬øListo para probarlo?"
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": ">>> from web.models import db, FotoMascotaDesaparecida as Foto\n>>> \n>>> foto = Foto.query.order_by(Foto.id.desc()).first()\n>>> foto.id\n2\n>>> len(foto.data)          # deber√≠a ser > 0\n53687\n>>> foto.mime_type          # por ejemplo: 'image/jpeg'\n'image/jpeg'\n>>> foto.nombre_archivo     # deber√≠a ser el nombre original del archivo\n'perro8.jpg'\n>>> foto.tamano_bytes       # coincide con len(data)\n53687\n>>>"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "¬°Perfecto! Los datos se guardaron exactamente como quer√≠amos:\n\n- `len(foto.data)` y `foto.tamano_bytes` coinciden ‚ûú el binario qued√≥ almacenado.\n- `foto.mime_type` y `foto.nombre_archivo` tienen valores coherentes.\n\nCon esto, ya tenemos las fotos disponibles en la base de datos y listos para servirlas por URL.\n\n---\n\n### Siguiente paso sugerido\nCrear un endpoint tipo `/foto/<int:foto_id>` que:\n\n1. Busque la foto en la base (por ID).\n2. Devuelva los bytes (`foto.data`) con `send_file` √≥ `Response`.\n3. Use `foto.mime_type` para setear el tipo correcto.\n4. Opcionalmente permita `attachment` para descargar con `foto.nombre_archivo`.\n\nUna vez tengamos ese endpoint, podemos actualizar las plantillas y el resto de la app para usar esa URL en vez de leer desde `static/fotos/...`. Eso nos abrir√° el camino para exponer esas im√°genes externamente (p.ej., para Instagram o Facebook cuando despliegues).\n\n¬øTe ayudo con ese endpoint ahora?"
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "si, que programa hay que modificar exactamente? routes? crear_mascota? otros?"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Para crear y servir las fotos directamente desde la base de datos s√≥lo necesitas tocar **`routes.py`** (de momento no hace falta cambiar las plantillas ni otros archivos). Dentro de `routes.py` haremos dos tipos de ajustes:\n\n1. **Crear el nuevo endpoint** `/foto/<id>` (dentro del mismo blueprint `main`) que devuelva el binario guardado en la tabla.\n2. **Actualizar las funciones auxiliares que construyen las URLs de las fotos** para que usen ese endpoint en lugar de `url_for('static', ‚Ä¶)`.\n\nEn resumen, el √∫nico archivo a modificar ahora es `routes.py`. Te paso en el siguiente mensaje los cambios concretos (importaciones nuevas, funci√≥n nueva y qu√© helpers actualizar)."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "para evitar desfases de programas, te envio el routes atual  y me dices donde modificar exactamente : \nimport os\nimport re\nimport uuid\nimport base64\nfrom collections import defaultdict\nfrom datetime import datetime, date\nfrom threading import Thread\nfrom typing import List, Dict\n\nimport io\nimport mimetypes\n\nfrom flask import (\n    Blueprint, render_template, request, redirect,\n    url_for, flash, jsonify, current_app\n)\nfrom sqlalchemy import or_, func\nfrom sqlalchemy.exc import IntegrityError\nfrom werkzeug.utils import secure_filename\n\nfrom .models import db, Mascota, FotoMascotaDesaparecida as Foto\nfrom .utils.envia_mail import send_pet_email\n\nfrom .utils.prueba_envio_facebook import send_pet_fb_message  # <-- nuevo import\nfrom .utils.publicar_fb import publish_pet_fb_post  # <-- nuevo import\n\nfrom .utils.comparar_fotos_todas import comparar_fotos_todas\nfrom .utils.identificar_raza import identificar_raza\nfrom openai import OpenAI\n\nmain = Blueprint('main', __name__)\n\n# Directorios seg√∫n tu estructura: web/templates y web/static\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\nSTATIC_DIR = os.path.join(BASE_DIR, 'static')\nUPLOAD_FOLDER = os.path.join(STATIC_DIR, 'fotos')\nos.makedirs(UPLOAD_FOLDER, exist_ok=True)\n\nALLOWED_EXTENSIONS = {\"jpg\", \"jpeg\", \"png\", \"webp\", \"gif\"}\nTIPOS_REGISTRO = {\"desaparecida\", \"encontrada\"}\nTAMANOS = {\"peque√±o\", \"mediano\", \"grande\"}\nSEXOS = {\"macho\", \"hembra\", \"no_sabe\"}\nESTADOS_APARECIDA = {\"viva\", \"muerta\"}\n\nPROMPT_IDENTIFICAR_RAZA = \"Identifica la raza del perro en esta imagen:\"\nPROMPT_COMPARAR_DOS = (\n    \"¬øSon el mismo perro o distintos? Da un porcentaje aproximado de match (0-100%) \"\n    \"y explica brevemente por qu√©.\"\n)\n\nACTIVAR_MESSENGER = os.getenv(\"ACTIVAR_MESSENGER\", \"false\").lower() == \"true\"\n\nclient = OpenAI(api_key=os.environ.get(\"OPENAI_API_KEY\"))\n\n\ndef _get_static_root() -> str:\n    try:\n        static_root = current_app.static_folder\n    except RuntimeError:\n        static_root = None\n    elegido = static_root or STATIC_DIR\n    \n    return elegido\n\n\ndef _resolver_ruta_absoluta(ruta_rel: str) -> str:\n    ruta_abs = os.path.join(_get_static_root(), ruta_rel.replace(\"/\", os.sep))\n    \n    return ruta_abs\n\n\ndef _extraer_ruta_absoluta_payload(info: dict | None) -> str | None:\n    \"\"\"\n    Dado el diccionario de una foto enviado desde el frontend, intenta obtener\n    la ruta absoluta en disco. Soporta distintos nombres de campo y rutas\n    relativas (ej. 'static/fotos/...', '/static/...', 'fotos/...').\n    \"\"\"\n    if not info or not isinstance(info, dict):\n        return None\n\n    posibles_claves = [\n        \"ruta_abs\",\n        \"ruta_absoluta\",\n        \"ruta\",\n        \"ruta_rel\",\n        \"ruta_relativa\",\n        \"path\",\n        \"filepath\",\n        \"file_path\",\n        \"url\",\n    ]\n\n    for clave in posibles_claves:\n        valor = info.get(clave)\n        if not valor or not isinstance(valor, str):\n            continue\n        ruta = valor.strip()\n        if not ruta:\n            continue\n\n        # Si ya viene en absoluto y existe, usarla directamente.\n        if os.path.isabs(ruta) and os.path.isfile(ruta):\n            return ruta\n\n        ruta_norm = normalizar_ruta_foto(ruta)\n        if ruta_norm:\n            ruta_abs = _resolver_ruta_absoluta(ruta_norm)\n            if os.path.isfile(ruta_abs):\n                return ruta_abs\n\n    return None\n\n\ndef allowed_file(filename: str) -> bool:\n    return \".\" in filename and filename.rsplit(\".\", 1)[1].lower() in ALLOWED_EXTENSIONS\n\n\ndef image_to_data_url(path):\n    name = os.path.basename(path).lower()\n    if name.endswith(\".png\"):\n        mime = \"image/png\"\n    elif name.endswith((\".jpg\", \".jpeg\")):\n        mime = \"image/jpeg\"\n    elif name.endswith(\".gif\"):\n        mime = \"image/gif\"\n    elif name.endswith(\".webp\"):\n        mime = \"image/webp\"\n    else:\n        mime = \"image/jpeg\"\n    with open(path, \"rb\") as f:\n        b64 = base64.b64encode(f.read()).decode(\"utf-8\")\n    return f\"data:{mime};base64,{b64}\"\n\n\ndef parse_fecha(fecha_str: str | None) -> date | None:\n    if not fecha_str:\n        return None\n    fecha_str = fecha_str.strip()\n    for fmt in (\"%d/%m/%Y\", \"%Y-%m-%d\"):\n        try:\n            return datetime.strptime(fecha_str, fmt).date()\n        except ValueError:\n            continue\n    return None\n\n\ndef normalizar_ruta_foto(ruta: str | None) -> str | None:\n    if not ruta:\n        return None\n    ruta = ruta.strip().replace(\"\\\\\", \"/\")\n    partes = [p for p in ruta.split(\"/\") if p]\n    if not partes:\n        return None\n    partes_lower = [p.lower() for p in partes]\n    if \"static\" in partes_lower:\n        idx = partes_lower.index(\"static\")\n        partes = partes[idx + 1:]\n        partes_lower = partes_lower[idx + 1:]\n    if \"fotos\" in partes_lower:\n        idx = partes_lower.index(\"fotos\")\n        partes = partes[idx:]\n    ruta_normalizada = \"/\".join(partes)\n    return ruta_normalizada or None\n\n\ndef eliminar_archivo_relativo(ruta_rel: str | None) -> None:\n    if not ruta_rel:\n        return\n    ruta_norm = normalizar_ruta_foto(ruta_rel)\n    if not ruta_norm:\n        return\n    ruta_abs = _resolver_ruta_absoluta(ruta_norm)\n   \n    try:\n        if os.path.isfile(ruta_abs):\n            os.remove(ruta_abs)\n    except OSError:\n        current_app.logger.warning(\"No se pudo eliminar el archivo de foto %s\", ruta_abs)\n\n\ndef eliminar_foto_obj(foto: Foto | None) -> None:\n    if not foto:\n        return\n    eliminar_archivo_relativo(foto.ruta)\n    db.session.delete(foto)\n\n\ndef obtener_fotos_existentes(mascota: Mascota) -> List[Dict[str, str]]:\n    fotos_serializadas: List[Dict[str, str]] = []\n    for foto in getattr(mascota, \"fotos\", []):\n        ruta_rel = normalizar_ruta_foto(foto.ruta)\n        if not ruta_rel:\n            continue\n        fotos_serializadas.append({\n            \"id\": foto.id,\n            \"tipo_foto\": foto.tipo_foto,\n            \"ruta\": f\"static/{ruta_rel}\",\n            \"url\": url_for(\"static\", filename=ruta_rel)\n        })\n    return fotos_serializadas\n\n\ndef _construir_mascotas_con_fotos(mascotas):\n    resultado = []\n    for mascota in mascotas:\n        fotos = Foto.query.filter_by(mascota_id=mascota.id).all()\n        fotos_info = []\n        for foto in fotos:\n            ruta_relativa = normalizar_ruta_foto(foto.ruta)\n            if ruta_relativa:\n                fotos_info.append({\n                    \"id\": foto.id,\n                    \"tipo_foto\": foto.tipo_foto,\n                    \"ruta\": f\"static/{ruta_relativa}\",\n                    \"url\": url_for(\"static\", filename=ruta_relativa)\n                })\n        resultado.append((mascota, fotos_info))\n    return resultado\n\n\ndef _es_mascota_desaparecida_valida(mascota: Mascota | None) -> bool:\n    if not mascota or (mascota.tipo_registro or \"\").lower() != \"desaparecida\":\n        return False\n    if not (mascota.propietario_email and mascota.propietario_email.strip()):\n        return False\n    if mascota.fecha_aparecida is not None:\n        return False\n    estado = (mascota.estado_aparecida or \"\").strip()\n    if estado:\n        return False\n    return True\n\n\ndef _serializar_foto(foto: Foto) -> Dict[str, str] | None:\n    ruta_rel = normalizar_ruta_foto(foto.ruta)\n    \n    if not ruta_rel:\n        print(f\"[DEBUG] _serializar_foto: foto_id={foto.id}, descartada (sin ruta normalizada)\")\n        return None\n    ruta_abs = _resolver_ruta_absoluta(ruta_rel)\n    existe = os.path.isfile(ruta_abs)\n    \n    if not existe:\n        return None\n    tipo = (foto.tipo_foto or \"desconocido\").strip().lower() or \"desconocido\"\n    return {\n        \"id\": foto.id,\n        \"tipo_foto\": tipo,\n        \"ruta_rel\": ruta_rel,\n        \"ruta_abs\": ruta_abs,\n        \"url\": url_for(\"static\", filename=ruta_rel),\n    }\n\n\ndef _obtener_fotos_validas(mascota: Mascota | None) -> List[Dict[str, str]]:\n    if not mascota:\n        return []\n    fotos_validas: List[Dict[str, str]] = []\n    for foto in getattr(mascota, \"fotos\", []):\n        datos = _serializar_foto(foto)\n        if datos:\n            fotos_validas.append(datos)\n    return fotos_validas\n\n\ndef _agrupar_fotos_por_tipo(fotos: List[Dict[str, str]]) -> Dict[str, List[Dict[str, str]]]:\n    agrupado: dict[str, list[dict[str, str]]] = defaultdict(list)\n    for foto in fotos:\n        agrupado[foto[\"tipo_foto\"]].append(foto)\n    return dict(agrupado)\n\n\ndef _comparar_imagenes_openai(prompt: str, data_urls: List[str]) -> str:\n    mensajes = [{\"type\": \"text\", \"text\": prompt}]\n    for data_url in data_urls:\n        mensajes.append({\"type\": \"image_url\", \"image_url\": {\"url\": data_url}})\n    respuesta = client.chat.completions.create(\n        model=\"gpt-5\",\n        messages=[{\"role\": \"user\", \"content\": mensajes}]\n    )\n    return respuesta.choices[0].message.content\n\n\ndef _cargar_smtp_env(app) -> None:\n    app.config[\"SMTP_SERVER\"] = os.getenv(\"SMTP_SERVER\", \"\")\n    app.config[\"SMTP_PORT\"] = int(os.getenv(\"SMTP_PORT\", \"587\"))\n    app.config[\"SMTP_USERNAME\"] = os.getenv(\"SMTP_USERNAME\", \"\")\n    app.config[\"SMTP_PASSWORD\"] = os.getenv(\"SMTP_PASSWORD\", \"\")\n    app.config[\"SMTP_TO_EMAIL\"] = os.getenv(\"SMTP_TO_EMAIL\", \"\")\n\n\ndef _programar_envio_correo(mascota_id: int) -> None:\n    try:\n        app = current_app._get_current_object()\n        _cargar_smtp_env(app)\n        Thread(\n            target=_worker_enviar_correo,\n            args=(app, mascota_id),\n            daemon=True\n        ).start()\n    except Exception:\n        current_app.logger.exception(\n            \"No se pudo programar el env√≠o de correo para la mascota %s\", mascota_id\n        )\n\ndef _worker_enviar_correo(app, mascota_id: int) -> None:\n    with app.app_context():\n        mascota = Mascota.query.get(mascota_id)\n        if not mascota:\n            current_app.logger.error(\n                \"No se encontr√≥ la mascota %s para enviar correo.\", mascota_id\n            )\n            return\n\n        subject = (\n            f\"üê∂üê± mascota {(mascota.tipo_registro or '').strip()}\".strip() or \"Mascota\"\n        )\n        datos_email = _construir_datos_email(mascota)\n        fotos_email = _obtener_rutas_fotos(mascota)\n        destinatarios_extra = _calcular_destinatarios_extra(mascota)\n\n        ok_email = send_pet_email(\n            subject,\n            datos_email,\n            fotos_email,\n            destinatarios_extra=destinatarios_extra,\n        )\n        if not ok_email:\n            current_app.logger.error(\n                \"Fallo al enviar correo autom√°tico de mascota %s\", mascota_id\n            )\n\n        if ACTIVAR_MESSENGER:\n            ok_fb = send_pet_fb_message(\n                subject,\n                datos_email,\n                fotos_email,\n                destinatarios_extra=destinatarios_extra,\n            )\n            if not ok_fb:\n                current_app.logger.error(\n                    \"Fallo al enviar mensaje de Facebook de mascota %s\", mascota_id\n                )\n        else:\n            current_app.logger.info(\n                \"Messenger desactivado; no se env√≠a mensaje para la mascota %s\",\n                mascota_id,\n            )\n\n        ok_fb_post = publish_pet_fb_post(subject, datos_email, fotos_email)\n        if not ok_fb_post:\n            current_app.logger.error(\n                \"Fallo al publicar en el feed de Facebook de la mascota %s\", mascota_id\n            )\n\n\ndef _construir_datos_email(mascota: Mascota) -> Dict[str, object]:\n    return {\n        \"ID\": mascota.id,\n        \"Tipo de registro\": mascota.tipo_registro,\n        \"Nombre\": mascota.nombre,\n        \"Especie\": mascota.especie,\n        \"Raza\": mascota.raza,\n        \"Edad\": mascota.edad,\n        \"Zona\": mascota.zona,\n        \"Email contacto\": mascota.propietario_email,\n        \"Tel√©fono contacto\": mascota.propietario_telefono,\n        \"Color\": mascota.color,\n        \"Sexo\": mascota.sexo,\n        \"Chip\": mascota.chip,\n        \"Peso\": mascota.peso,\n        \"Tama√±o\": mascota.tamano,\n        \"Descripci√≥n\": mascota.descripcion,\n        \"Fecha registro\": mascota.fecha_registro,\n        \"Fecha aparecida\": mascota.fecha_aparecida,\n        \"Estado aparecida\": mascota.estado_aparecida,\n    }\n\n\ndef _obtener_rutas_fotos(mascota: Mascota) -> List[str]:\n    rutas: List[str] = []\n    for foto in getattr(mascota, \"fotos\", []):\n        ruta_rel = normalizar_ruta_foto(foto.ruta)\n        if not ruta_rel:\n            continue\n        ruta_abs = _resolver_ruta_absoluta(ruta_rel)\n        if os.path.isfile(ruta_abs):\n            rutas.append(ruta_abs)\n        else:\n            current_app.logger.warning(\n                \"Foto no encontrada en disco: %s (mascota %s)\", ruta_abs, mascota.id\n            )\n    return rutas\n\n\ndef _calcular_destinatarios_extra(mascota: Mascota) -> List[str]:\n    destinatarios: List[str] = []\n    correo_propietario = (mascota.propietario_email or \"\").strip()\n    if correo_propietario:\n        destinatarios.append(correo_propietario)\n\n    if (mascota.tipo_registro or \"\").lower() == \"encontrada\":\n        registros_previos = (\n            Mascota.query.with_entities(Mascota.propietario_email)\n            .filter(\n                Mascota.tipo_registro == \"desaparecida\",\n                Mascota.fecha_registro <= mascota.fecha_registro,\n                Mascota.fecha_aparecida.is_(None),\n                Mascota.propietario_email.isnot(None),\n                Mascota.propietario_email != \"\",\n            )\n            .distinct()\n            .all()\n        )\n\n        for (correo,) in registros_previos:\n            correo_norm = (correo or \"\").strip()\n            if correo_norm and correo_norm not in destinatarios:\n                destinatarios.append(correo_norm)\n\n    return destinatarios\n\n\ndef construir_filtros_generales(form) -> Dict[str, str]:\n    return {\n        \"tipo_registro\": (form.get(\"tipo_registro\") or \"\").lower(),\n        \"nombre\": (form.get(\"nombre\") or \"\").strip(),\n        \"especie\": (form.get(\"especie\") or \"\").strip(),\n        \"raza\": (form.get(\"raza\") or \"\").strip(),\n        \"zona\": (form.get(\"zona\") or \"\").strip(),\n        \"color\": (form.get(\"color\") or \"\").strip(),\n        \"tamano\": (form.get(\"tamano\") or \"\").strip().lower(),\n        \"descripcion\": (form.get(\"descripcion\") or \"\").strip(),\n        \"sexo\": (form.get(\"sexo\") or \"\").strip().lower(),\n        \"chip\": (form.get(\"chip\") or \"\").strip(),\n        \"peso\": (form.get(\"peso\") or \"\").strip(),\n        \"edad\": (form.get(\"edad\") or \"\").strip(),\n        \"propietario_email\": (form.get(\"propietario_email\") or \"\").strip(),\n        \"propietario_telefono\": (form.get(\"propietario_telefono\") or \"\").strip(),\n        \"fecha_registro\": (form.get(\"fecha_registro\") or \"\").strip(),\n        \"fecha_aparecida\": (form.get(\"fecha_aparecida\") or \"\").strip(),\n        \"estado_aparecida\": (form.get(\"estado_aparecida\") or \"\").strip().lower(),\n    }\n\n\ndef aplicar_filtros_generales(query, filtros: Dict[str, str]):\n    if filtros[\"tipo_registro\"] in TIPOS_REGISTRO:\n        query = query.filter(Mascota.tipo_registro == filtros[\"tipo_registro\"])\n\n    if filtros[\"nombre\"]:\n        query = query.filter(Mascota.nombre.ilike(f\"%{filtros['nombre']}%\"))\n\n    if filtros[\"especie\"]:\n        query = query.filter(Mascota.especie.ilike(f\"%{filtros['especie']}%\"))\n\n    if filtros[\"raza\"]:\n        query = query.filter(Mascota.raza.ilike(f\"%{filtros['raza']}%\"))\n\n    if filtros[\"zona\"]:\n        query = query.filter(Mascota.zona.ilike(f\"%{filtros['zona']}%\"))\n\n    if filtros[\"color\"]:\n        query = query.filter(Mascota.color.ilike(f\"%{filtros['color']}%\"))\n\n    if filtros[\"tamano\"] in TAMANOS:\n        query = query.filter(Mascota.tamano == filtros[\"tamano\"])\n\n    if filtros[\"descripcion\"]:\n        query = query.filter(Mascota.descripcion.ilike(f\"%{filtros['descripcion']}%\"))\n\n    if filtros[\"sexo\"] in SEXOS:\n        query = query.filter(Mascota.sexo == filtros[\"sexo\"])\n\n    if filtros[\"chip\"]:\n        query = query.filter(Mascota.chip.ilike(f\"%{filtros['chip']}%\"))\n\n    if filtros[\"peso\"]:\n        try:\n            peso_val = float(filtros[\"peso\"].replace(\",\", \".\"))\n            query = query.filter(Mascota.peso == peso_val)\n        except ValueError:\n            flash(\"Peso inv√°lido. Usa n√∫meros (puedes emplear coma o punto).\", \"error\")\n\n    if filtros[\"edad\"].isdigit():\n        query = query.filter(Mascota.edad == int(filtros[\"edad\"]))\n\n    if filtros[\"propietario_email\"]:\n        query = query.filter(Mascota.propietario_email.ilike(f\"%{filtros['propietario_email']}%\"))\n\n    if filtros[\"propietario_telefono\"]:\n        query = query.filter(Mascota.propietario_telefono.ilike(f\"%{filtros['propietario_telefono']}%\"))\n\n    if filtros[\"fecha_registro\"]:\n        fecha_filtrada = parse_fecha(filtros[\"fecha_registro\"])\n        if fecha_filtrada:\n            query = query.filter(Mascota.fecha_registro == fecha_filtrada)\n        else:\n            flash(\"Formato de fecha de registro inv√°lido. Usa dd/mm/aaaa.\", \"error\")\n\n    if filtros[\"fecha_aparecida\"]:\n        fecha_ap = parse_fecha(filtros[\"fecha_aparecida\"])\n        if fecha_ap:\n            query = query.filter(Mascota.fecha_aparecida == fecha_ap)\n        else:\n            flash(\"Formato de fecha de aparici√≥n inv√°lido.\", \"error\")\n\n    if filtros[\"estado_aparecida\"] in ESTADOS_APARECIDA:\n        query = query.filter(Mascota.estado_aparecida == filtros[\"estado_aparecida\"])\n\n    return query\n\n\n@main.route(\"/\")\ndef index():\n    return render_template(\"index.html\")\n\n@main.route(\"/crear_mascota\", methods=[\"GET\", \"POST\"])\n@main.route(\"/mascotas/<int:mascota_id>/editar\", methods=[\"GET\", \"POST\"])\ndef crear_mascota(mascota_id=None):\n    edit_mode = mascota_id is not None\n    mascota = None\n\n    if edit_mode:\n        mascota = Mascota.query.get_or_404(mascota_id)\n        tipo_registro = (mascota.tipo_registro or \"desaparecida\").lower()\n    else:\n        tipo_registro = (request.args.get(\"tipo_registro\") or \"desaparecida\").lower()\n        if tipo_registro not in TIPOS_REGISTRO:\n            flash(\"Tipo de registro inv√°lido.\", \"error\")\n            return redirect(url_for(\"main.index\"))\n\n    if request.method == \"POST\":\n        print(\"[DBG CREAR] POST recibido:\",\n              \"args.tipo_registro=\", request.args.get(\"tipo_registro\"),\n              \"form.tipo_registro=\", request.form.get(\"tipo_registro\"))\n\n        tipo_registro_form = (request.form.get(\"tipo_registro\") or '').strip().lower()\n        if edit_mode and tipo_registro_form in TIPOS_REGISTRO:\n            tipo_registro = tipo_registro_form\n        elif not edit_mode and tipo_registro_form:\n            tipo_registro = tipo_registro_form\n\n        if not edit_mode and tipo_registro not in TIPOS_REGISTRO:\n            flash(\"Tipo de registro inv√°lido.\", \"error\")\n            return redirect(url_for(\"main.index\"))\n\n        nombre = (request.form.get(\"nombre\") or \"\").strip()\n        especie = (request.form.get(\"especie\") or \"\").strip()\n        raza = (request.form.get(\"raza\") or \"\").strip()\n        edad = (request.form.get(\"edad\") or \"\").strip()\n        propietario_email = (request.form.get(\"propietario_email\") or \"\").strip()\n        propietario_telefono = (request.form.get(\"propietario_telefono\") or \"\").strip()\n        zona = (request.form.get(\"zona\") or \"\").strip()\n        color = (request.form.get(\"color\") or \"\").strip()\n        sexo = (request.form.get(\"sexo\") or \"\").strip().lower()\n        chip = (request.form.get(\"chip\") or \"\").strip()\n        peso = (request.form.get(\"peso\") or \"\").strip()\n        tamano = (request.form.get(\"tamano\") or \"\").strip().lower()\n        descripcion = (request.form.get(\"descripcion\") or \"\").strip()\n        fecha_registro_str = (request.form.get(\"fecha_registro\") or \"\").strip()\n\n        if tipo_registro == \"encontrada\" and sexo not in SEXOS:\n            sexo = \"no_sabe\"\n            print(\"[DBG CREAR] sexo vac√≠o en encontrada -> forzado a 'no_sabe'\")\n\n        print(\"[DBG CREAR] Campos crudos:\",\n              \"nombre=\", repr(nombre),\n              \"especie=\", repr(especie),\n              \"raza=\", repr(raza),\n              \"zona=\", repr(zona),\n              \"color=\", repr(color),\n              \"sexo=\", repr(sexo),\n              \"tamano=\", repr(tamano),\n              \"email=\", repr(propietario_email),\n              \"tel=\", repr(propietario_telefono),\n              \"fecha_registro=\", repr(fecha_registro_str))\n\n        if tipo_registro == \"encontrada\":\n            nombre = \"encontrada\"\n\n        print(\"[DBG CREAR] Tipo y nombre efectivos:\",\n              \"tipo_registro=\", tipo_registro,\n              \"nombre=\", nombre)\n\n        if not nombre:\n            flash(\"El nombre de la mascota es obligatorio.\", \"error\")\n            return redirect(request.url)\n\n        if not especie or not color or sexo not in SEXOS or tamano not in TAMANOS:\n            flash(\"Faltan datos obligatorios (especie, color, sexo, tama√±o).\", \"error\")\n            return redirect(request.url)\n\n        edad_val = int(edad) if edad.isdigit() else None\n\n        peso_val = None\n        if peso:\n            try:\n                peso_val = float(peso.replace(\",\", \".\"))\n            except ValueError:\n                flash(\"Peso inv√°lido. Usa n√∫meros (puedes emplear coma o punto).\", \"error\")\n                return redirect(request.url)\n\n        fecha_registro = parse_fecha(fecha_registro_str)\n        if not fecha_registro:\n            fecha_registro = mascota.fecha_registro if edit_mode and mascota.fecha_registro else datetime.utcnow().date()\n\n        print(\"[DBG CREAR] Normalizados:\",\n              \"especie=\", repr(especie),\n              \"raza=\", repr(raza),\n              \"zona=\", repr(zona),\n              \"color=\", repr(color),\n              \"sexo=\", repr(sexo),\n              \"tamano=\", repr(tamano),\n              \"fecha_registro=\", fecha_registro)\n        print(\"[DBG CREAR] Obligatorios presentes?\",\n              \"zona=\", bool(zona),\n              \"email=\", bool(propietario_email),\n              \"tel=\", bool(propietario_telefono))\n\n        email_norm = (propietario_email or \"\").strip().lower()\n        dup_q = Mascota.query.filter_by(\n            propietario_email=email_norm,\n            tipo_registro=tipo_registro,\n            nombre=(nombre or \"\").strip().lower(),\n            zona=(zona or \"\").strip().lower(),\n            especie=(especie or \"\").strip().lower(),\n            color=(color or \"\").strip().lower(),\n            tamano=(tamano or \"\").strip().lower(),\n            fecha_registro=fecha_registro\n        )\n        if edit_mode:\n            dup_q = dup_q.filter(Mascota.id != mascota.id)\n\n        try:\n            dup_count = dup_q.count()\n        except Exception as e:\n            dup_count = f\"error count: {e}\"\n        print(\"[DBG CREAR] Duplicados (clave UNIQUE) encontrados:\", dup_count)\n\n        if dup_q.first():\n            print(\"[DBG CREAR] BLOQUEADO por duplicado seg√∫n clave UNIQUE\")\n            flash(\"Ya existe un registro igual (email, tipo, nombre, zona, especie, color, tama√±o y fecha).\", \"error\")\n            return redirect(request.url)\n\n        if edit_mode:\n            mascota.tipo_registro = tipo_registro\n            mascota.nombre = nombre\n            mascota.especie = especie\n            mascota.raza = raza or None\n            mascota.edad = edad_val\n            mascota.propietario_email = propietario_email or None\n            mascota.propietario_telefono = propietario_telefono or None\n            mascota.zona = zona or None\n            mascota.color = color\n            mascota.descripcion = descripcion or None\n            mascota.chip = chip or None\n            mascota.sexo = sexo\n            mascota.peso = peso_val\n            mascota.tamano = tamano\n            mascota.fecha_registro = fecha_registro\n        else:\n            mascota = Mascota(\n                tipo_registro=tipo_registro,\n                nombre=nombre,\n                especie=especie,\n                raza=raza or None,\n                edad=edad_val,\n                propietario_email=propietario_email or None,\n                propietario_telefono=propietario_telefono or None,\n                zona=zona or None,\n                color=color,\n                descripcion=descripcion or None,\n                chip=chip or None,\n                sexo=sexo,\n                peso=peso_val,\n                tamano=tamano,\n                fecha_registro=fecha_registro\n            )\n            db.session.add(mascota)\n\n        print(\"[DBG CREAR] Antes de flush: mascota.id=\", getattr(mascota, \"id\", None))\n        try:\n            db.session.flush()\n        except IntegrityError as exc:\n            print(\"[DBG CREAR] IntegrityError en flush:\", repr(exc))\n            try:\n                print(\"[DBG CREAR] IntegrityError.orig:\", getattr(exc, \"orig\", None))\n                if getattr(exc, \"orig\", None) is not None and hasattr(exc.orig, \"args\"):\n                    print(\"[DBG CREAR] IntegrityError.orig.args:\", exc.orig.args)\n            except Exception:\n                pass\n            db.session.rollback()\n            flash(\"Error de integridad al guardar la mascota (posible duplicado).\", \"error\")\n            return redirect(request.url)\n\n        fotos_eliminar_ids = request.form.getlist(\"fotos_eliminar_id\")\n        if edit_mode and fotos_eliminar_ids:\n            for foto_id in fotos_eliminar_ids:\n                if not foto_id.isdigit():\n                    continue\n                foto_obj = Foto.query.filter_by(id=int(foto_id), mascota_id=mascota.id).first()\n                if foto_obj:\n                    eliminar_foto_obj(foto_obj)\n\n        existing_photos_by_type = {}\n        if edit_mode:\n            for foto in list(mascota.fotos):\n                if foto in db.session.deleted:\n                    continue\n                existing_photos_by_type[foto.tipo_foto] = foto\n\n        fotos = request.files.getlist(\"fotos\")\n        tipos_foto = request.form.getlist(\"tipo_foto\")\n        print(\"[DBG CREAR] files.fotos len=\", len(fotos),\n              \"tipos_foto len=\", len(tipos_foto))\n        print(\"[DBG CREAR] tipos_foto=\", tipos_foto)\n\n        nuevas_rutas_guardadas: List[str] = []\n\n        for idx, archivo in enumerate(fotos):\n            if not archivo or not archivo.filename:\n                continue\n            if not allowed_file(archivo.filename):\n                flash(f\"Archivo '{archivo.filename}' ignorado: formato no permitido.\", \"warning\")\n                continue\n\n            tipo_actual = tipos_foto[idx] if idx < len(tipos_foto) else \"\"\n            tipo_actual = (tipo_actual or \"desconocido\").strip().lower()\n\n            if edit_mode and tipo_actual in existing_photos_by_type:\n                eliminar_foto_obj(existing_photos_by_type[tipo_actual])\n                existing_photos_by_type.pop(tipo_actual, None)\n\n            # --- NUEVO: capturar contenido y metadatos ---\n            data_bytes = archivo.read()\n            tamano_bytes = len(data_bytes)\n            mime_type = archivo.mimetype or mimetypes.guess_type(archivo.filename)[0] or \"application/octet-stream\"\n            nombre_original = secure_filename(archivo.filename)  # guardamos el nombre original ‚Äúlimpio‚Äù\n            archivo.stream.seek(0)  # IMPORTANT√çSIMO para poder volver a guardar en disco\n            # ------------------------------------------------\n\n            nombre_seguro = secure_filename(\n                f\"{mascota.id}_{tipo_actual}_{uuid.uuid4().hex}_{archivo.filename}\"\n            )\n            ruta_fs = os.path.join(UPLOAD_FOLDER, nombre_seguro)\n            archivo.save(ruta_fs)\n            nuevas_rutas_guardadas.append(ruta_fs)\n\n            ruta_relativa = normalizar_ruta_foto(f\"fotos/{nombre_seguro}\")\n\n            db.session.add(\n                Foto(\n                    mascota_id=mascota.id,\n                    tipo_foto=tipo_actual,\n                    ruta=ruta_relativa,\n                    data=data_bytes,              # nuevo\n                    mime_type=mime_type,          # nuevo\n                    nombre_archivo=nombre_original,  # nuevo\n                    tamano_bytes=tamano_bytes,    # nuevo\n                )\n            )\n\n        print(\"[DBG CREAR] Antes de commit: mascota.id=\", getattr(mascota, \"id\", None))\n        try:\n            db.session.commit()\n        except IntegrityError as exc:\n            print(\"[DBG CREAR] IntegrityError en commit:\", repr(exc))\n            try:\n                print(\"[DBG CREAR] IntegrityError.orig:\", getattr(exc, \"orig\", None))\n                if getattr(exc, \"orig\", None) is not None and hasattr(exc.orig, \"args\"):\n                    print(\"[DBG CREAR] IntegrityError.orig.args:\", exc.orig.args)\n            except Exception:\n                pass\n            db.session.rollback()\n            for ruta_guardada in nuevas_rutas_guardadas:\n                try:\n                    if os.path.isfile(ruta_guardada):\n                        os.remove(ruta_guardada)\n                except OSError:\n                    current_app.logger.warning(\"No se pudo eliminar archivo %s tras fallo de commit.\", ruta_guardada)\n            flash(\"No se pudo guardar los datos de la mascota por un conflicto de integridad.\", \"error\")\n            return redirect(request.url)\n        except Exception as exc:\n            db.session.rollback()\n            for ruta_guardada in nuevas_rutas_guardadas:\n                try:\n                    if os.path.isfile(ruta_guardada):\n                        os.remove(ruta_guardada)\n                except OSError:\n                    current_app.logger.warning(\"No se pudo eliminar archivo %s tras fallo de commit.\", ruta_guardada)\n            current_app.logger.exception(\"Error al guardar la mascota: %s\", exc)\n            flash(\"Ocurri√≥ un error al guardar la mascota.\", \"error\")\n            return redirect(request.url)\n\n        print(\"[DBG CREAR] Mascota creada/actualizada OK. id=\", mascota.id, \"tipo=\", mascota.tipo_registro)\n\n        if edit_mode:\n            flash(\"Mascota actualizada correctamente.\", \"success\")\n            _programar_envio_correo(mascota.id)\n            return redirect(url_for(\"main.modificar_mascotas\"))\n        else:\n            flash(f\"Mascota {tipo_registro} registrada correctamente.\", \"success\")\n            _programar_envio_correo(mascota.id)\n            return redirect(url_for(\"main.index\"))\n\n    fotos_existentes = obtener_fotos_existentes(mascota) if edit_mode else []\n    form_action = (\n        url_for(\"main.crear_mascota\", mascota_id=mascota.id)\n        if edit_mode else\n        url_for(\"main.crear_mascota\", tipo_registro=tipo_registro)\n    )\n\n    return render_template(\n        \"crear_mascota.html\",\n        tipo_registro=tipo_registro,\n        modo=\"modificar\" if edit_mode else \"crear\",\n        mascota=mascota,\n        fotos_existentes=fotos_existentes,\n        form_action=form_action\n    )\n\n\n@main.route(\"/mascotas/<int:mascota_id>/eliminar\", methods=[\"POST\"])\ndef eliminar_mascota(mascota_id):\n    mascota = Mascota.query.get_or_404(mascota_id)\n\n    for foto in list(mascota.fotos):\n        eliminar_foto_obj(foto)\n\n    try:\n        db.session.delete(mascota)\n        db.session.commit()\n    except Exception as exc:\n        db.session.rollback()\n        current_app.logger.exception(\"Error al eliminar mascota %s: %s\", mascota_id, exc)\n        flash(\"No se pudo eliminar la mascota.\", \"error\")\n        return redirect(url_for(\"main.modificar_mascotas\"))\n\n    flash(\"Mascota eliminada correctamente.\", \"success\")\n    return redirect(url_for(\"main.modificar_mascotas\"))\n\n\n@main.route(\"/buscar_mascotas\", methods=[\"GET\", \"POST\"])\ndef buscar_mascotas():\n    busqueda_realizada = request.method == \"POST\"\n    mensaje = None\n    mascotas_con_fotos = []\n    filtros = {}\n\n    query = Mascota.query\n\n    if request.method == \"POST\":\n        filtros = {\n            \"tipo_registro\": (request.form.get(\"tipo_registro\") or \"\").lower(),\n            \"nombre\": (request.form.get(\"nombre\") or \"\").strip(),\n            \"especie\": (request.form.get(\"especie\") or \"\").strip(),\n            \"raza\": (request.form.get(\"raza\") or \"\").strip(),\n            \"edad\": (request.form.get(\"edad\") or \"\").strip(),\n            \"propietario_email\": (request.form.get(\"propietario_email\") or \"\").strip(),\n            \"propietario_telefono\": (request.form.get(\"propietario_telefono\") or \"\").strip(),\n            \"zona\": (request.form.get(\"zona\") or \"\").strip(),\n            \"color\": (request.form.get(\"color\") or \"\").strip(),\n            \"sexo\": (request.form.get(\"sexo\") or \"\").lower().strip(),\n            \"chip\": (request.form.get(\"chip\") or \"\").strip(),\n            \"tamano\": (request.form.get(\"tamano\") or \"\").lower().strip(),\n            \"peso\": (request.form.get(\"peso\") or \"\").strip(),\n            \"fecha_registro\": (request.form.get(\"fecha_registro\") or \"\").strip(),\n            \"fecha_aparecida\": (request.form.get(\"fecha_aparecida\") or \"\").strip(),\n            \"estado_aparecida\": (request.form.get(\"estado_aparecida\") or \"\").lower().strip(),\n            \"descripcion\": (request.form.get(\"descripcion\") or \"\").strip(),\n        }\n\n        if filtros[\"tipo_registro\"] in TIPOS_REGISTRO:\n            query = query.filter(Mascota.tipo_registro == filtros[\"tipo_registro\"])\n\n        if filtros[\"nombre\"]:\n            query = query.filter(Mascota.nombre.ilike(f\"%{filtros['nombre']}%\"))\n\n        if filtros[\"especie\"]:\n            query = query.filter(Mascota.especie.ilike(f\"%{filtros['especie']}%\"))\n\n        if filtros[\"raza\"]:\n            query = query.filter(Mascota.raza.ilike(f\"%{filtros['raza']}%\"))\n\n        if filtros[\"edad\"].isdigit():\n            query = query.filter(Mascota.edad == int(filtros[\"edad\"]))\n\n        if filtros[\"propietario_email\"]:\n            query = query.filter(Mascota.propietario_email.ilike(f\"%{filtros['propietario_email']}%\"))\n\n        if filtros[\"propietario_telefono\"]:\n            query = query.filter(Mascota.propietario_telefono.ilike(f\"%{filtros['propietario_telefono']}%\"))\n\n        if filtros[\"zona\"]:\n            query = query.filter(Mascota.zona.ilike(f\"%{filtros['zona']}%\"))\n\n        if filtros[\"color\"]:\n            query = query.filter(Mascota.color.ilike(f\"%{filtros['color']}%\"))\n\n        if filtros[\"sexo\"] in SEXOS:\n            query = query.filter(Mascota.sexo == filtros[\"sexo\"])\n\n        if filtros[\"chip\"]:\n            query = query.filter(Mascota.chip.ilike(f\"%{filtros['chip']}%\"))\n\n        if filtros[\"tamano\"] in TAMANOS:\n            query = query.filter(Mascota.tamano == filtros[\"tamano\"])\n\n        if filtros[\"peso\"]:\n            try:\n                peso_val = float(filtros[\"peso\"].replace(\",\", \".\"))\n                query = query.filter(Mascota.peso == peso_val)\n            except ValueError:\n                flash(\"Peso inv√°lido. Usa n√∫meros (puedes emplear coma o punto).\", \"error\")\n\n        if filtros[\"fecha_registro\"]:\n            fecha_filtrada = parse_fecha(filtros[\"fecha_registro\"])\n            if fecha_filtrada:\n                query = query.filter(Mascota.fecha_registro == fecha_filtrada)\n            else:\n                flash(\"Formato de fecha de registro inv√°lido. Usa dd/mm/aaaa.\", \"error\")\n\n        if filtros[\"fecha_aparecida\"]:\n            fecha_ap = parse_fecha(filtros[\"fecha_aparecida\"])\n            if fecha_ap:\n                query = query.filter(Mascota.fecha_aparecida == fecha_ap)\n            else:\n                flash(\"Formato de fecha de aparici√≥n inv√°lido.\", \"error\")\n\n        if filtros[\"estado_aparecida\"] in ESTADOS_APARECIDA:\n            query = query.filter(Mascota.estado_aparecida == filtros[\"estado_aparecida\"])\n\n        if filtros[\"descripcion\"]:\n            query = query.filter(Mascota.descripcion.ilike(f\"%{filtros['descripcion']}%\"))\n\n    mascotas = query.order_by(Mascota.fecha_registro.desc()).all()\n\n    if busqueda_realizada:\n        if not mascotas:\n            mensaje = \"No se encontraron mascotas.\"\n        else:\n            mascotas_con_fotos = _construir_mascotas_con_fotos(mascotas)\n\n    return render_template(\n        \"buscar.html\",\n        modo=\"buscar\",\n        mascotas=mascotas,\n        filtros=filtros,\n        busqueda_realizada=busqueda_realizada,\n        mensaje=mensaje,\n        mascotas_con_fotos=mascotas_con_fotos,\n    )\n\n\n@main.route(\"/modificar_mascotas\", methods=[\"GET\", \"POST\"])\ndef modificar_mascotas():\n    busqueda_realizada = request.method == \"POST\"\n    mensaje = None\n    mascotas_con_fotos = []\n\n    query = Mascota.query\n    filtros = construir_filtros_generales(request.form)\n\n    if request.method == \"POST\":\n        query = aplicar_filtros_generales(query, filtros)\n\n    mascotas = query.order_by(Mascota.fecha_registro.desc()).all()\n\n    if busqueda_realizada:\n        if not mascotas:\n            mensaje = \"No se encontraron mascotas.\"\n        else:\n            mascotas_con_fotos = _construir_mascotas_con_fotos(mascotas)\n\n    return render_template(\n        \"buscar.html\",\n        modo=\"modificar\",\n        mascotas=mascotas,\n        filtros=filtros,\n        busqueda_realizada=busqueda_realizada,\n        mensaje=mensaje,\n        mascotas_con_fotos=mascotas_con_fotos,\n    )\n\n\n@main.route(\"/comparar_mascotas/desaparecidas\", methods=[\"GET\", \"POST\"])\ndef comparar_mascotas_desaparecidas():\n    busqueda_realizada = request.method == \"POST\"\n    mensaje = None\n\n   # --- NUEVO: detectar si se pidi√≥ el modo ‚Äúidentificar raza‚Äù ---\n    modo_param = (\n        request.args.get(\"modo\")\n        or request.form.get(\"modo\")\n        or \"\"\n    ).strip().lower()\n    modo_vista = \"identificar_raza\" if modo_param == \"identificar_raza\" else \"comparar_desaparecidas\"\n    # ----------------------------------------------------------------\n\n    query = Mascota.query.filter(\n        Mascota.tipo_registro == \"desaparecida\",\n        Mascota.propietario_email.isnot(None),\n        Mascota.propietario_email != \"\",\n        Mascota.fecha_aparecida.is_(None),\n        or_(Mascota.estado_aparecida.is_(None), Mascota.estado_aparecida == \"\"),\n    )\n\n    filtros = construir_filtros_generales(request.form)\n    filtros[\"tipo_registro\"] = \"desaparecida\"\n\n    if request.method == \"POST\":\n        query = aplicar_filtros_generales(query, filtros)\n\n    mascotas = query.order_by(Mascota.fecha_registro.desc()).all()\n    if busqueda_realizada and not mascotas:\n        mensaje = \"No se localizaron mascotas desaparecidas que cumplan los criterios.\"\n\n    mascotas_con_fotos = _construir_mascotas_con_fotos(mascotas) if mascotas else []\n\n    return render_template(\n        \"buscar.html\",\n        modo=modo_vista,                     # <- usamos el modo detectado\n        mascotas=mascotas,\n        filtros=filtros,\n        busqueda_realizada=busqueda_realizada,\n        mensaje=mensaje,\n        mascotas_con_fotos=mascotas_con_fotos,\n    )\n\n@main.route(\"/mascotas/<int:mascota_id>/identificar_raza\", methods=[\"POST\"])\ndef identificar_raza_api(mascota_id: int):\n    \"\"\"\n    Endpoint que toma las fotos de la mascota desaparecida indicada,\n    llama a la utilidad identificar_raza(...) y devuelve el resultado en JSON.\n    \"\"\"\n    mascota = Mascota.query.get_or_404(mascota_id)\n\n    if (mascota.tipo_registro or \"\").lower() != \"desaparecida\":\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"Solo se pueden identificar razas de mascotas registradas como desaparecidas.\"\n        }), 400\n\n    fotos_validas = _obtener_fotos_validas(mascota)\n    rutas_abs = [foto[\"ruta_abs\"] for foto in fotos_validas if foto.get(\"ruta_abs\")]\n\n    if not rutas_abs:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"Esta mascota no tiene fotos disponibles para identificar la raza.\"\n        }), 400\n\n    # Opcional: limitar a las primeras 5 im√°genes\n    rutas_abs = rutas_abs[:5]\n\n    try:\n        resultado = identificar_raza(rutas_abs)\n    except ValueError as exc:\n        return jsonify({\"ok\": False, \"mensaje\": str(exc)}), 400\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al identificar raza para la mascota %s\", mascota_id\n        )\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": f\"Ocurri√≥ un error al identificar la raza: {exc}\"\n        }), 500\n\n    return jsonify({\"ok\": True, \"resultado\": resultado})\n\n@main.route(\"/comparar_mascotas/<int:desaparecida_id>/candidatas\", methods=[\"GET\"])\ndef comparar_mascotas_candidatas(desaparecida_id: int):\n    desaparecida = Mascota.query.get_or_404(desaparecida_id)\n\n    if not _es_mascota_desaparecida_valida(desaparecida):\n        flash(\"La mascota seleccionada no cumple los requisitos para comparar.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_desaparecidas\"))\n\n    if not _obtener_fotos_validas(desaparecida):\n        flash(\"Para comparar fotos, solo se pueden seleccionar registros con fotos.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_desaparecidas\"))\n\n    candidatas_query = Mascota.query.filter(\n        Mascota.tipo_registro == \"encontrada\",\n        Mascota.id != desaparecida.id,\n        Mascota.fotos.any(),\n    )\n\n     # Restringir a la misma especie\n    especie_ref = (desaparecida.especie or \"\").strip()\n    if especie_ref:\n        candidatas_query = candidatas_query.filter(\n            func.lower(Mascota.especie) == especie_ref.lower()\n        )\n\n    if desaparecida.fecha_registro:\n        candidatas_query = candidatas_query.filter(\n            Mascota.fecha_registro >= desaparecida.fecha_registro\n        )\n\n    candidatas = candidatas_query.order_by(Mascota.fecha_registro.asc()).all()\n    candidatas_con_fotos = _construir_mascotas_con_fotos(candidatas)\n\n    if not candidatas:\n        flash(\n            \"No se encontraron mascotas encontradas con fotos posteriores a la fecha de desaparici√≥n.\",\n            \"warning\"\n        )\n\n    return render_template(\n        \"comparar_candidatas.html\",\n        mascota_desaparecida=desaparecida,\n        candidatas=candidatas,\n        candidatas_con_fotos=candidatas_con_fotos,\n    )\n\n\n@main.route(\n    \"/comparar_mascotas/<int:desaparecida_id>/con/<int:encontrada_id>\",\n    methods=[\"GET\", \"POST\"]\n)\ndef comparar_mascotas_detalle(desaparecida_id: int, encontrada_id: int):\n    mascota_desaparecida = Mascota.query.get_or_404(desaparecida_id)\n    mascota_encontrada = Mascota.query.get_or_404(encontrada_id)\n\n    if not _es_mascota_desaparecida_valida(mascota_desaparecida):\n        flash(\"La mascota desaparecida seleccionada ya no es v√°lida para comparar.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_desaparecidas\"))\n\n    if (mascota_encontrada.tipo_registro or \"\").lower() != \"encontrada\":\n        flash(\"La mascota encontrada seleccionada no es v√°lida.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_candidatas\", desaparecida_id=desaparecida_id))\n\n    fotos_desap = _obtener_fotos_validas(mascota_desaparecida)\n    fotos_encon = _obtener_fotos_validas(mascota_encontrada)\n\n    if not fotos_desap or not fotos_encon:\n        flash(\"No hay fotos suficientes para realizar la comparaci√≥n.\", \"error\")\n        return redirect(url_for(\"main.comparar_mascotas_candidatas\", desaparecida_id=desaparecida_id))\n\n    fotos_desap_por_tipo = _agrupar_fotos_por_tipo(fotos_desap)\n    fotos_encon_por_tipo = _agrupar_fotos_por_tipo(fotos_encon)\n    tipos_comunes = sorted(set(fotos_desap_por_tipo.keys()) & set(fotos_encon_por_tipo.keys()))\n\n    tipos_compartidos = {\n        \"desaparecida\": sorted([tipo for tipo, fotos in fotos_desap_por_tipo.items() if fotos]),\n        \"encontrada\": sorted([tipo for tipo, fotos in fotos_encon_por_tipo.items() if fotos]),\n    }\n\n    diagnostico_individual = None\n    diagnosticos_globales: List[Dict[str, object]] = []\n    error = None\n\n    fotos_desap_dict = {str(foto[\"id\"]): foto for foto in fotos_desap}\n    fotos_encon_dict = {str(foto[\"id\"]): foto for foto in fotos_encon}\n    data_url_cache: Dict[int, str] = {}\n\n    if request.method == \"POST\":\n        accion = (request.form.get(\"accion\") or \"\").strip()\n\n        if accion == \"comparar_tipo\":\n            tipo = (request.form.get(\"tipo_foto\") or \"\").strip().lower()\n            foto_desap_id = request.form.get(\"foto_desaparecida\") or \"\"\n            foto_encon_id = request.form.get(\"foto_encontrada\") or \"\"\n\n            if tipo not in tipos_comunes:\n                error = \"El tipo de foto seleccionado no es v√°lido.\"\n            else:\n                foto_desap = fotos_desap_dict.get(foto_desap_id)\n                foto_encon = fotos_encon_dict.get(foto_encon_id)\n\n                if not foto_desap or not foto_encon:\n                    error = \"Debes seleccionar una foto de cada mascota.\"\n                elif foto_desap[\"tipo_foto\"] != tipo or foto_encon[\"tipo_foto\"] != tipo:\n                    error = \"Las fotos seleccionadas no coinciden con el tipo elegido.\"\n                else:\n                    try:\n                        data_desap = data_url_cache.setdefault(\n                            foto_desap[\"id\"],\n                            image_to_data_url(foto_desap[\"ruta_abs\"])\n                        )\n                        data_encon = data_url_cache.setdefault(\n                            foto_encon[\"id\"],\n                            image_to_data_url(foto_encon[\"ruta_abs\"])\n                        )\n                        prompt = (\n                            f\"Compara estas dos fotos de perros (tipo de foto: {tipo}). \"\n                            \"¬øCorresponden al mismo perro? Da un porcentaje aproximado de match \"\n                            \"(0-100%) y explica brevemente tu conclusi√≥n.\"\n                        )\n                        resultado = _comparar_imagenes_openai(prompt, [data_desap, data_encon])\n                        diagnostico_individual = {\n                            \"tipo\": tipo,\n                            \"foto_desap\": foto_desap,\n                            \"foto_encon\": foto_encon,\n                            \"resultado\": resultado,\n                        }\n                    except Exception as exc:\n                        current_app.logger.exception(\n                            \"Error al comparar fotos (tipo igual) desaparecida %s vs encontrada %s\",\n                            desaparecida_id,\n                            encontrada_id\n                        )\n                        error = f\"Error al comparar las fotos: {exc}\"\n\n        elif accion == \"comparar_todas\":\n            for foto_desap in fotos_desap:\n                try:\n                    data_desap = data_url_cache.setdefault(\n                        foto_desap[\"id\"],\n                        image_to_data_url(foto_desap[\"ruta_abs\"])\n                    )\n                except Exception as exc:\n                    current_app.logger.exception(\n                        \"Error al convertir la foto %s de la desaparecida %s\",\n                        foto_desap[\"id\"],\n                        desaparecida_id\n                    )\n                    diagnosticos_globales.append({\n                        \"foto_desap\": foto_desap,\n                        \"foto_encon\": None,\n                        \"resultado\": f\"No se pudo procesar la foto de la desaparecida: {exc}\",\n                    })\n                    continue\n\n                for foto_encon in fotos_encon:\n                    try:\n                        data_encon = data_url_cache.setdefault(\n                            foto_encon[\"id\"],\n                            image_to_data_url(foto_encon[\"ruta_abs\"])\n                        )\n                        resultado = _comparar_imagenes_openai(\n                            PROMPT_COMPARAR_DOS,\n                            [data_desap, data_encon]\n                        )\n                        diagnosticos_globales.append({\n                            \"foto_desap\": foto_desap,\n                            \"foto_encon\": foto_encon,\n                            \"resultado\": resultado,\n                        })\n                    except Exception as exc:\n                        current_app.logger.exception(\n                            \"Error al comparar fotos (todas) desaparecida %s vs encontrada %s\",\n                            desaparecida_id,\n                            encontrada_id\n                        )\n                        diagnosticos_globales.append({\n                            \"foto_desap\": foto_desap,\n                            \"foto_encon\": foto_encon,\n                            \"resultado\": f\"No se pudo comparar este par de fotos: {exc}\",\n                        })\n\n        else:\n            error = \"Acci√≥n no reconocida para la comparaci√≥n.\"\n\n    return render_template(\n        \"comparar_parejas.html\",\n        mascota_desaparecida=mascota_desaparecida,\n        mascota_encontrada=mascota_encontrada,\n        fotos_desap_por_tipo=fotos_desap_por_tipo,\n        fotos_encon_por_tipo=fotos_encon_por_tipo,\n        tipos_comunes=tipos_comunes,\n        tipos_compartidos=tipos_compartidos,\n        diagnostico_individual=diagnostico_individual,\n        diagnosticos_globales=diagnosticos_globales,\n        error=error,\n        url_comparar_tipo=url_for(\n                \"main.comparar_pareja_tipo_api\",\n                desaparecida_id=desaparecida_id,\n                encontrada_id=encontrada_id,\n            ),\n            url_comparar_todas=url_for(\n                \"main.comparar_pareja_todas_api\",\n                desaparecida_id=desaparecida_id,\n                encontrada_id=encontrada_id,\n            ),\n        )\n\n@main.route(\n    \"/comparaciones/desaparecida/<int:desaparecida_id>/encontrada/<int:encontrada_id>/comparar_tipo\",\n    methods=[\"POST\"],\n)\ndef comparar_pareja_tipo_api(desaparecida_id: int, encontrada_id: int):\n    \"\"\"\n    Endpoint JSON utilizado por la plantilla comparar_parejas.html.\n    Recibe el tipo de foto y las referencias de cada imagen, ejecuta la comparaci√≥n\n    y devuelve el texto (y porcentaje estimado si se puede extraer).\n    \"\"\"\n    mascota_desaparecida = Mascota.query.get_or_404(desaparecida_id)\n    mascota_encontrada = Mascota.query.get_or_404(encontrada_id)\n\n    if not _es_mascota_desaparecida_valida(mascota_desaparecida):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota desaparecida ya no es v√°lida para comparar.\"\n        }), 400\n\n    if (mascota_encontrada.tipo_registro or \"\").lower() != \"encontrada\":\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota encontrada indicada no es v√°lida.\"\n        }), 400\n\n    payload = request.get_json(silent=True) or {}\n    tipo = (payload.get(\"tipo\") or \"\").strip().lower()\n    if not tipo:\n        return jsonify({\"ok\": False, \"mensaje\": \"Debes indicar el tipo de foto a comparar.\"}), 400\n\n    foto_desap_payload = payload.get(\"foto_desap\") or {}\n    foto_encon_payload = payload.get(\"foto_encon\") or {}\n\n    fotos_desap_validas = _obtener_fotos_validas(mascota_desaparecida)\n    fotos_encon_validas = _obtener_fotos_validas(mascota_encontrada)\n    fotos_desap_por_tipo = _agrupar_fotos_por_tipo(fotos_desap_validas)\n    fotos_encon_por_tipo = _agrupar_fotos_por_tipo(fotos_encon_validas)\n\n    if tipo not in fotos_desap_por_tipo or tipo not in fotos_encon_por_tipo:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"Ninguna de las mascotas tiene fotos de ese tipo.\"\n        }), 400\n\n    foto_desap_id = str(foto_desap_payload.get(\"id\") or \"\")\n    foto_encon_id = str(foto_encon_payload.get(\"id\") or \"\")\n\n    foto_desap_datos = None\n    if foto_desap_id:\n        foto_desap_datos = next((f for f in fotos_desap_por_tipo[tipo] if str(f[\"id\"]) == foto_desap_id), None)\n    if not foto_desap_datos:\n        ruta_abs = _extraer_ruta_absoluta_payload(foto_desap_payload)\n        if not ruta_abs:\n            return jsonify({\n                \"ok\": False,\n                \"mensaje\": \"No se pudo localizar la ruta de la foto desaparecida.\"\n            }), 400\n        foto_desap_datos = {\"ruta_abs\": ruta_abs, \"id\": foto_desap_id or None, \"tipo_foto\": tipo}\n\n    foto_encon_datos = None\n    if foto_encon_id:\n        foto_encon_datos = next((f for f in fotos_encon_por_tipo[tipo] if str(f[\"id\"]) == foto_encon_id), None)\n    if not foto_encon_datos:\n        ruta_abs = _extraer_ruta_absoluta_payload(foto_encon_payload)\n        if not ruta_abs:\n            return jsonify({\n                \"ok\": False,\n                \"mensaje\": \"No se pudo localizar la ruta de la foto encontrada.\"\n            }), 400\n        foto_encon_datos = {\"ruta_abs\": ruta_abs, \"id\": foto_encon_id or None, \"tipo_foto\": tipo}\n\n    ruta_desap_abs = foto_desap_datos.get(\"ruta_abs\")\n    ruta_encon_abs = foto_encon_datos.get(\"ruta_abs\")\n\n    if not ruta_desap_abs or not os.path.isfile(ruta_desap_abs):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La imagen de la mascota desaparecida no existe en disco.\"\n        }), 404\n\n    if not ruta_encon_abs or not os.path.isfile(ruta_encon_abs):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La imagen de la mascota encontrada no existe en disco.\"\n        }), 404\n\n    try:\n        data_desap = image_to_data_url(ruta_desap_abs)\n        data_encon = image_to_data_url(ruta_encon_abs)\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al convertir im√°genes a data URL para la pareja (%s, %s)\",\n            desaparecida_id, encontrada_id\n        )\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": f\"No se pudieron procesar las im√°genes: {exc}\"\n        }), 500\n\n    prompt = (\n        f\"Compara estas dos fotos (tipo: {tipo}). \"\n        \"¬øCorresponden al mismo perro? Da un porcentaje aproximado de match (0-100%) \"\n        \"y explica brevemente tu conclusi√≥n.\"\n    )\n\n    try:\n        resultado_texto = _comparar_imagenes_openai(prompt, [data_desap, data_encon])\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al invocar la comparaci√≥n OpenAI para la pareja (%s, %s)\",\n            desaparecida_id, encontrada_id\n        )\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": f\"Ocurri√≥ un error al comparar las im√°genes: {exc}\"\n        }), 500\n\n    score = None\n    match = re.search(r\"(\\d{1,3})\\s*%\", resultado_texto or \"\", re.UNICODE)\n    if match:\n        try:\n            score_val = int(match.group(1))\n            score = max(0, min(100, score_val))\n        except ValueError:\n            score = None\n\n    return jsonify({\n        \"ok\": True,\n        \"mensaje\": resultado_texto,\n        \"score\": score,\n        \"tipo\": tipo,\n        \"foto_desap_id\": foto_desap_datos.get(\"id\"),\n        \"foto_encon_id\": foto_encon_datos.get(\"id\"),\n    })\n\n@main.route(\n    \"/comparaciones/desaparecida/<int:desaparecida_id>/encontrada/<int:encontrada_id>/comparar_todas\",\n    methods=[\"POST\"],\n)\ndef comparar_pareja_todas_api(desaparecida_id: int, encontrada_id: int):\n    mascota_desaparecida = Mascota.query.get_or_404(desaparecida_id)\n    mascota_encontrada = Mascota.query.get_or_404(encontrada_id)\n\n    if not _es_mascota_desaparecida_valida(mascota_desaparecida):\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota desaparecida ya no es v√°lida para comparar.\"\n        }), 400\n\n    if (mascota_encontrada.tipo_registro or \"\").lower() != \"encontrada\":\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota encontrada indicada no es v√°lida.\"\n        }), 400\n\n    fotos_desap = _obtener_fotos_validas(mascota_desaparecida)\n    fotos_encon = _obtener_fotos_validas(mascota_encontrada)\n\n    if not fotos_desap:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota desaparecida no tiene fotos disponibles.\"\n        }), 400\n\n    if not fotos_encon:\n        return jsonify({\n            \"ok\": False,\n            \"mensaje\": \"La mascota encontrada no tiene fotos disponibles.\"\n        }), 400\n\n    rutas_desap = [foto[\"ruta_abs\"] for foto in fotos_desap if foto.get(\"ruta_abs\")]\n    rutas_encon = [foto[\"ruta_abs\"] for foto in fotos_encon if foto.get(\"ruta_abs\")]\n\n    try:\n        resultado = comparar_fotos_todas(rutas_desap, rutas_encon)\n    except ValueError as exc:\n        return jsonify({\"ok\": False, \"mensaje\": str(exc)}), 400\n    except Exception as exc:\n        current_app.logger.exception(\n            \"Error al comparar todas las fotos (desaparecida %s vs encontrada %s)\",\n            desaparecida_id,\n            encontrada_id,\n        )\n        return jsonify({\"ok\": False, \"mensaje\": f\"Error al comparar las fotos: {exc}\"}), 500\n\n    return jsonify(resultado)\n\n@main.route(\"/verificar_mascota\", methods=[\"POST\"])\ndef verificar_mascota():\n    tipo_registro = (request.args.get(\"tipo_registro\") or \"desaparecida\").lower()\n    nombre = (request.form.get(\"nombre\") or \"\").strip()\n    especie = (request.form.get(\"especie\") or \"\").strip()\n    raza = (request.form.get(\"raza\") or \"\").strip()\n\n    existe = False\n    if tipo_registro == \"desaparecida\" and nombre and especie and raza:\n        existe = (\n            Mascota.query.filter_by(\n                tipo_registro=tipo_registro,\n                nombre=nombre,\n                especie=especie,\n                raza=raza\n            ).first()\n            is not None\n        )\n\n    return jsonify({\"existe\": existe})\n\n\n@main.route(\"/comparar_fotos\", methods=[\"GET\", \"POST\"])\ndef comparar_fotos():\n    resultado = None\n    error = None\n\n    if request.method == \"POST\":\n        imagenes = request.files.getlist(\"fotos\")\n        imagenes_validas = [img for img in imagenes if img and allowed_file(img.filename)]\n        if not imagenes_validas:\n            error = \"Debes subir al menos una imagen v√°lida (jpg, png, webp, gif).\"\n            return render_template(\"comparar.html\", resultado=resultado, error=error)\n\n        rutas = []\n        for img in imagenes_validas:\n            nombre = secure_filename(f\"{uuid.uuid4().hex}_{img.filename}\")\n            ruta_fs = os.path.join(UPLOAD_FOLDER, nombre)\n            \n            img.save(ruta_fs)\n            rutas.append(ruta_fs)\n\n        try:\n            if len(rutas) == 1:\n                data1 = image_to_data_url(rutas[0])\n                resultado = _comparar_imagenes_openai(PROMPT_IDENTIFICAR_RAZA, [data1])\n            elif len(rutas) >= 2:\n                data_urls = [image_to_data_url(p) for p in rutas[:2]]\n                resultado = _comparar_imagenes_openai(PROMPT_COMPARAR_DOS, data_urls)\n        except Exception as exc:\n            current_app.logger.exception(\"Error al procesar im√°genes en /comparar_fotos\")\n            error = f\"Error al procesar las im√°genes: {exc}\"\n        finally:\n            for ruta in rutas:\n                if os.path.isfile(ruta):\n                    try:\n                        os.remove(ruta)\n                        \n                    except OSError:\n                        current_app.logger.warning(\"No se pudo eliminar la imagen temporal %s\", ruta)\n\n    return render_template(\"comparar.html\", resultado=resultado, error=error)"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "Perfecto, gracias por pegar el `routes.py`. Aqu√≠ tienes los cambios puntuales para a√±adir el endpoint `/foto/<id>` y hacer que el resto de la app use esa URL sin tocar plantillas:\n\n---\n\n## 1. Agrega las importaciones\n\nEn el bloque inicial de imports (donde ya est√° `Blueprint`, etc.), a√±ade:\n\n```python\nfrom flask import (\n    Blueprint, render_template, request, redirect,\n    url_for, flash, jsonify, current_app,\n    send_file, abort  # <--- agrega estos dos\n)\n```\n\n(`io` ya est√° importado, lo usaremos en el endpoint.)\n\n---\n\n## 2. Helper para construir la URL de la foto\n\nCerca de los otros helpers (por ejemplo inmediatamente despu√©s de `eliminar_foto_obj`), a√±ade:\n\n```python\ndef _foto_url(foto_id: int) -> str:\n    return url_for(\"main.ver_foto\", foto_id=foto_id)\n```\n\nAs√≠ centralizamos la generaci√≥n de la URL nueva.\n\n---\n\n## 3. Endpoint `/foto/<id>`\n\nM√°s abajo, antes de las vistas principales (por ejemplo justo despu√©s de `eliminar_foto_obj` o antes de `obtener_fotos_existentes`), incorpora:\n\n```python\n@main.route(\"/foto/<int:foto_id>\")\ndef ver_foto(foto_id: int):\n    foto = Foto.query.get_or_404(foto_id)\n\n    if foto.data:\n        return send_file(\n            io.BytesIO(foto.data),\n            mimetype=foto.mime_type or \"application/octet-stream\",\n            download_name=foto.nombre_archivo or None,\n        )\n\n    ruta_rel = normalizar_ruta_foto(foto.ruta)\n    if ruta_rel:\n        ruta_abs = _resolver_ruta_absoluta(ruta_rel)\n        if ruta_abs and os.path.isfile(ruta_abs):\n            return send_file(\n                ruta_abs,\n                mimetype=foto.mime_type or \"application/octet-stream\",\n                download_name=foto.nombre_archivo or None,\n            )\n\n    abort(404)\n```\n\n- Primero intenta servir el binario guardado en la BD.\n- Si la columna `data` est√° vac√≠a (por fotos viejas), cae al archivo en disco.\n- `download_name` conserva el nombre original si quieres habilitar la descarga directa.\n\n---\n\n## 4. Actualiza los helpers que devuelven datos de fotos\n\nEstos m√©todos son los que alimentan las plantillas. S√≥lo cambia la construcci√≥n de la URL:\n\n### `obtener_fotos_existentes`\n\nReemplaza la parte donde agregas el diccionario por:\n\n```python\n        fotos_serializadas.append({\n            \"id\": foto.id,\n            \"tipo_foto\": foto.tipo_foto,\n            \"ruta\": f\"static/{ruta_rel}\",\n            \"url\": _foto_url(foto.id),\n        })\n```\n\n(Conservamos `ruta` tal cual para no romper ning√∫n JavaScript antiguo; pero `url` ahora apunta al endpoint nuevo.)\n\n### `_construir_mascotas_con_fotos`\n\nDentro del bucle donde armas `fotos_info`:\n\n```python\n                fotos_info.append({\n                    \"id\": foto.id,\n                    \"tipo_foto\": foto.tipo_foto,\n                    \"ruta\": f\"static/{ruta_relativa}\",\n                    \"url\": _foto_url(foto.id),\n                })\n```\n\n### `_serializar_foto`\n\nEn el `return { ... }`, cambia la clave `\"url\"`:\n\n```python\n    return {\n        \"id\": foto.id,\n        \"tipo_foto\": tipo,\n        \"ruta_rel\": ruta_rel,\n        \"ruta_abs\": ruta_abs,\n        \"url\": _foto_url(foto.id),\n    }\n```\n\nEl resto del helper se queda igual (seguimos proporcionando `ruta_abs` porque varios procesos a√∫n leen desde disco).\n\n---\n\n## 5. Prueba r√°pida\n\n1. Arranca la app (`flask run`).\n2. Navega a la ficha de alguna mascota y verifica que las im√°genes cargan (la plantilla ahora est√° apuntando a `/foto/<id>` de forma transparente).\n3. Abre una imagen en una pesta√±a nueva y confirma que la URL es del tipo `http://127.0.0.1:5000/foto/2`.\n4. Opcional: en consola revisa que el endpoint funciona tambi√©n con registros antiguos (los que todav√≠a no tienen `data` en BD).\n\nCon eso ya tienes las fotos servidas desde tu backend usando la informaci√≥n binaria de la base. El siguiente paso ser√° reutilizar esta misma URL cuando despleguemos la app y/o cuando el script de Instagram necesite una imagen p√∫blica.\n\n¬øListo para seguir con el ajuste de las plantillas o con el script de publicaci√≥n?"
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "funciona la busqueda y la creacion, pero solo veo los registros nuevos que he creado con postgreSQL , es normal?"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "S√≠, es totalmente normal. Ahora la aplicaci√≥n est√° apuntando a **PostgreSQL**, que es una base nueva y vac√≠a (salvo lo que hayas creado despu√©s del cambio). Tus registros anteriores siguen estando en el archivo SQLite que usabas antes; no se borraron, pero ya no se est√°n leyendo porque cambiamos de motor.\n\nSi quieres recuperar esos datos antiguos tienes que migrarlos desde el archivo SQLite hacia PostgreSQL. Hay varias formas de hacerlo:\n\n1. **Exportar desde SQLite e importar en PostgreSQL** (por ejemplo usando `sqlite3` para sacar un `.sql` y luego adaptarlo a PostgreSQL, o usar herramientas como `pgloader`).\n2. **Escribir un script en Python** que abra ambos motores via SQLAlchemy, consulte los datos en SQLite y los inserte en PostgreSQL.\n3. **Exportar a CSV** (con alg√∫n cliente o con el propio SQLite) e importar esos CSV en PostgreSQL con `COPY`.\n\nAv√≠same qu√© opci√≥n te resulta m√°s c√≥moda y te gu√≠o con los pasos concretos (incluyendo c√≥mo localizar el archivo SQLite que usaba la app)."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "no necesito recuperar la BD sqlite , lo que si es bueno seria modificar el init_db.py , para reiniciar la bd y cargar algunos registros de prueba, el problema es que este carga las fotos deel PC y no se si para postgresql haria falta pasarlas a modo url? este es el programa :\nfrom datetime import date\nfrom app import app\nfrom web.models import db, Mascota, FotoMascotaDesaparecida\nfrom sqlalchemy.exc import IntegrityError\n\nwith app.app_context():\n    db.drop_all()\n    db.create_all()\n\n    mascotas = [\n        Mascota(\n            nombre=\"Firulais\",\n            especie=\"Perro\",\n            raza=\"Labrador\",\n            edad=3,\n            propietario_email=\"juan@example.com\",\n            propietario_telefono=\"600000001\",\n            zona=\"Centro\",\n            tipo_registro=\"desaparecida\",\n            color=\"marr√≥n\",\n            descripcion=\"Labrador con collar rojo.\",\n            chip=\"123456789012345\",\n            sexo=\"macho\",\n            peso=28.5,\n            tamano=\"grande\",\n            fecha_registro=date(2025, 10, 1)\n        ),\n        Mascota(\n            nombre=\"encontrada\",  # opcional: para simular tu l√≥gica real\n            especie=\"Gato\",\n            raza=\"Siam√©s\",\n            edad=2,\n            propietario_email=\"ana@example.com\",\n            propietario_telefono=\"600000002\",\n            zona=\"Norte\",\n            tipo_registro=\"encontrada\",\n            color=\"crema\",\n            descripcion=\"Con cascabel azul.\",\n            chip=None,\n            sexo=\"hembra\",\n            peso=4.2,\n            tamano=\"peque√±o\",\n            fecha_registro=date(2025, 10, 2)\n        ),\n        Mascota(\n            nombre=\"Rocky\",\n            especie=\"Perro\",\n            raza=\"Pastor Alem√°n\",\n            edad=4,\n            propietario_email=\"luis@example.com\",\n            propietario_telefono=\"600000003\",\n            zona=\"Este\",\n            tipo_registro=\"desaparecida\",\n            color=\"negro y fuego\",\n            descripcion=None,\n            chip=None,\n            sexo=\"macho\",\n            peso=32.0,\n            tamano=\"grande\",\n            fecha_registro=date(2025, 10, 3)\n        ),\n        Mascota(\n            nombre=\"encontrada\",  # opcional\n            especie=\"Gato\",\n            raza=\"Com√∫n\",\n            edad=1,\n            propietario_email=\"marta@example.com\",\n            propietario_telefono=\"600000004\",\n            zona=\"Oeste\",\n            tipo_registro=\"encontrada\",\n            color=\"atigrado\",\n            descripcion=\"Muy cari√±osa.\",\n            chip=None,\n            sexo=\"hembra\",\n            peso=3.8,\n            tamano=\"peque√±o\",\n            fecha_registro=date(2025, 10, 4)\n        ),\n        Mascota(\n            nombre=\"Toby\",\n            especie=\"Perro\",\n            raza=\"Beagle\",\n            edad=5,\n            propietario_email=\"pablo@example.com\",\n            propietario_telefono=\"600000005\",\n            zona=\"Centro\",\n            tipo_registro=\"desaparecida\",\n            color=\"tricolor\",\n            descripcion=None,\n            chip=None,\n            sexo=\"macho\",\n            peso=12.5,\n            tamano=\"mediano\",\n            fecha_registro=date(2025, 10, 5)\n        ),\n        Mascota(\n            nombre=\"encontrada\",  # opcional\n            especie=\"Perro\",\n            raza=\"Mestizo\",\n            edad=2,\n            propietario_email=\"sofia@example.com\",\n            propietario_telefono=\"600000006\",\n            zona=\"Sur\",\n            tipo_registro=\"encontrada\",\n            color=\"blanco\",\n            descripcion=None,\n            chip=None,\n            sexo=\"hembra\",\n            peso=10.0,\n            tamano=\"mediano\",\n            fecha_registro=date(2025, 10, 6)\n        ),\n        Mascota(\n            nombre=\"Coco\",\n            especie=\"Gato\",\n            raza=\"Maine Coon\",\n            edad=3,\n            propietario_email=\"raul@example.com\",\n            propietario_telefono=\"600000007\",\n            zona=\"Norte\",\n            tipo_registro=\"desaparecida\",\n            color=\"gris\",\n            descripcion=None,\n            chip=None,\n            sexo=\"macho\",\n            peso=6.5,\n            tamano=\"mediano\",\n            fecha_registro=date(2025, 10, 7)\n        ),\n        Mascota(\n            nombre=\"encontrada\",  # opcional\n            especie=\"Perro\",\n            raza=\"Pomerania\",\n            edad=1,\n            propietario_email=\"laura@example.com\",\n            propietario_telefono=\"600000008\",\n            zona=\"Centro\",\n            tipo_registro=\"encontrada\",\n            color=\"naranja\",\n            descripcion=None,\n            chip=None,\n            sexo=\"hembra\",\n            peso=2.8,\n            tamano=\"peque√±o\",\n            fecha_registro=date(2025, 10, 8)\n        ),\n    ]\n\n    try:\n        db.session.add_all(mascotas)\n        db.session.commit()\n    except IntegrityError as exc:\n        db.session.rollback()\n        print(\"ERROR UNIQUE al insertar mascotas:\", exc)\n        raise\n\n    fotos = [\n        FotoMascotaDesaparecida(\n            mascota_id=mascotas[0].id, tipo_foto=\"cara\", ruta=\"static/fotos/frontal4.jpg\"\n        ),\n        FotoMascotaDesaparecida(\n            mascota_id=mascotas[2].id, tipo_foto=\"frontal\", ruta=\"static/fotos/frontal1.jpg\"\n        ),\n        FotoMascotaDesaparecida(\n            mascota_id=mascotas[4].id, tipo_foto=\"lateral_izquierdo\", ruta=\"static/fotos/lateral1.jpg\"\n        ),\n        FotoMascotaDesaparecida(\n            mascota_id=mascotas[6].id, tipo_foto=\"cara\", ruta=\"static/fotos/lateral2.jpg\"\n        ),\n    ]\n    try:\n        db.session.add_all(fotos)\n        db.session.commit()\n    except IntegrityError as exc:\n        db.session.rollback()\n        print(\"ERROR UNIQUE al insertar fotos:\", exc)\n        raise\n\n    print(\"‚úÖ Base de datos inicializada con ejemplos (mascotas y fotos).\")"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "S√≠, para que `init_db.py` siga siendo √∫til con PostgreSQL necesitas que tambi√©n alimente los nuevos campos binarios (`data`, `mime_type`, `nombre_archivo`, `tamano_bytes`). La idea es que el script lea las im√°genes de `web/static/fotos/`, cargue el contenido y lo inserte en la tabla junto con la ruta ‚Äúhist√≥rica‚Äù. As√≠ cualquier endpoint (el nuevo `/foto/<id>` incluido) podr√° servir esos registros.\n\nAqu√≠ tienes una versi√≥n actualizada de `init_db.py` lista para copiar/pegar (solo recuerda ajustarla si tienes rutas distintas):\n\n```python\nimport os\nimport mimetypes\nfrom datetime import date\n\nfrom flask import current_app\nfrom app import app\nfrom web.models import db, Mascota, FotoMascotaDesaparecida as Foto\nfrom sqlalchemy.exc import IntegrityError\n\ndef _static_root():\n    \"\"\"\n    Devuelve la carpeta static configurada en Flask (cuando existe) o\n    hace fallback al directorio web/static del proyecto.\n    \"\"\"\n    try:\n        return current_app.static_folder or os.path.join(os.path.dirname(__file__), \"web\", \"static\")\n    except RuntimeError:\n        return os.path.join(os.path.dirname(__file__), \"web\", \"static\")\n\ndef _cargar_foto(rel_path):\n    \"\"\"\n    Carga una foto ubicada dentro de static/‚Ä¶ devolviendo:\n      - ruta_rel normalizada (sin prefijo ‚Äústatic/‚Äù)\n      - bytes (o None si no existe el archivo f√≠sico)\n      - mime_type, nombre_archivo y tama√±o\n    \"\"\"\n    if not rel_path:\n        return None\n\n    rel_path = rel_path.strip().lstrip(\"/\")\n\n    # Si viene con ‚Äústatic/‚Äù, rec√≥rtalo para mantener consistencia con la app\n    if rel_path.lower().startswith(\"static/\"):\n        rel_path = rel_path.split(\"/\", 1)[1]\n\n    ruta_abs = os.path.join(_static_root(), rel_path.replace(\"/\", os.sep))\n\n    if not os.path.isfile(ruta_abs):\n        print(f\"[init_db] ‚ö†Ô∏è Archivo no encontrado: {ruta_abs}\")\n        return {\n            \"ruta_rel\": rel_path,\n            \"data\": None,\n            \"mime_type\": mimetypes.guess_type(rel_path)[0] or \"application/octet-stream\",\n            \"nombre_archivo\": os.path.basename(rel_path),\n            \"tamano_bytes\": None,\n        }\n\n    with open(ruta_abs, \"rb\") as f:\n        data = f.read()\n\n    return {\n        \"ruta_rel\": rel_path,\n        \"data\": data,\n        \"mime_type\": mimetypes.guess_type(rel_path)[0] or \"application/octet-stream\",\n        \"nombre_archivo\": os.path.basename(rel_path),\n        \"tamano_bytes\": len(data),\n    }\n\nwith app.app_context():\n    db.drop_all()\n    db.create_all()\n\n    mascotas = [\n        Mascota(\n            nombre=\"Firulais\",\n            especie=\"Perro\",\n            raza=\"Labrador\",\n            edad=3,\n            propietario_email=\"juan@example.com\",\n            propietario_telefono=\"600000001\",\n            zona=\"Centro\",\n            tipo_registro=\"desaparecida\",\n            color=\"marr√≥n\",\n            descripcion=\"Labrador con collar rojo.\",\n            chip=\"123456789012345\",\n            sexo=\"macho\",\n            peso=28.5,\n            tamano=\"grande\",\n            fecha_registro=date(2025, 10, 1),\n        ),\n        Mascota(\n            nombre=\"encontrada\",\n            especie=\"Gato\",\n            raza=\"Siam√©s\",\n            edad=2,\n            propietario_email=\"ana@example.com\",\n            propietario_telefono=\"600000002\",\n            zona=\"Norte\",\n            tipo_registro=\"encontrada\",\n            color=\"crema\",\n            descripcion=\"Con cascabel azul.\",\n            chip=None,\n            sexo=\"hembra\",\n            peso=4.2,\n            tamano=\"peque√±o\",\n            fecha_registro=date(2025, 10, 2),\n        ),\n        Mascota(\n            nombre=\"Rocky\",\n            especie=\"Perro\",\n            raza=\"Pastor Alem√°n\",\n            edad=4,\n            propietario_email=\"luis@example.com\",\n            propietario_telefono=\"600000003\",\n            zona=\"Este\",\n            tipo_registro=\"desaparecida\",\n            color=\"negro y fuego\",\n            descripcion=None,\n            chip=None,\n            sexo=\"macho\",\n            peso=32.0,\n            tamano=\"grande\",\n            fecha_registro=date(2025, 10, 3),\n        ),\n        Mascota(\n            nombre=\"encontrada\",\n            especie=\"Gato\",\n            raza=\"Com√∫n\",\n            edad=1,\n            propietario_email=\"marta@example.com\",\n            propietario_telefono=\"600000004\",\n            zona=\"Oeste\",\n            tipo_registro=\"encontrada\",\n            color=\"atigrado\",\n            descripcion=\"Muy cari√±osa.\",\n            chip=None,\n            sexo=\"hembra\",\n            peso=3.8,\n            tamano=\"peque√±o\",\n            fecha_registro=date(2025, 10, 4),\n        ),\n        Mascota(\n            nombre=\"Toby\",\n            especie=\"Perro\",\n            raza=\"Beagle\",\n            edad=5,\n            propietario_email=\"pablo@example.com\",\n            propietario_telefono=\"600000005\",\n            zona=\"Centro\",\n            tipo_registro=\"desaparecida\",\n            color=\"tricolor\",\n            descripcion=None,\n            chip=None,\n            sexo=\"macho\",\n            peso=12.5,\n            tamano=\"mediano\",\n            fecha_registro=date(2025, 10, 5),\n        ),\n        Mascota(\n            nombre=\"encontrada\",\n            especie=\"Perro\",\n            raza=\"Mestizo\",\n            edad=2,\n            propietario_email=\"sofia@example.com\",\n            propietario_telefono=\"600000006\",\n            zona=\"Sur\",\n            tipo_registro=\"encontrada\",\n            color=\"blanco\",\n            descripcion=None,\n            chip=None,\n            sexo=\"hembra\",\n            peso=10.0,\n            tamano=\"mediano\",\n            fecha_registro=date(2025, 10, 6),\n        ),\n        Mascota(\n            nombre=\"Coco\",\n            especie=\"Gato\",\n            raza=\"Maine Coon\",\n            edad=3,\n            propietario_email=\"raul@example.com\",\n            propietario_telefono=\"600000007\",\n            zona=\"Norte\",\n            tipo_registro=\"desaparecida\",\n            color=\"gris\",\n            descripcion=None,\n            chip=None,\n            sexo=\"macho\",\n            peso=6.5,\n            tamano=\"mediano\",\n            fecha_registro=date(2025, 10, 7),\n        ),\n        Mascota(\n            nombre=\"encontrada\",\n            especie=\"Perro\",\n            raza=\"Pomerania\",\n            edad=1,\n            propietario_email=\"laura@example.com\",\n            propietario_telefono=\"600000008\",\n            zona=\"Centro\",\n            tipo_registro=\"encontrada\",\n            color=\"naranja\",\n            descripcion=None,\n            chip=None,\n            sexo=\"hembra\",\n            peso=2.8,\n            tamano=\"peque√±o\",\n            fecha_registro=date(2025, 10, 8),\n        ),\n    ]\n\n    try:\n        db.session.add_all(mascotas)\n        db.session.commit()\n    except IntegrityError as exc:\n        db.session.rollback()\n        print(\"ERROR UNIQUE al insertar mascotas:\", exc)\n        raise\n\n    fotos_info = [\n        (mascotas[0].id, \"cara\", \"static/fotos/frontal4.jpg\"),\n        (mascotas[2].id, \"frontal\", \"static/fotos/frontal1.jpg\"),\n        (mascotas[4].id, \"lateral_izquierdo\", \"static/fotos/lateral1.jpg\"),\n        (mascotas[6].id, \"cara\", \"static/fotos/lateral2.jpg\"),\n    ]\n\n    fotos = []\n    for mascota_id, tipo, ruta in fotos_info:\n        datos = _cargar_foto(ruta)\n        if not datos:\n            continue\n        fotos.append(\n            Foto(\n                mascota_id=mascota_id,\n                tipo_foto=tipo,\n                ruta=datos[\"ruta_rel\"],  # mantenemos el valor para compatibilidad\n                data=datos[\"data\"],\n                mime_type=datos[\"mime_type\"],\n                nombre_archivo=datos[\"nombre_archivo\"],\n                tamano_bytes=datos[\"tamano_bytes\"],\n            )\n        )\n\n    try:\n        db.session.add_all(fotos)\n        db.session.commit()\n    except IntegrityError as exc:\n        db.session.rollback()\n        print(\"ERROR UNIQUE al insertar fotos:\", exc)\n        raise\n\n    print(\"‚úÖ Base de datos inicializada con ejemplos (mascotas + fotos con binario).\")\n```\n\n### Notas clave\n\n1. **`_cargar_foto`**: busca el archivo dentro de `static/`, lo lee y determina MIME/nombre/tama√±o. Si falta el fichero, deja `data` en `None` (las vistas caer√°n a la ruta tradicional).\n2. **`ruta`**: seguimos guardando algo como `fotos/frontal4.jpg` para no romper c√≥digo existente que a√∫n mira rutas antiguas.\n3. **`db.drop_all()`** y `db.create_all()` se ejecutan igual, as√≠ puedes reinicializar PostgreSQL con estos datos de prueba siempre que lo necesites.\n4. **Ejecuci√≥n**: desde la ra√≠z del proyecto (con el venv activado y tus variables de entorno configuradas), corre `python init_db.py`.\n\nCon esto tendr√°s un set de mascotas y fotos listo para probar todos los flujos (incluido el endpoint `/foto/<id>`)."
        }
      ]
    },
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "funciona, siguiente paso ?"
        }
      ]
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": "text",
          "text": "¬°Genial que todo funcione! El siguiente paso l√≥gico es asegurarnos de que el resto de la app (sobre todo los procesos ‚Äúexternos‚Äù) tambi√©n puedan tomar las im√°genes directamente desde la base, sin depender del archivo f√≠sico. Eso te desbloquea dos cosas:\n\n1. **Que los correos / Facebook usen siempre la foto aunque el archivo en disco se borre.**\n2. **Poder exponer esas URLs hacia fuera (Instagram, etc.) sin preocuparte por archivos locales.**\n\nTe propongo este roadmap inmediato:\n\n---\n\n### 1. Refactorizar `_obtener_rutas_fotos`\nAhora mismo devuelve rutas absolutas en disco. Modif√≠calo para que pueda devolver:\n\n```python\n[\n    {\n        \"id\": foto.id,\n        \"ruta_abs\": <ruta si existe en disco>,\n        \"url\": url_for(\"main.ver_foto\", foto_id=foto.id),\n        \"data\": foto.data (opcional: solo si vas a usarlo ah√≠),\n        \"mime_type\": foto.mime_type,\n        \"nombre_archivo\": foto.nombre_archivo,\n    },\n    ...\n]\n```\n\nAs√≠ los consumidores (email, Facebook, comparadores) pueden elegir: descargar la foto v√≠a endpoint, o usar el binario directamente.\n\n---\n\n### 2. Actualizar `send_pet_email` y `utils/prueba_envio_facebook.py`\n\n- Haz que acepten, adem√°s de rutas, un array de objetos `{nombre_archivo, mime_type, data}`.\n- Si existe `data`, adj√∫ntala directamente (adjuntar base64/bytes es m√°s robusto).  \n- Si no hay `data`, pueden caer a descargar la URL `/foto/<id>` o usar el path antiguo.\n\nEsto elimina dependencias con la carpeta `static/fotos/` y asegura que aunque limpies esos archivos, los correos/post seguir√°n teniendo la imagen.\n\n---\n\n### 3. Refactor del comparador y utilidades OpenAI\n\nFunciones como `_serializar_foto`, `_extraer_ruta_absoluta_payload`, `image_to_data_url` y `comparar_fotos_todas` todav√≠a asumen que la imagen est√° en disco.\n\n- Cambia `image_to_data_url` para que pueda recibir un `Foto` o un blob directo.\n- Donde antes abr√≠as un `ruta_abs`, ahora puedes:\n  1. Usar `foto.data`.\n  2. O, si no hay datos, descargar desde `/foto/<id>` (sigue siendo local pero a trav√©s de la app).\n  \nAs√≠ incluso las mascotas ‚Äúviejas‚Äù sin binario seguir√°n funcionando.\n\n---\n\n### 4. (Opcional inmediato) Dejar de guardar archivos en disco\n\nUna vez todo lo anterior est√© listo (especialmente emails/comparadores), puedes:\n- Quitar `archivo.save(ruta_fs)` de `crear_mascota`.\n- Mantener `ruta` como valor simb√≥lico o dejarla en NULL.\n- Opcional: eliminar la carpeta `static/fotos` del `.gitignore` si ya no la utilizas.\n\n---\n\nCuando completes al menos los pasos 1 y 2, me dices y te ayudo con el refactor del comparador o con la generaci√≥n de enlaces p√∫blicos para Instagram/Facebook."
        }
      ]
    }
  ],
  "memory_state": {
    "summary": "Resumen actualizado:\n- Postgres instalado localmente; creados rol `mascotas_user` (password `Cmgh2304`) y BD `mascotas_db` con privilegios completos.\n- Variable `DATABASE_URL` configurada en Windows (`postgresql+psycopg2://mascotas_user:Cmgh2304@localhost:5432/mascotas_db`) y le√≠da en `Config` con fallback a SQLite.\n- `psycopg2-binary` instalado; app Flask ya arranca con PostgreSQL (Alembic log `Context impl PostgresqlImpl`, migraci√≥n inicial aplicada).",
    "last_index": 0
  }
}